<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Autocomplete from Firebase</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            background-color: #f8f8f8;
            color: #333;
        }

        /* Input styling */
        .group-input {
            width: 200px;
            height: 35px;
            padding: 5px;
            font-size: 16px;
            border: 1px solid #007bff;
            border-radius: 5px;
            background-color: #e0f2f7;
            color: #004085;
            box-sizing: border-box; /* Include padding/border in width */
        }

        /* Container for input and suggestions */
        .autocomplete-container {
            position: relative; /* Needed for absolute positioning of suggestions */
            display: inline-block; /* Make it fit content */
            width: 200px; /* Match input width */
        }

        /* Styles for the custom suggestion dropdown */
        .autocomplete-suggestions {
            position: absolute;
            top: 100%; /* Position below the input */
            left: 0;
            right: 0;
            border: 1px solid #ddd;
            border-top: none;
            max-height: 150px;
            overflow-y: auto;
            background-color: white;
            z-index: 1000; /* Ensure it's above other elements */
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-radius: 0 0 5px 5px;
            display: none; /* Hidden by default */
        }

        .autocomplete-suggestions div {
            padding: 8px 10px;
            cursor: pointer;
            background-color: white;
            border-bottom: 1px solid #eee;
        }

        .autocomplete-suggestions div:last-child {
            border-bottom: none;
        }

        .autocomplete-suggestions div:hover {
            background-color: #f0f0f0;
        }

        .autocomplete-suggestions div.selected { /* For keyboard navigation */
            background-color: #007bff;
            color: white;
        }

        .status-message {
            margin-top: 10px;
            font-size: 0.9em;
            color: gray;
        }
    </style>
</head>
<body>

    <label for="groupInput">Type a Group:</label><br>
    <div class="autocomplete-container">
        <input type="text" id="groupInput" class="group-input" placeholder="Loading groups...">
        <div id="suggestionsBox" class="autocomplete-suggestions">
            </div>
    </div>
    
    <div id="statusMessage" class="status-message">Initializing...</div>

    <script type="module">
        // Firebase SDK Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDQWZC6iA5zYKvTXsFl9TYLkZCTl5BzfwA",
            authDomain: "accounts-19d08.firebaseapp.com",
            projectId: "accounts-19d08",
            storageBucket: "accounts-19d08.appspot.com",
            messagingSenderId: "247308606105",
            appId: "1:247308606105:web:9bfc179368524244bf3608"
        };

        // Initialize Firebase services
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Get HTML Elements
        const groupInput = document.getElementById('groupInput');
        const suggestionsBox = document.getElementById('suggestionsBox');
        const statusMessage = document.getElementById('statusMessage');

        let allGroups = []; // Store all fetched groups here

        // Function to Fetch Data
        async function loadGroupsFromFirestore() {
            statusMessage.textContent = "Fetching groups from Firebase...";
            groupInput.disabled = true; // Disable input during loading
            try {
                const tranCol = collection(db, 'tran');
                const snapshot = await getDocs(tranCol);
                const uniqueGroups = new Set();
                snapshot.forEach(doc => {
                    const grp = (doc.data().grp || '').trim();
                    if (grp.length > 0) uniqueGroups.add(grp);
                });
                allGroups = [...uniqueGroups].sort(); // Store and sort them
                statusMessage.textContent = `Loaded ${allGroups.length} groups.`;
                statusMessage.style.color = 'green';
                groupInput.disabled = false; // Enable input
                groupInput.placeholder = "Type or select a group";
                return allGroups;
            } catch (error) {
                statusMessage.textContent = `Error: ${error.message}. Check network/Firebase rules.`;
                statusMessage.style.color = 'red';
                groupInput.placeholder = "Error loading data.";
                groupInput.disabled = true; // Keep disabled on error
                console.error("Firebase data load error:", error);
                return [];
            }
        }

        // --- Autocomplete Logic ---

        // Function to display suggestions
        function showSuggestions(query) {
            suggestionsBox.innerHTML = ''; // Clear previous suggestions
            suggestionsBox.style.display = 'none'; // Hide if no matches

            if (query.length === 0) {
                return; // Don't show suggestions for empty input
            }

            const filteredGroups = allGroups.filter(group =>
                group.toLowerCase().includes(query.toLowerCase())
            );

            if (filteredGroups.length === 0) {
                return; // No matches
            }

            // Create suggestion items
            filteredGroups.forEach(group => {
                const suggestionItem = document.createElement('div');
                suggestionItem.textContent = group;
                suggestionItem.addEventListener('click', () => {
                    groupInput.value = group; // Set input value on click
                    suggestionsBox.style.display = 'none'; // Hide suggestions
                });
                suggestionsBox.appendChild(suggestionItem);
            });

            suggestionsBox.style.display = 'block'; // Show suggestions
        }

        // Event listener for input changes (typing)
        groupInput.addEventListener('input', (event) => {
            showSuggestions(event.target.value);
        });

        // Hide suggestions when input loses focus (click outside)
        document.addEventListener('click', (event) => {
            if (!event.target.closest('.autocomplete-container')) {
                suggestionsBox.style.display = 'none';
            }
        });

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            statusMessage.textContent = 'Waiting for authentication status...';
            groupInput.disabled = true; // Ensure disabled until authenticated and loaded

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    statusMessage.textContent = `User ${user.email} detected.`;
                    await loadGroupsFromFirestore(); // Load data when authenticated
                    // After loading, initial suggestions if input already has value (unlikely on load)
                    if (groupInput.value) {
                         showSuggestions(groupInput.value);
                    }
                } else {
                    statusMessage.textContent = "Not logged in. Please log in via another Firebase app/tab.";
                    statusMessage.style.color = 'blue';
                    groupInput.placeholder = "Login required.";
                    groupInput.disabled = true;
                    suggestionsBox.style.display = 'none'; // Ensure hidden
                }
            });
        });
    </script>

</body>
</html>
