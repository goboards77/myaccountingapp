<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Index104</title>

    <style>
        body {
            font-family: "Courier New", Courier, monospace;
            margin: 0;
        }

        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            height: 40px;
            background-color: #343541;
            padding: 1px 1px 1px 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .hamburger {
            font-size: 20px;
            cursor: pointer;
            background: none;
            color: #FFFFFF;
            border: none;
            font-family: inherit;
        }

        .accordion-container {
            background-color: #2b1727;
            display: none;
            width: 100%;
            max-width: 300px;
            padding: 5px 20px 20px 20px;
            border-radius: 1px 1px 15px 15px;
        }

        .accordion {
            width: 100%;
            height: 50px;
            border-radius: 8px;
            text-align: left;
            font-family: inherit;
            font-size: 20px;
            color: #fff;
            background-color: #0c7508;
            cursor: pointer;
        }

        .accordion.active {
            background-color: #071b54;
        }

        .accordion:hover {
            background-color: #a67b05;
        }

        .panel {
            display: none;
            background-color: #3d3215;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin: 1px 1px 5px 40px;
            padding: 1px;
            width: 100%;
            max-width: 255px;
        }

        .panel.show {
            display: block;
        }

        .sub-button {
            background-color: #03dac5;
            border-radius: 6px;
            padding: 1px 1px 1px 1px;
            margin: 1px 0;
            cursor: pointer;
            font-size: 17px;
            width: 100%;
            height: 40px;
            text-align: left;
        }

        .sub-button:hover {
            background-color: #a67b05;
        }

        .action-button {
            background-color: #28a745;
            cursor: pointer;
            color: #fff;
            border-radius: 4px;
            font-size: 16px;
            margin-top: 20px;
            height: 40px;
            width: 60%;
            float: right;
            font-family: inherit;
        }

        .action-button:hover {
            background-color: #a67b05;
        }

        input {
            margin-top: 5px;
            padding: 8px;
            width: 100%;
            box-sizing: border-box;
            border-radius: 5px;
            height: 40px;
            border: 2px solid #ccc;
            font-size: 16px;
            font-family: inherit;
        }

        label {
            padding: 8px;
            font-weight: bold;
        }

        .cash-label {
            color: #fff;
            font-weight: bold;
            margin: 1px 20px;
        }

        .widget-area {
            background: #fff;
            border-radius: 8px;
            padding: 10px;
            margin: 2px;
            max-width: 330px;
            display: none;
            border: 2px solid #ddd;
        }

        table {
            border-collapse: collapse;
            width: 400px;
            margin-top: 15px;
            table-layout: fixed;
        }

        table th, table td {
            border: 2px solid #ccc;
            padding: 8px;
        }

        table th {
            background-color: #28a745;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .edit-table {
            border-collapse: collapse;
            width: 400px;
            margin-top: 15px;
            table-layout: fixed;
        }

        /* Main MenuButton Colors */
        .groups-accordion {
            background-color: #dd42f5;
        }

        .ledgers-accordion {
            background-color: #d10daa;
        }

        .products-accordion {
            background-color: #91066c;
        }

        .tran-accordion {
            background-color: #138005;
        }

        .view-accordion {
            background-color: #9748d9;
        }

        .export-accordion {
            background-color: #069178;
        }

        .logout-accordion {
            background-color: #94093c;
        }

        .del-action-button {
            background-color: #ba0612;
        }
    </style>
</head>

<body>

<div class="topbar">
    <button class="hamburger" id="hamburgerBtn">‚ò∞ App</button>
    <label class="cash-label" id="cashLabel">Cash: ‚Çπ0</label>
</div>


<!-- Login Form -->
<div id="loginContainer" style="display: none;">
    <h2>Login</h2>
    <input id="loginEmail" placeholder="Email" type="email">
    <input id="loginPassword" placeholder="Password" type="password">
    <button class="action-button" onclick="login()">Login</button>
    <div class="error" id="loginError"></div>
    <a href="#" onclick="event.preventDefault(); showRegister();">Don‚Äôt have an account? Register</a>
</div>


<!-- Register Form -->
<div id="registerContainer" style="display:none;">
    <h2>Register</h2>
    <input id="registerEmail" placeholder="Email" type="email">
    <input id="registerPassword" placeholder="Password" type="password">
    <button class="action-button" onclick="register()">Register</button>
    <div class="error" id="registerError"></div>
    <div class="small-link"><a href="#" onclick="event.preventDefault(); showLogin();">Already have an account? Login</a></div>
</div>


<div id="widget-area">

    <!-- All Sub-Menu Buttons -------------------------------------------------------------------->


    <div class="accordion-container" id="accordionMenu">

        <!-- Group Sub-Button -------------------------------------------------------------------->
        <button class="accordion groups-accordion">üë• Groups</button>
        <div class="panel">
            <button class="sub-button" widgets="GroupWidgets">üë• New Group</button>
        </div>


        <!-- Ledger  Sub-Button ------------------------------------------------------------------>
        <button class="accordion ledgers-accordion">üìñ Ledgers</button>
        <div class="panel">
            <button class="sub-button" widgets="LedgerWidgets">üìñ New Ledger</button>
            <button class="sub-button" widgets="UpdateLedgerWidgets">‚úèÔ∏è Update Ledger</button>
        </div>


        <!-- Product  Sub-Button ----------------------------------------------------------------->
        <button class="accordion products-accordion">üõçÔ∏è Products</button>
        <div class="panel">
            <button class="sub-button" widgets="ProductWidgets">üõçÔ∏è New Product</button>
            <button class="sub-button" widgets="UpdateProductWidgets">‚úèÔ∏è Update Product</button>
        </div>


        <!-- transaction Sub-Button -------------------------------------------------------------->
        <button class="accordion tran-accordion">‚ûï Transactions</button>
        <div class="panel">
            <button class="sub-button" widgets="Transaction">üõí New Transaction</button>
            <button class="sub-button" widgets="UpdateTransaction">‚úèÔ∏è Update Transaction</button>
            <button class="sub-button" widgets="DeleteTransaction">üóëÔ∏è Delete Transaction</button>
        </div>


        <!-- View Sub-Button --------------------------------------------------------------------->
        <button class="accordion view-accordion">üëÅÔ∏è View</button>
        <div class="panel">
            <button class="sub-button" id="vdbbtn" widgets="vdb">üìñ Daybook</button>
            <button class="sub-button" id="vglbtn" widgets="vgl">üë• Groups & üìñ Ledgers</button>
            <button class="sub-button" id="vprodbtn" widgets="vprod">üõçÔ∏è Products</button>
            <button class="sub-button" id="vrecbtn" widgets="vrec">üí∞ Receivables</button>
            <button class="sub-button" id="vpaybtn" widgets="vpay">üíµ Payables</button>
            <button class="sub-button" id="profitbtn" widgets="vprofit">üìà Profit & üìâ Loss</button>
            <button class="sub-button" id="khabtn" widgets="vkha">üìí Khatavahi</button>
        </div>


        <!-- Export Sub-Button ------------------------------------------------------------------->
        <button class="accordion export-accordion">‚úàÔ∏è Export</button>
        <div class="panel">
            <button class="sub-button" widgets="export">üì§ Export CSV PDF</button>
        </div>


        <!-- Logout Sub-Button ------------------------------------------------------------------->
        <button class="accordion logout-accordion">üîíLogout</button>
        <div class="panel">
            <button class="sub-button" id="logoutbtn" onclick="logout()" widgets="logout">‚Ü©Ô∏è Logout</button>
        </div>

    </div>


    <!-- Widgets --------------------------------------------------------------------------------->


    <!-- Add Group -->
    <div class="widget-area" id="GroupWidgets" style="height: 150px; width: 400px;">
        <br>
        <label>Group Name:</label>
        <input autocomplete="off" id="GroupName" list="grp_list" placeholder="Group Name" type="text"><br>
        <button class="action-button" id="SaveGroupButton">üíæ Save Group</button>
    </div>


    <!-- Add Ledger -->
    <div class="widget-area" id="LedgerWidgets" style="height: 400px; width: 400px;">
        <br>
        <label>Select Ledger Group:</label>
        <input autocomplete="off" id="LedgerGroup" list="grp_list" placeholder="Ledger Group" type="text"><br>
        <br>
        <label>Enter Ledger Name:</label>
        <input autocomplete="off" id="LedgerName" list="allnames_list" placeholder="Ledger Name" type="text"><br>
        <br>
        <label>Enter Op Bal Jama Jo Hoy Toh:</label><input autocomplete="off" id="OBJ" placeholder="Op Bal Jama" type="number"><br>
        <br>
        <label>Enter Op Bal Khate Jo Hoy Toh:</label><input autocomplete="off" id="OBK" placeholder="Op Bal Khate" type="number"><br>
        <button class="action-button" id="SaveLedgerButton">üíæ Save Ledger</button>
    </div>


    <!-- Add Product -->
    <div class="widget-area" id="ProductWidgets" style="height: 300px; width: 400px;">
        <br>
        <label>Select Product Group:</label>
        <input autocomplete="off" id="ProductGroup" list="sp_list" placeholder="Product Group" type="text"><br>
        <br>
        <label>Enter Product Name:</label><input autocomplete="off" id="ProductName" placeholder="New Product Name" type="text"><br>
        <br>
        <label>Enter Op Stock Jo Hoy Toh:</label>
        <input autocomplete="off" id="ProductOPSTK" placeholder="Product Op Stock" type="number"><br>
        <button class="action-button" id="SaveProductButton">üíæ Save Product</button>
        <br><br>
    </div>


    <!-- Update Ledger -->
    <div class="widget-area" id="UpdateLedgerWidgets" style="height: 350px; width: 300px;">
        <input autocomplete="off" id="OldLedgerGroup" list="grp_list" placeholder="Old Ledger Group" type="text"><br>
        <input autocomplete="off" id="OldLedgerName" list="allnames_list" placeholder="Old Ledger Name" type="text"><br><br><br>
        <input autocomplete="off" id="UpdatedLedgerGroup" list="grp_list" placeholder="Updated Ledger Group" type="text"><br>
        <input autocomplete="off" id="UpdatedLedgerName" placeholder="Updated Ledger Name" type="text"><br>
        <input autocomplete="off" id="UpdatedOBJ" placeholder="Updated Op Bal Jama" type="number"><br>
        <input autocomplete="off" id="UpdatedOBK" placeholder="Updated Op Bal Khate" type="number"><br>
        <button class="action-button" id="UpdateLedgerButton">‚úèÔ∏è Update Ledger</button>
    </div>


    <!-- Update product -->
    <div class="widget-area" id="UpdateProductWidgets" style="height: 270px; width: 300px;">
        <input autocomplete="off" id="OldProductGroup" list="sp_list" placeholder="Select Product Group" type="text"><br>
        <input autocomplete="off" id="OldProductName" placeholder="Old Product Name" type="text"><br>
        <input autocomplete="off" id="NewProductGroup" list="sp_list" placeholder="Updated Product Name" type="text"><br>
        <input autocomplete="off" id="NewProductName" placeholder="New Product Name" type="text"><br>
        <input autocomplete="off" id="NewOpStock" placeholder="Product Op Stock" type="number"><br>
        <button class="action-button" id="UpdateProductButton">‚úèÔ∏è Update Product</button>
    </div>


    <!-- Add Transaction -->
    <div class="widget-area" id="Transaction" style="height: 300px; width: 300px;">
        <input autocomplete="off" id="AddTranTtype" list="ttype_list" placeholder="Transaction Type" type="text"><br>
        <input autocomplete="off" id="AddTranDate" type="date"><br>
        <input autocomplete="off" id="AddTranFparty" list="" placeholder="" type="text"><br>
        <input autocomplete="off" id="AddTranTparty" list="" placeholder="" type="text"><br>
        <input autocomplete="off" id="AddTranAmount" placeholder="" type="number"><br>
        <input autocomplete="off" id="AddTranNar" placeholder="Naration" type="text"><br>
        <button class="action-button" id="AddTranSaveButton">üíæ Save Transaction</button>
    </div>


    <!-- Update Transaction -->
    <div class="widget-area" id="UpdateTransaction" style="height: 410px; width: 300px;">
        <input autocomplete="off" id="UpdateId" placeholder="Id To Update" type="number"><br>
        <button class="action-button" id="UpdateSearchButton">üîç Search & Insert</button>
        <br><br><br><br>
        <input autocomplete="off" id="UpdateTranTtype" placeholder="Transaction Type" readonly type="text"><br>
        <input autocomplete="off" id="UpdateTranDate" type="date"><br>
        <input autocomplete="off" id="UpdateTranFparty" list="" placeholder="" type="text"><br>
        <input autocomplete="off" id="UpdateTranTparty" list="" placeholder="" type="text"><br>
        <input autocomplete="off" id="UpdateTranAmount" placeholder="" type="number"><br>
        <input autocomplete="off" id="UpdateTranNar" placeholder="Naration" type="text"><br>
        <button class="action-button" id="UpdateTranButton">‚úèÔ∏è Update Transaction</button>
    </div>


    <!-- Delete Transaction -->
    <div class="widget-area" id="DeleteTransaction" style="height: 130px; width: 300px;">
        <input autocomplete="off" id="DeleteId" placeholder="Id To Delete" type="number"><br>
        <button class="action-button del-action-button" id="DeleteTranButton">üóëÔ∏è Delete Transaction</button>
        <br>
        <div id="delete-error" style="color: red; margin-top: 5px;"></div>
    </div>


    <!-- Views ----------------------------------------------------------------------------------->


    <!-- Daybook --------------->
    <div class="widget-area" id="vdb" style="height: 160px; width: 300px;">
        <input autocomplete="off" id="typeField" list="ttype_list" placeholder="Filter By Transaction Type" type="text"><br>
        <input autocomplete="off" id="apartyfield" list="allnames_list" placeholder="Filter By Party / Product" type="text"><br>
        <input autocomplete="off" id="amountField" placeholder="Filter By Amount" type="number"><br>
        <button class="action-button" id="filterBtn">‚è≥ Filter</button>
        <br><br>
        <div id="daybookTable"></div>
    </div>


    <!-- Groups & Ledgers --------------->
    <div class="widget-area" id="vgl" style="width: 400px;">
        <Label>View Groups Ledgers</Label>
        <div id="viewGroupsLadgersTable"></div>
    </div>


    <!-- Product --------------->
    <div class="widget-area" id="vprod" style="width: 400px;">
        <Label>View Products</Label>
        <div id="productsTable"></div>
    </div>


    <!-- Receivable --------------->
    <div class="widget-area" id="vrec" style="width: 400px;">
        <Label>View Receivables</Label>
        <div id="viewRecTable"></div>
    </div>


    <!-- Payable --------------->
    <div class="widget-area" id="vpay" style="width: 400px;">
        <Label>View Payables</Label>
        <div id="viewPayTable"></div>
    </div>


    <!-- Profit & Loss --------------->
    <div class="widget-area" id="vprofit" style="height: 180px; width: 300px;">
        <input autocomplete="off" id="fromDate" placeholder="Start Date" type="date"><br>
        <input autocomplete="off" id="toDate" placeholder="End Date" type="date"><br>
        <input autocomplete="off" id="closingStock" placeholder="Cosing Stock" type="number"><br>
        <button class="action-button" id="calculateProfitbtn">Calculate Profit & Loss</button>
        <br><br>
        <div id="plTable"></div>
    </div>


    <!-- Khatavahi --------------->
    <div class="widget-area" id="vkha" style="height: 180px; width: 300px;">
        <input autocomplete="off" id="kfromDate" placeholder="Start Date" type="date"><br>
        <input autocomplete="off" id="ktoDate" placeholder="End Date" type="date"><br>
        <input autocomplete="off" id="kparty" list="allnames_list" placeholder="Party Product Expense" type="text"><br>
        <button class="action-button" id="calkhabtn">‚è≥ Show Transactions</button>
        <br><br>
        <div id="khaTable"></div>
    </div>


    <!-- Export -->
    <div class="widget-area" id="export" style="height: 440px; width: 300px;">
        <h2>Export - PDF Export</h2>
        <label>Start Date:</label>
        <input autocomplete="off" id="exportStartDate" placeholder="Start Date" type="date"><br><br>
        <label>End Date:</label>
        <input autocomplete="off" id="exportEndDate" placeholder="End Date" type="date"><br><br>
        <label>Party:</label>
        <input autocomplete="off" id="exportParty" list="allnames_list" placeholder="Party" type="text"><br><br>
        <label>Transaction Type:</label>
        <input autocomplete="off" id="exportTType" list="ttype_list" placeholder="Tran Type" type="text"><br><br>
        <button class="action-button" id="exportBtn">‚úàÔ∏è Export Data</button>
        <div class="error" id="exportError"></div>
    </div>


    <!-- Global Errors Space ----->
    <div id="Add-transaction-errors"></div>
    <div id="Update-transaction-errors"></div>

</div>


<!-- Lists --------------------------------------------------------------------------------------->
<datalist id="grp_list"></datalist>
<datalist id="sp_list"></datalist>
<datalist id="allnames_list"></datalist>
<datalist id="ttype_list"></datalist>
<datalist id="crdb_list"></datalist>
<datalist id="sproduct_list"></datalist>
<datalist id="pproduct_list"></datalist>
<datalist id="crdbcsbkang_list"></datalist>
<datalist id="crdbcsbkangexp_list"></datalist>


<!-- Firebase ------------------------------------------------------------------------------------>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
<script type="module">
    import {initializeApp} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";

    import {
        getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    import {
        getFirestore, collection, getDocs, updateDoc, deleteDoc, addDoc, query, where, orderBy, limit, doc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDQWZC6iA5zYKvTXsFl9TYLkZCTl5BzfwA",
        authDomain: "accounts-19d08.firebaseapp.com",
        projectId: "accounts-19d08",
        storageBucket: "accounts-19d08.appspot.com",
        messagingSenderId: "247308606105",
        appId: "1:247308606105:web:9bfc179368524244bf3608"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore();
    window.showLogin = function () {
        document.getElementById("loginContainer").style.display = "block";
        document.getElementById("registerContainer").style.display = "none";
    };
    window.showRegister = function () {
        document.getElementById("loginContainer").style.display = "none";
        document.getElementById("registerContainer").style.display = "block";
    };
    window.login = async function () {
        const email = document.getElementById("loginEmail").value;
        const password = document.getElementById("loginPassword").value;
        try {
            await signInWithEmailAndPassword(auth, email, password);
        } catch (error) {
            document.getElementById("loginError").textContent = error.message;
        }
    };
    window.register = async function () {
        const email = document.getElementById("registerEmail").value;
        const password = document.getElementById("registerPassword").value;
        try {
            await createUserWithEmailAndPassword(auth, email, password);
        } catch (error) {
            document.getElementById("registerError").textContent = error.message;
        }
    };
    window.logout = async function () {
        await signOut(auth);
        document.getElementById("widget-area").style.display = "none";
        document.getElementById("loginContainer").style.display = "block";
        document.getElementById("registerContainer").style.display = "none";
    };
    document.addEventListener("DOMContentLoaded", () => {
        const hamburgerBtn = document.getElementById("hamburgerBtn");
        const accordionMenu = document.getElementById("accordionMenu");
        const accordions = document.querySelectorAll(".accordion");
        const panels = document.querySelectorAll(".panel");
        const subButtons = document.querySelectorAll(".sub-button");
        const contentArea = document.getElementById("widget-Area");

        hamburgerBtn.addEventListener("click", () => {
            accordionMenu.style.display =
                accordionMenu.style.display === "block" ? "none" : "block";
            document.querySelectorAll(".widget-area").forEach(div => {
                div.style.display = "none";
            });
        });

        accordions.forEach((btn) => {
            btn.addEventListener("click", () => {
                const panel = btn.nextElementSibling;
                const isActive = btn.classList.contains("active");

                closeAll();
                if (!isActive) {
                    btn.classList.add("active");
                    panel.classList.add("show");
                }
            });
        });
        subButtons.forEach((btn) => {
            btn.addEventListener("click", (e) => {
                e.stopPropagation();

                accordionMenu.style.display = "none";

                document.querySelectorAll(".widget-area").forEach(div => {
                    div.style.display = "none";
                });

                const widgetId = btn.getAttribute("widgets");
                if (widgetId) {
                    const widgetDiv = document.getElementById(widgetId);
                    if (widgetDiv) {
                        widgetDiv.style.display = "block";
                    }
                }
                closeAll();
            });
        });

        document.getElementById("loginContainer").style.display = "block";
        document.getElementById("registerContainer").style.display = "none";

        // üëá Firebase auth state change listener
        onAuthStateChanged(auth, (user) => {
            console.log("üîÅ Auth state changed:", user);

            const loginDiv = document.getElementById("loginContainer");
            const registerDiv = document.getElementById("registerContainer");
            const logoutBtn = document.getElementById("logoutbtn");

            if (user) {
                if (loginDiv) loginDiv.style.display = "none";
                if (registerDiv) registerDiv.style.display = "none";
                if (hamburgerBtn) hamburgerBtn.style.display = "block";

                document.querySelectorAll(".widget-area").forEach(div => {
                    div.style.display = "none";
                });
                document.querySelectorAll("input[type='text']").forEach(input => {
                    input.addEventListener("input", (e) => {
                        const cursorPos = input.selectionStart;
                        input.value = capitalizeWords(input.value);
                        input.setSelectionRange(cursorPos, cursorPos);
                    });
                });
                viewGroupsAndAccounts();
                viewProducts();
                viewReceivables();
                viewPayables();
                loadDropdownData();
                profit_loss()
                viewDaybook()
            } else {
                if (loginDiv) loginDiv.style.display = "block";
                if (registerDiv) registerDiv.style.display = "none";
                if (logoutBtn) logoutBtn.style.display = "none";
                if (hamburgerBtn) hamburgerBtn.style.display = "none";
                if (accordionMenu) accordionMenu.style.display = "none";

                document.querySelectorAll(".widget-area").forEach(div => {
                    div.style.display = "none";
                });
            }
        });
        const filterBtn = document.getElementById("filterBtn");
        if (filterBtn) {
            filterBtn.addEventListener("click", () => {
                viewDaybook(true);
            });
        }
        viewDaybook(false);
    });
    document.addEventListener("DOMContentLoaded", () => {
        setupTransactionForm("Add");
        setupTransactionForm("Update");
    });


    // Close All Widgets //////////////////////////////////////////////////////////////////////////
    function closeAll() {
        document.querySelectorAll(".accordion").forEach(btn => btn.classList.remove("active"));
        document.querySelectorAll(".panel").forEach(panel => panel.classList.remove("show"));
    }

    // Clear Field Values /////////////////////////////////////////////////////////////////////////
    function clearInputsById(ids) {
        ids.forEach(id => {
            const el = document.getElementById(id);
            if (el && 'value' in el) {
                el.value = "";
            }
        });
    }


    // Date Conversion ////////////////////////////////////////////////////////////////////////////
    function formatDate(d) {
        if (!d) return "";
        const parts = d.split("-");
        if (parts.length === 3) {
            return `${parts[2]}-${parts[1]}-${parts[0]}`;
        }
        return d;
    }


    // Converts yyyy-mm-dd -> dd-mm-yyyy //////////////////////////////////////////////////////////
    function toYMD(d) {
        return d;
    }


    // To Capitalize Words ////////////////////////////////////////////////////////////////////////
    function capitalizeWords(str) {
        return str.replace(/\b\w/g, c => c.toUpperCase());
    }

    // Cash Label /////////////////////////////////////////////////////////////////////////////////
    async function updateCashLabel() {
        const tranCol = collection(db, "tran");
        const snapshot = await getDocs(tranCol);

        let inflow = 0;   // tparty = 'Cash On Hand'
        let outflow = 0;  // fparty = 'Cash On Hand'

        snapshot.forEach(doc => {
            const data = doc.data();
            if (data.tparty === "Cash On Hand") {
                inflow += Number(data.amt || 0);
            }
            if (data.fparty === "Cash On Hand") {
                outflow += Number(data.amt || 0);
            }
        });

        const balance = inflow - outflow;
        document.getElementById("cashLabel").textContent = `Cash: ‚Çπ${balance.toFixed(0)}`;
    }


    // All Dropdown Lists /////////////////////////////////////////////////////////////////////////
    async function loadDropdownData() {
        const tranCol = collection(db, "tran");
        const snapshot = await getDocs(tranCol);

        const grpSet = new Set();           // All groups except Sales & Purchase
        const spSet = new Set();            // Only Sales and Purchase
        const nameSet = new Set();          // All names where grp ‚â† Sales/Purchase
        const ttypeSet = new Set();
        const sproductSet = new Set();
        const pproductSet = new Set();
        const crdbSet = new Set();
        const crdbcsbkangSet = new Set();
        const crdbcsbkangexpSet = new Set();

        // Groups defining your special lists
        const crdbGroups = ["Creditors", "Debitors"];
        const crdbcsbkangGroups = ["Creditors", "Debitors", "Cash", "Bank", "Angadiya"];
        const crdbcsbkangexpGroups = [...crdbcsbkangGroups, "Expense"];

        snapshot.forEach(doc => {
            const data = doc.data();
            const grp = (data.grp || "").trim();
            const name = (data.name || "").trim();

            if (grp.length === 0) return;

            // Transaction types
            if (["Sales", "Purchase", "Receipt", "Payment"].includes(grp)) {
                ttypeSet.add(grp);
            }

            if (["Sales", "Purchase"].includes(grp)) {
                spSet.add(grp);
            } else if (!["Receipt", "Payment"].includes(grp)) {
                grpSet.add(grp);
                if (name.length > 0) {
                    nameSet.add(name);
                }
            }

            // Sales products
            if (grp === "Sales" && name.length > 0) {
                sproductSet.add(name);
            }

            // Purchase products
            if (grp === "Purchase" && name.length > 0) {
                pproductSet.add(name);
            }

            // crdb list
            if (crdbGroups.includes(grp) && name.length > 0) {
                crdbSet.add(name);
            }

            // crdbcsbkang list
            if (crdbcsbkangGroups.includes(grp) && name.length > 0) {
                crdbcsbkangSet.add(name);
            }

            // crdbcsbkangexp list
            if (crdbcsbkangexpGroups.includes(grp) && name.length > 0) {
                crdbcsbkangexpSet.add(name);
            }
        });

        // Convert Sets to sorted arrays
        const grp_list = [...grpSet].sort((a, b) => a.localeCompare(b));
        const sp_list = [...spSet].sort((a, b) => a.localeCompare(b));
        const allnames_list = [...nameSet].sort((a, b) => a.localeCompare(b));
        const ttype_list = [...ttypeSet].sort((a, b) => a.localeCompare(b));

        const sproduct_list = [...sproductSet].sort((a, b) => a.localeCompare(b));
        const pproduct_list = [...pproductSet].sort((a, b) => a.localeCompare(b));
        const crdb_list = [...crdbSet].sort((a, b) => a.localeCompare(b));
        const crdbcsbkang_list = [...crdbcsbkangSet].sort((a, b) => a.localeCompare(b));
        const crdbcsbkangexp_list = [...crdbcsbkangexpSet].sort((a, b) => a.localeCompare(b));

        // ‚úÖ Populate all datalists
        populateDatalist("grp_list", grp_list);
        populateDatalist("sp_list", sp_list);
        populateDatalist("allnames_list", allnames_list);
        populateDatalist("ttype_list", ttype_list);
        populateDatalist("sproduct_list", sproduct_list);
        populateDatalist("pproduct_list", pproduct_list);
        populateDatalist("crdb_list", crdb_list);
        populateDatalist("crdbcsbkang_list", crdbcsbkang_list);
        populateDatalist("crdbcsbkangexp_list", crdbcsbkangexp_list);
    }

    async function populateDatalist(datalistId, items) {
        const datalist = document.getElementById(datalistId);
        if (!datalist) {
            showError("‚ö†Ô∏è Datalist element not found:", datalistId);
            return;
        }

        datalist.innerHTML = "";
        items.forEach(item => {
            const option = document.createElement("option");
            option.value = item;
            datalist.appendChild(option);
        });
    }


    // New Names Added To Update Datalist /////////////////////////////////////////////////////////
    function addToDatalist(datalistId, value) {
        const dataList = document.getElementById(datalistId);
        if (!dataList) return;

        const option = document.createElement("option");
        option.value = value;
        dataList.appendChild(option);
    }


    // List Selector //////////////////////////////////////////////////////////////////////////////
    function setupTransactionForm(prefix) {
        const dateInput = document.getElementById(prefix + "TranDate");
        const ttypeInput = document.getElementById(prefix + "TranTtype");
        const fpartyInput = document.getElementById(prefix + "TranFparty");
        const tpartyInput = document.getElementById(prefix + "TranTparty");
        const amountInput = document.getElementById(prefix + "TranAmount");
        const narInput = document.getElementById(prefix + "TranNar");
        const transactionErrors = document.getElementById(prefix + "-transaction-errors");

        document.getElementById("UpdateTranTtype")
            .dispatchEvent(new Event("change"));

        function applyTransactionTypeSettings(ttype, clearFields = false) {

            if (ttype === "Sales") {
                fpartyInput.setAttribute("list", "sproduct_list");
                tpartyInput.setAttribute("list", "crdb_list");
                fpartyInput.placeholder = "Sales Party";
                tpartyInput.placeholder = "Sales Product";
                amountInput.placeholder = "Sales Amount";

            } else if (ttype === "Purchase") {
                fpartyInput.setAttribute("list", "crdb_list");
                tpartyInput.setAttribute("list", "pproduct_list");
                fpartyInput.placeholder = "Purchase Party";
                tpartyInput.placeholder = "Purchase Product";
                amountInput.placeholder = "Purchase Amount";

            } else if (["Receipt", "Payment"].includes(ttype)) {
                fpartyInput.setAttribute("list", "crdbcsbkang_list");
                tpartyInput.setAttribute("list", "crdbcsbkangexp_list");
                fpartyInput.placeholder = "Received From";
                tpartyInput.placeholder = "Paid To";
                amountInput.placeholder = "Amount";
            } else {
                fpartyInput.removeAttribute("list");
                tpartyInput.removeAttribute("list");
            }
        }

        ttypeInput.addEventListener("change", () => {
            const ttype = ttypeInput.value.trim();
            applyTransactionTypeSettings(ttype, true);
        });

        setupValidation(fpartyInput, "Party");
        setupValidation(tpartyInput, "Product / Party");

        function setupValidation(input, fieldLabel) {
            input.addEventListener("blur", () => {
                const datalistId = input.getAttribute("list");
                if (!datalistId) {
                    console.warn(`${fieldLabel}: No list assigned`);
                    return;
                }

                const datalist = document.getElementById(datalistId);
                if (!datalist) {
                    return;
                }

                const value = input.value.trim();
                const options = Array.from(datalist.options).map(opt => opt.value.toLowerCase());

                if (value && !options.includes(value.toLowerCase())) {
                    showError(`${fieldLabel}: "${value}" is not valid. Please choose from list.`);
                    input.setCustomValidity("Invalid choice.");
                } else {
                    clearError();
                    input.setCustomValidity("");
                }
            });
        }

        function showError(message) {
            transactionErrors.textContent = message;
            transactionErrors.style.display = "block";
        }

        function clearError() {
            transactionErrors.textContent = "";
            transactionErrors.style.display = "none";
        }

        const initialType = ttypeInput.value.trim();
        if (initialType) {
            applyTransactionTypeSettings(initialType, false);
        }
    }


    // Groups Ledgers Products/////////////////////////////////////////////////////////////////////


    // Save Group /////////////////////////////////////////////////////////////////////////////////
    async function saveGroup() {
        const inputField = document.getElementById("GroupName");
        const groupName = inputField.value.trim();

        if (!groupName) {
            alert("Please enter a Group Name!");
            inputField.value = "";
            return;
        }

        const tranCol = collection(db, "tran");
        const q = query(tranCol, where("grp", "==", groupName));
        const querySnapshot = await getDocs(q);

        if (!querySnapshot.empty) {
            alert("Group name already exists!");
            return;
        }

        const newDoc = {grp: groupName};
        await addDoc(tranCol, newDoc);
        const snapshot = await getDocs(tranCol);

        addToDatalist("grp_list", groupName);
        viewGroupsAndAccounts()
        inputField.value = "";
    }

    document.getElementById("SaveGroupButton").addEventListener("click", saveGroup);


    // Save Ledger Account ////////////////////////////////////////////////////////////////////////
    async function saveLedger() {
        const group = capitalizeWords(document.getElementById("LedgerGroup").value.trim());
        const newacname = capitalizeWords(document.getElementById("LedgerName").value.trim());
        const opbaljama = document.getElementById("OBJ").value.trim();
        const opbalkhate = document.getElementById("OBK").value.trim();

        if (!group || !newacname) {
            return alert("Please select Group and enter Account Name.");
        }

        if (opbaljama !== "" && opbalkhate !== "") {
            return alert("Please enter value in only one of Old Bal Jama or Old Bal Khate, not both.");
        }

        const grpList = document.getElementById("grp_list");
        const isValidGroup = Array.from(grpList.options).some(opt => opt.value === group);
        if (!isValidGroup) {
            return alert("Ledger Group Is Not Valid. Add This Group First");
        }

        const q = query(
            collection(db, "tran"),
            where("name", "==", newacname)
        );
        const snapshot = await getDocs(q);
        if (!snapshot.empty) {
            return alert("Ledger already exists in this group.");
        }

        const tranCol = collection(db, "tran");
        const allDocs = await getDocs(tranCol);

        let maxId = 0;
        allDocs.forEach(doc => {
            const data = doc.data();
            const idNum = Number(data.id);
            if (!isNaN(idNum) && idNum > maxId) {
                maxId = idNum;
            }
        });

        const newId = maxId + 1;

        let fparty = "", tparty = "", amt = 0;  // default 0

        if (opbaljama !== "") {
            fparty = newacname;
            amt = Number(opbaljama);
        } else if (opbalkhate !== "") {
            tparty = newacname;
            amt = Number(opbalkhate);
        } else {
            fparty = newacname;
            amt = 0;
        }

        await addDoc(tranCol, {
            id: newId,
            date: new Date().toISOString().split("T")[0],
            ttype: "Op Bal",
            fparty,
            tparty,
            amt,
            grp: group,
            name: newacname
        });

        addToDatalist("allnames_list", newacname);
        viewGroupsAndAccounts()
        clearInputsById(["LedgerGroup", "LedgerName", "OBJ", "OBK"]);
    }

    document.getElementById("SaveLedgerButton").addEventListener("click", saveLedger);


    // Update Ledger //////////////////////////////////////////////////////////////////////////////
    async function update_ledger() {
        const usoledgrp = capitalizeWords(document.getElementById("OldLedgerGroup")?.value.trim() || "");
        const oledn = capitalizeWords(document.getElementById("OldLedgerName")?.value.trim() || "");
        const usledgrp = capitalizeWords(document.getElementById("UpdatedLedgerGroup")?.value.trim() || "");
        const uledn = capitalizeWords(document.getElementById("UpdatedLedgerName")?.value.trim() || "");
        const unobj = document.getElementById("UpdatedOBJ")?.value.trim() || "";
        const unobk = document.getElementById("UpdatedOBK")?.value.trim() || "";

        const oldLedgerName = oledn;
        const newLedgerName = uledn;

        if (!usoledgrp || !oldLedgerName || !usledgrp || !newLedgerName) {
            alert("Please enter both old and updated group and ledger names.");
            return;
        }

        const grpList = document.getElementById("grp_list");
        const isValidGroup = Array.from(grpList.options).some(opt => opt.value === usledgrp);
        if (!isValidGroup) {
            alert("New Ledger Group Is Not Valid. Add This Group First");
            return;
        }

        const existsQuery = query(
            collection(db, "tran"),
            where("name", "==", newLedgerName)
        );
        const existsSnap = await getDocs(existsQuery);
        if (!existsSnap.empty) {
            alert("Ledger with this name already exists");
            return;
        }

        try {
            const tranCol = collection(db, "tran");
            const snapshot = await getDocs(tranCol);

            if (snapshot.empty) {
                alert("No documents found in the tran collection.");
                return;
            }

            const updatePromises = [];

            snapshot.forEach(docSnap => {
                const data = docSnap.data();
                const docRef = doc(db, "tran", docSnap.id);

                const matchOpBal =
                    data.grp === usoledgrp &&
                    data.name === oldLedgerName &&
                    data.ttype === "Op Bal";

                const matchOther = ["fparty", "tparty", "name"].some(field => data[field] === oldLedgerName);

                const updatedData = {};
                let needsUpdate = false;

                if (matchOpBal) {
                    // ‚úÖ Update Op Bal entry
                    updatedData.grp = usledgrp;
                    updatedData.name = newLedgerName;

                    if (unobj !== "") {
                        updatedData.fparty = newLedgerName;
                        updatedData.tparty = "";
                        updatedData.amt = Number(unobj);
                    } else if (unobk !== "") {
                        updatedData.fparty = "";
                        updatedData.tparty = newLedgerName;
                        updatedData.amt = Number(unobk);
                    } else {
                        updatedData.fparty = newLedgerName;
                        updatedData.tparty = "";
                        updatedData.amt = 0;
                    }

                    needsUpdate = true;
                } else if (matchOther && data.grp !== usoledgrp) {
                    ["fparty", "tparty", "name"].forEach(field => {
                        if (data[field] === oldLedgerName) {
                            updatedData[field] = newLedgerName;
                            needsUpdate = true;
                        }
                    });
                }

                if (needsUpdate) {
                    updatePromises.push(updateDoc(docRef, updatedData));
                }
            });

            await Promise.all(updatePromises);
            addToDatalist("allnames_list", uledn);
            viewGroupsAndAccounts()
            clearInputsById(["OldLedgerGroup", "OldLedgerName", "UpdatedLedgerGroup", "UpdatedLedgerName", "UpdatedOBJ", "UpdatedOBK"]);

        } catch (error) {
            alert("An error occurred while updating the ledger.");
        }
    }

    document.getElementById("UpdateLedgerButton").addEventListener("click", update_ledger);


    // Save Product ///////////////////////////////////////////////////////////////////////////////
    async function saveProduct() {
        const spgroup = capitalizeWords(document.getElementById("ProductGroup").value.trim());
        const productname = capitalizeWords(document.getElementById("ProductName").value.trim());
        const opstk = document.getElementById("ProductOPSTK").value.trim();

        if (!spgroup || !productname) {
            alert("Please fill both Group and Product Name.");
            return;
        }

        const q = query(
            collection(db, "tran"),
            where("name", "==", productname)
        );
        const snapshot = await getDocs(q);
        if (!snapshot.empty) {
            alert("Product already exists.");
            return;
        }

        const tranCol = collection(db, "tran");
        const allDocs = await getDocs(tranCol);

        let maxId = 0;
        allDocs.forEach(doc => {
            const data = doc.data();
            const idNum = Number(data.id);
            if (!isNaN(idNum) && idNum > maxId) {
                maxId = idNum;
            }
        });

        const newId = maxId + 1;
        const amt = opstk === "" ? 0 : Number(opstk);

        await addDoc(tranCol, {
            id: newId,
            date: new Date().toISOString().split("T")[0],
            ttype: "Op Stock",
            fparty: productname,
            amt,
            grp: spgroup,
            name: productname
        });

        addToDatalist("allnames_list", newacname);

        document.getElementById("ProductGroup").value = "";
        document.getElementById("ProductName").value = "";
        document.getElementById("ProductOPSTK").value = "";
    }

    document.getElementById("SaveProductButton").addEventListener("click", saveProduct);


    // Update Product /////////////////////////////////////////////////////////////////////////////
    async function updateProduct() {
        const oldProdGrp = capitalizeWords(document.getElementById("OldProductGroup")?.value.trim() || "");
        const oldProdName = capitalizeWords(document.getElementById("OldProductName")?.value.trim() || "");
        const newProdGrp = capitalizeWords(document.getElementById("NewProductGroup")?.value.trim() || "");
        const newProdName = capitalizeWords(document.getElementById("NewProductName")?.value.trim() || "");
        const newOpStock = document.getElementById("NewOpStock")?.value.trim() || "";

        if (!oldProdGrp || !oldProdName || !newProdName) {
            alert("Please enter old and new product group and names.");
            return;
        }

        // ‚úÖ Determine final group to use
        const finalProdGrp = newProdGrp || oldProdGrp;

        try {
            // ‚úÖ Check if new product name already exists in target group
            const existsQuery = query(
                collection(db, "tran"),
                where("grp", "==", finalProdGrp),
                where("name", "==", newProdName)
            );
            const existsSnap = await getDocs(existsQuery);
            if (!existsSnap.empty) {
                alert("Product with this name already exists in the selected group.");
                return;
            }

            const tranCol = collection(db, "tran");
            const snapshot = await getDocs(tranCol);

            if (snapshot.empty) {
                alert("No documents found in the tran collection.");
                return;
            }

            const updatePromises = [];

            snapshot.forEach(docSnap => {
                const data = docSnap.data();
                const docRef = doc(db, "tran", docSnap.id);

                // ‚úÖ Check for Op Stock record match
                const matchOpStock =
                    data.grp === oldProdGrp &&
                    data.name === oldProdName &&
                    data.ttype === "Op Stock";

                // ‚úÖ Check for other transactions referencing old product name
                const matchOther = ["fparty", "tparty", "name"].some(field => data[field] === oldProdName);

                const updatedData = {};
                let needsUpdate = false;

                if (matchOpStock) {
                    // ‚úÖ Update Op Stock record
                    updatedData.grp = finalProdGrp;
                    updatedData.name = newProdName;
                    updatedData.fparty = newProdName;
                    updatedData.amt =
                        newOpStock !== "" ? Number(newOpStock) : Number(data.amt || 0);
                    needsUpdate = true;
                } else if (matchOther) {
                    // ‚úÖ For other transactions:
                    // Only update if both old group and old name match
                    if (data.grp === oldProdGrp && data.name === oldProdName) {
                        updatedData.grp = finalProdGrp;
                        updatedData.name = newProdName;
                        needsUpdate = true;
                    }

                    // ‚úÖ If product name is referenced in fparty/tparty elsewhere,
                    // update those fields (but not grp there)
                    ["fparty", "tparty"].forEach(field => {
                        if (data[field] === oldProdName) {
                            updatedData[field] = newProdName;
                            needsUpdate = true;
                        }
                    });
                }

                if (needsUpdate) {
                    updatePromises.push(updateDoc(docRef, updatedData));
                }
            });

            await Promise.all(updatePromises);

            alert("Product updated successfully!");

            // ‚úÖ Clear fields
            const ids = [
                "OldProductGroup",
                "OldProductName",
                "NewProductGroup",
                "NewProductName",
                "NewOpStock"
            ];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = "";
            });

        } catch (error) {
            alert("An error occurred while updating the product.");
        }
    }

    document.getElementById("UpdateProductButton").addEventListener("click", updateProduct);


    // Transactions ///////////////////////////////////////////////////////////////////////////////


    // Get Form Values ////////////////////////////////////////////////////////////////////////////
    function getFormValues(prefix) {
        return {
            date: document.getElementById(prefix + "TranDate")?.value.trim() || "",
            ttype: document.getElementById(prefix + "TranTtype")?.value.trim() || "",
            fparty: document.getElementById(prefix + "TranFparty")?.value.trim() || "",
            tparty: document.getElementById(prefix + "TranTparty")?.value.trim() || "",
            amt: document.getElementById(prefix + "TranAmount")?.value.trim() || "",
            nar: document.getElementById(prefix + "TranNar")?.value.trim() || "",
            idd: document.getElementById(prefix + "Id")?.value.trim() || ""
        };
    }


    // Clear Form Values //////////////////////////////////////////////////////////////////////////
    function clearFormValues(prefix) {
        const fields = ["date", "ttype", "fparty", "tparty", "amount", "nar", "id"];
        fields.forEach(field => {
            const el = document.getElementById(prefix + "Tran" + capitalizeWords(field));
            if (el) el.value = "";
        });

        const idInput = document.getElementById(prefix + "Id");
        if (idInput) {
            idInput.value = "";
            idInput.disabled = false;
        }
    }


    // Save Transaction ///////////////////////////////////////////////////////////////////////////
    async function saveTransaction() {
        try {
            const saveBtn = document.getElementById("AddTranSaveButton");
            let errorElem = document.getElementById("AddTranError");
            if (!errorElem) {
                errorElem = document.createElement("small");
                errorElem.id = "AddTranError";
                errorElem.style.color = "red";
                errorElem.style.display = "none";
                saveBtn.insertAdjacentElement("afterend", errorElem);
            }

            // ‚úÖ Fetch values
            let values = getFormValues("Add");

            // Check mandatory fields
            const missingFields = [];
            if (!values.ttype) missingFields.push("Transaction Type");
            if (!values.date) missingFields.push("Date");
            if (!values.fparty) missingFields.push("From Party");
            if (!values.tparty) missingFields.push("To Party");
            if (!values.amt) missingFields.push("Amount");

            if (missingFields.length > 0) {
                errorElem.textContent = "‚ùå Please fill: " + missingFields.join(", ");
                errorElem.style.display = "block";
                return;
            } else {
                errorElem.style.display = "none";
            }

            // ‚úÖ Flip parties if Sales
            if (values.ttype.toLowerCase() === "sales") {
                const temp = values.fparty;
                values.fparty = values.tparty;
                values.tparty = temp;
            }

            const tranCol = collection(db, "tran");

            // Find max id
            const snapshot = await getDocs(tranCol);
            let maxId = 0;
            snapshot.forEach(doc => {
                const idVal = parseInt(doc.data().id, 10);
                if (!isNaN(idVal) && idVal > maxId) maxId = idVal;
            });
            const newId = maxId + 1;

            await addDoc(tranCol, {
                id: Number(newId),
                date: values.date,
                ttype: values.ttype,
                fparty: values.fparty,
                tparty: values.tparty,
                amt: Number(values.amt) || 0,
                nar: values.nar,
                grp: values.grp || "",
                name: values.name || ""
            });
            clearFormValues("Add");

        } catch (error) {
            alert("‚ùå Failed to save.");
        }
    }

    document.getElementById("AddTranSaveButton").addEventListener("click", saveTransaction);


    // Search & Insert ////////////////////////////////////////////////////////////////////////////
    async function searchAndInsert(prefix) {
        const idInput = document.getElementById(prefix + "Id");
        const searchId = idInput?.value.trim();

        if (!searchId) {
            alert("Please enter an ID to search.");
            return;
        }

        try {
            const tranCol = collection(db, "tran");
            const q = query(tranCol, where("id", "==", Number(searchId)));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                alert("‚ùå No document found with this ID.");
                return;
            }

            const docSnap = querySnapshot.docs[0];
            const data = docSnap.data();

            console.log("‚úÖ Firestore data loaded:", data);

            // Define mapping from form field names ‚Üí Firestore fields
            const fieldMap = {
                date: "date",
                ttype: "ttype",
                fparty: "fparty",
                tparty: "tparty",
                amount: "amt",    // map amount ‚Üí amt
                nar: "nar"
            };

            Object.entries(fieldMap).forEach(([formField, firestoreField]) => {
                const elementId = prefix + "Tran" + capitalizeWords(formField);
                const el = document.getElementById(elementId);
                if (el) {
                    el.value = data[firestoreField] != null ? String(data[firestoreField]) : "";
                    console.log(`Set ${elementId} ‚Üí`, el.value);
                } else {
                    console.warn("‚ö†Ô∏è Element not found:", elementId);
                }
            });

            // ‚úÖ CRITICAL STEP:
            // After loading ttype, dispatch change so datalists get set
            const ttypeInput = document.getElementById(prefix + "TranTtype");
            if (ttypeInput) {
                ttypeInput.dispatchEvent(new Event("change"));
                console.log("‚úÖ Dispatched change event on", prefix + "TranTtype");
            }

            if (idInput) {
                idInput.disabled = true;
            }

        } catch (e) {
            console.error(e);
            alert("Error fetching data.");
        }
    }

    document.getElementById("UpdateSearchButton").addEventListener("click", () => {
        searchAndInsert("Update");
    });


    // Update Transaction /////////////////////////////////////////////////////////////////////////
    async function updateTransaction() {
        const idInput = document.getElementById("UpdateId");
        const idValue = idInput?.value.trim() || "";

        if (!idValue) {
            alert("‚ùå Please enter an ID to update.");
            return;
        }

        try {
            const tranCol = collection(db, "tran");
            const q = query(tranCol, where("id", "==", Number(idValue)));
            const snapshot = await getDocs(q);

            if (snapshot.empty) {
                alert("‚ùå No transaction found with this ID.");
                return;
            }

            const formData = getFormValues("Update");

            for (const docSnap of snapshot.docs) {
                const updates = {
                    date: formData.date,
                    ttype: formData.ttype,
                    fparty: formData.fparty,
                    tparty: formData.tparty,
                    amt: formData.amt !== undefined && formData.amt !== ""
                        ? Number(formData.amt)
                        : 0,
                    nar: formData.nar,
                    id: Number(idValue)
                };

                await updateDoc(docSnap.ref, updates);
            }
            clearFormValues("Update");

        } catch (error) {
            alert("Error updating transaction: " + error.message);
        }
    }

    document.getElementById("UpdateTranButton").addEventListener("click", updateTransaction);


    // Delete Transaction /////////////////////////////////////////////////////////////////////////
    async function deleteTransaction() {
        const idVal = document.getElementById("DeleteId")?.value.trim();
        const errorDiv = document.getElementById("delete-error");
        if (errorDiv) {
            errorDiv.textContent = "";
        }

        if (!idVal) {
            errorDiv.textContent = "Please enter an ID to delete.";
            return;
        }
        const tranCol = collection(db, "tran");
        const q = query(tranCol, where("id", "==", Number(idVal)));
        const snapshot = await getDocs(q);

        if (snapshot.empty) {
            errorDiv.textContent = "No transaction found with this ID.";
            return;
        }
        for (const docSnap of snapshot.docs) {
            await deleteDoc(docSnap.ref);
        }
        document.getElementById("DeleteId").value = "";
        errorDiv.textContent = "";
    }

    document.getElementById("DeleteTranButton").addEventListener("click", deleteTransaction);


    //  VIEWS  ////////////////////////////////////////////////////////////////////////////////////


    // Custom Table ///////////////////////////////////////////////////////////////////////////////
    function renderTable(containerId, columns, rows, widths, aligns) {
        const container = document.getElementById(containerId);
        container.innerHTML = "";

        if (!rows.length) {
            container.textContent = "No data found.";
            return;
        }
        const table = document.createElement("table");

        // header
        const thead = document.createElement("thead");
        const trHead = document.createElement("tr");
        columns.forEach((col, i) => {
            const th = document.createElement("th");
            th.textContent = col;
            th.style.width = widths?.[i] || "auto";
            th.style.textAlign = aligns?.[i] || "left";
            trHead.appendChild(th);
        });
        thead.appendChild(trHead);
        table.appendChild(thead);

        // body
        const tbody = document.createElement("tbody");
        rows.forEach(row => {
            const tr = document.createElement("tr");
            columns.forEach((col, i) => {
                const td = document.createElement("td");
                td.textContent = row[col] || "";
                td.style.textAlign = aligns?.[i] || "left";
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        container.appendChild(table);
    }


    // Daybook ////////////////////////////////////////////////////////////////////////////////////
    async function viewDaybook(clearFields = false) {
        const tranCol = collection(db, "tran");
        const snapshot = await getDocs(tranCol);

        // get filter values from UI fields
        const type = document.getElementById("typeField").value.trim().toLowerCase();
        const party = document.getElementById("apartyfield").value.trim().toLowerCase();
        const amount = document.getElementById("amountField").value.trim();

        let rows = [];

        snapshot.forEach(doc => {
            const data = doc.data();

            const record = {
                Date: formatDate(data.date || ""),
                TranType: data.ttype || "",
                From: data.fparty || "",
                To: data.tparty || "",
                Narattion: data.nar || "",
                Amount: data.amt || "0",
                Id: data.id || ""
            };

            let include = true;

            if (type && record.TranType.toLowerCase() !== type) {
                include = false;
            }
            if (party) {
                const f = (record.From || "").toLowerCase();
                const t = (record.To || "").toLowerCase();
                if (!f.includes(party) && !t.includes(party)) {
                    include = false;
                }
            }
            if (amount) {
                const recordAmt = Number(record.Amount || 0);
                if (recordAmt !== Number(amount)) {
                    include = false;
                }
            }

            // ‚úÖ NEW CONDITION: skip rows where amount is 0
            if (Number(record.Amount) === 0) {
                include = false;
            }

            if (include) {
                rows.push(record);
            }
        });

        // sort descending by date
        rows.sort(
            (a, b) =>
                new Date(b.Date.split("-").reverse().join("-")) -
                new Date(a.Date.split("-").reverse().join("-"))
        );

        // define columns, widths, and alignments
        const columns = ["Date", "TranType", "From", "To", "Narattion", "Amount", "Id"];
        const widths = ["100px", "100px", "120px", "120px", "200px", "80px", "60px"];
        const aligns = ["left", "left", "left", "left", "left", "right", "right"];

        renderTable("daybookTable", columns, rows, widths, aligns);

        if (clearFields) {
            document.getElementById("typeField").value = "";
            document.getElementById("apartyfield").value = "";
            document.getElementById("amountField").value = "";
        }
    }


    // Groups & Accounts //////////////////////////////////////////////////////////////////////////
    async function viewGroupsAndAccounts() {
        const tranCol = collection(db, "tran");
        const snapshot = await getDocs(tranCol);
        let rows = [];

        snapshot.forEach(doc => {
            const data = doc.data();
            if (data.grp && data.name) {
                rows.push({Groups: data.grp || "", Accounts: data.name || ""});
            }
        });
        rows.sort((a, b) => {
            return a.Accounts.toLowerCase().localeCompare(b.Accounts.toLowerCase());
        });
        renderTable("viewGroupsLadgersTable", ["Groups", "Accounts"], rows, ["150px", "200px"], ["left", "left"]);
    }


    // Products ///////////////////////////////////////////////////////////////////////////////////
    async function viewProducts() {
        const tranCol = collection(db, "tran");
        const snapshot = await getDocs(tranCol);
        let rows = [];

        snapshot.forEach(doc => {
            const data = doc.data();
            // Only include if grp is "Sales" or "Purchase"
            if (
                data.grp &&
                data.name &&
                (data.grp.toLowerCase() === "sales" || data.grp.toLowerCase() === "purchase")
            ) {
                rows.push({Group: data.grp || "", Product: data.name || ""});
            }
        });
        // Sort alphabetically by product name
        rows.sort((a, b) => a.Product.toLowerCase().localeCompare(b.Product.toLowerCase()));
        renderTable("productsTable", ["Group", "Product"], rows, ["150px", "200px"], ["left", "left"]);
    }


    // Receivable /////////////////////////////////////////////////////////////////////////////////
    async function viewReceivables() {
        const tranCol = collection(db, "tran");
        const snapshot = await getDocs(tranCol);

        const ledgerGroups = {};
        const balances = {};

        // Build ledger group mappings
        snapshot.forEach(doc => {
            const data = doc.data();
            const name = (data.name || "").trim().toLowerCase();
            const grp = (data.grp || "").trim().toLowerCase();

            if (name && grp) {
                ledgerGroups[name] = grp;
            }
        });

        // Calculate balances from fparty/tparty
        snapshot.forEach(doc => {
            const data = doc.data();

            if (data.fparty) {
                const party = data.fparty.trim().toLowerCase();
                balances[party] = (balances[party] || 0) + parseFloat(data.amt || "0");
            }
            if (data.tparty) {
                const party = data.tparty.trim().toLowerCase();
                balances[party] = (balances[party] || 0) - parseFloat(data.amt || "0");
            }
        });
        // Prepare rows for receivables
        const allowedGroups = ["creditors", "debitors", "bank", "angadiya"];
        const rows = [];

        for (const [party, amount] of Object.entries(balances)) {
            const grp = ledgerGroups[party];
            if (amount < 0 && grp && allowedGroups.includes(grp)) {
                rows.push({
                    Party: capitalizeWords(party),
                    Amount: Math.abs(amount).toFixed(0)
                });
            }
        }
        rows.sort((a, b) => b.Amount - a.Amount);
        renderTable("viewRecTable", ["Party", "Amount"], rows, ["200px", "100px"], ["left", "right"]);
    }


    // Payable ////////////////////////////////////////////////////////////////////////////////////
    async function viewPayables() {
        const tranCol = collection(db, "tran");
        const snapshot = await getDocs(tranCol);

        const ledgerGroups = {};
        const balances = {};

        // Capture ledger definitions
        snapshot.forEach(doc => {
            const data = doc.data();
            const name = (data.name || "").trim().toLowerCase();
            const grp = (data.grp || "").trim().toLowerCase();

            if (name && grp) {
                ledgerGroups[name] = grp;
            }
        });
        // Sum amounts for all parties
        snapshot.forEach(doc => {
            const data = doc.data();

            if (data.fparty) {
                const party = data.fparty.trim().toLowerCase();
                balances[party] = (balances[party] || 0) + parseFloat(data.amt || "0");
            }
            if (data.tparty) {
                const party = data.tparty.trim().toLowerCase();
                balances[party] = (balances[party] || 0) - parseFloat(data.amt || "0");
            }
        });
        // Prepare payables list
        const allowedGroups = ["creditors", "debitors", "bank", "angadiya"];
        const rows = [];

        for (const [party, amount] of Object.entries(balances)) {
            const grp = ledgerGroups[party];
            if (amount > 0 && grp && allowedGroups.includes(grp)) {
                rows.push({
                    Party: capitalizeWords(party),
                    Amount: amount.toFixed(0)
                });
            }
        }
        rows.sort((a, b) => b.Amount - a.Amount);
        renderTable("viewPayTable", ["Party", "Amount"], rows, ["200px", "100px"], ["left", "right"]);
    }


    // Khatavahi //////////////////////////////////////////////////////////////////////////////////
    async function khatavahi() {
        const fromDate = document.getElementById("kfromDate").value;
        const toDate = document.getElementById("ktoDate").value;
        const partyName = capitalizeWords(document.getElementById("kparty").value.trim());

        if (!fromDate || !toDate || !partyName) {
            alert("Please select both dates and party.");
            return;
        }
        const fDate = fromDate;
        const tDate = toDate;

        try {
            const tranCol = collection(db, "tran");
            const snapshot = await getDocs(tranCol);
            let opBal = 0;
            let transRows = [];

            snapshot.forEach(docSnap => {
                const data = docSnap.data();

                const date = data.date || "";
                const fparty = (data.fparty || "").trim().toLowerCase();
                const tparty = (data.tparty || "").trim().toLowerCase();
                const party = partyName.trim().toLowerCase();

                // Calculate opening balance
                if (date < fDate) {
                    if (fparty === party) {
                        opBal += Number(data.amt);
                    } else if (tparty === party) {
                        opBal -= Number(data.amt);
                    }
                }

                // Filter transactions between dates
                if (
                    date >= fDate &&
                    date <= tDate &&
                    (fparty === party || tparty === party)
                ) {

                    transRows.push({
                        Date: formatDate(data.date || ""),
                        TranType: data.ttype || "",
                        From: data.fparty || "",
                        To: data.tparty || "",
                        Narration: data.nar || "",
                        Amount: Math.abs(Number(data.amt)).toFixed(0),
                        ID: data.id?.toString() || ""
                    });
                }
            });

            let runningBal = opBal;
            let finalRows = [];

            // Opening balance row
            let opLabel = "Opening Balance";
            if (opBal < 0) opLabel += " Dr";
            else if (opBal > 0) opLabel += " Cr";

            finalRows.push({
                Date: "",
                TranType: "",
                From: opLabel,
                To: "",
                Narration: "",
                Amount: Math.abs(opBal).toFixed(0),
                ID: ""
            });

            // Transaction rows
            transRows.forEach(tran => {
                if (tran.From?.toLowerCase() === partyName.toLowerCase()) {
                    runningBal += Number(tran.Amount);
                } else if (tran.To?.toLowerCase() === partyName.toLowerCase()) {
                    runningBal -= Number(tran.Amount);
                }
                finalRows.push(tran);
            });

            // Closing balance row
            let clLabel = "Closing Balance";
            if (runningBal < 0) clLabel += " Dr";
            else if (runningBal > 0) clLabel += " Cr";

            finalRows.push({
                Date: "",
                TranType: "",
                From: clLabel,
                To: "",
                Narration: "",
                Amount: Math.abs(runningBal).toFixed(0),
                ID: ""
            });

            const header = ["Date", "TranType", "From", "To", "Narration", "Amount", "ID"];
            const widths = ["100px", "100px", "120px", "120px", "200px", "80px", "60px"];
            const aligns = ["left", "left", "left", "left", "left", "right", "right"];

            const targetDiv = document.getElementById("khaTable");
            if (!targetDiv) {
                alert("Cannot render table because khaTable does not exist.");
                return;
            }
            renderTable("khaTable", header, finalRows, widths, aligns);

        } catch (error) {
            alert("An error occurred while loading the khatavahi.");
        }
    }

    document.getElementById("calkhabtn").addEventListener("click", khatavahi);


    // Profit Loss ////////////////////////////////////////////////////////////////////////////////
    document.getElementById("calculateProfitbtn").addEventListener("click", () => {
        const fromDate = document.getElementById("fromDate").value;
        const toDate = document.getElementById("toDate").value;
        profit_loss(fromDate, toDate);
    });

    async function profit_loss(fromDate = "", toDate = "") {
        const closingStock = parseFloat(document.getElementById("closingStock").value || 0);

        const tranCol = collection(db, "tran");
        const snapshot = await getDocs(tranCol);

        let openingStock = 0;
        let purchase = 0;
        let expense = 0;
        let sales = 0;

        snapshot.forEach(doc => {
            const data = doc.data();
            const tranDate = data.date || "";
            const amount = parseFloat(data.amt || 0);
            const ttype = (data.ttype || "").toLowerCase();

            if (fromDate && toDate) {
                if (tranDate < fromDate || tranDate > toDate) {
                    return;
                }
            }

            if (ttype === "op stock") {
                openingStock += amount;
            } else if (ttype === "purchase") {
                purchase += amount;
            } else if (ttype === "expense") {
                expense += amount;
            } else if (ttype === "sales") {
                sales += amount;
            }
        });

        const debitTotal = openingStock + purchase + expense;
        const creditTotal = sales + closingStock;
        const profit = creditTotal - debitTotal;

        const rows = [
            {Description: "Opening Stock", Amount: openingStock.toFixed(0)},
            {Description: "Purchase", Amount: purchase.toFixed(0)},
            {Description: "Expense", Amount: expense.toFixed(0)},
            {Description: "Total (Op+Pur+Exp)", Amount: debitTotal.toFixed(0)},
            {Description: "Sales", Amount: sales.toFixed(0)},
            {Description: "Closing Stock", Amount: closingStock.toFixed(0)},
            {Description: "Total (Sales+Clo)", Amount: creditTotal.toFixed(0)},
            {Description: "Profit / Loss", Amount: profit.toFixed(0)},
        ];

        renderTable("plTable", ["Description", "Amount"], rows, ["70%", "30%"], ["left", "right"]);
    }


    // Export Data To CSV PDF /////////////////////////////////////////////////////////////////////
    async function exportData() {
        const startDateStr = document.getElementById("exportStartDate").value;
        const endDateStr = document.getElementById("exportEndDate").value;
        const party = document.getElementById("exportParty").value.trim();
        const ttype = document.getElementById("exportTType").value.trim();
        const errorDiv = document.getElementById("exportError");
        errorDiv.textContent = "";

        // Validate required fields
        if (!startDateStr || !endDateStr) {
            errorDiv.textContent = "‚ùå Please fill start and end dates!";
            return;
        }

        if (!party && !ttype) {
            errorDiv.textContent = "‚ùå Please enter either Party or Transaction Type (or both).";
            return;
        }

        const startDate = toYMD(startDateStr);
        const endDate = toYMD(endDateStr);
        const tranCol = collection(db, "tran");
        const snapshot = await getDocs(tranCol);

        let rows = [];

        snapshot.forEach(doc => {
            const data = doc.data();
            const recordDate = data.date || "";

            if (!recordDate) return;

            if (recordDate >= startDate && recordDate <= endDate) {
                let matches = true;

                if (ttype) {
                    if ((data.ttype || "").toLowerCase() !== ttype.toLowerCase()) {
                        matches = false;
                    }
                }

                if (party) {
                    const f = (data.fparty || "").toLowerCase();
                    const t = (data.tparty || "").toLowerCase();
                    if (f !== party.toLowerCase() && t !== party.toLowerCase()) {
                        matches = false;
                    }
                }

                if (matches) {
                    rows.push({
                        Date: formatDate(data.date),
                        TransactionType: data.ttype || "",
                        From: data.fparty || "",
                        To: data.tparty || "",
                        Narration: data.nar || "",
                        Amount: data.amt || "0",
                        Id: data.id || ""
                    });
                }
            }
        });

        if (!rows.length) {
            errorDiv.textContent = "‚ö†Ô∏è No data found for selected filters.";
            return;
        }
        exportToCSV(rows);
        exportToPDF(rows);
    }

    function exportToCSV(rows) {
        const headers = Object.keys(rows[0]);
        let csv = headers.join(",") + "\n";

        rows.forEach(row => {
            const line = headers
                .map(h => `"${String(row[h] || "").replace(/"/g, '""')}"`)
                .join(",");
            csv += line + "\n";
        });

        const blob = new Blob([csv], {type: "text/csv"});
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = `Export_${new Date().getTime()}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    function exportToPDF(rows) {
        if (!rows || !rows.length) {
            showError("No rows to export to PDF.");
            return;
        }
        const {jsPDF} = window.jspdf;
        const doc = new jsPDF();

        const columns = Object.keys(rows[0]);
        const data = rows.map(row =>
            columns.map(col => String(row[col] || ""))
        );

        doc.text("Export Data", 14, 14);
        doc.autoTable({
            startY: 20,
            head: [columns],
            body: data
        });
        doc.save(`Export_${new Date().getTime()}.pdf`);
    }

    document.getElementById("exportBtn").addEventListener("click", exportData);


    // On Page Load Functions /////////////////////////////////////////////////////////////////////
    window.onload = () => {
        updateCashLabel();
    };

</script>

</body>

</html>
