<!DOCTYPE html>
<html class="bg-gray-100" lang="en">


<head>
    <meta charset="UTF-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Gopalji's App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script defer src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script defer src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script defer src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script defer src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
    <link href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>

    <style>
        table.dataTable th, table.dataTable td {
            border: 1px solid #ccc !important;
        }

        .dt-button {
            margin-right: 5px !important;
            padding: 5px 10px !important;
            border-radius: 8px !important;
            color: white !important;
            border: none !important;
            font-weight: bold;
        }

        .buttons-excel {
            background-color: #16a34a !important;
        }

        .buttons-pdf {
            background-color: #dc2626 !important;
        }

        .buttons-print {
            background-color: #2563eb !important;
        }
    </style>
</head>


<body class="font-[Inter] font-medium text-[17px]">


<!-- Topbar -------------------------------------------------------------------------------------->
<div class="bg-blue-700 text-white px-1 py-3 flex items-center justify-between fixed top-0 w-full z-50 h-12">
    <div class="space-x-2 flex items-center">
        <button class=" hover:bg-blue-800 px-2 py-2 rounded" onclick="clearScreen(); toggleMenu()">‚ò∞</button>
        <span class="font-semibold">üìò MyApp</span>
    </div>
    <div class=" mr-5 font-semibold" id="cashLabel">Cash: ‚Çπ0.00</div>
</div>


<!-- Menu Submenu Buttons ------------------------------------------------------------------------>
<div class="hidden fixed top-14 left-0 w-full sm:w-96 px-2 py-2 z-40 space-y-2" id="sidebar">

    <!-- Transactions -->
    <button class="w-full text-left px-5 py-2.5 bg-blue-600 hover:bg-blue-800 text-white rounded-md font-semibold"
            onclick="clearScreen(); toggleSubmenu('transaction')">‚ûï Transactions
    </button>
    <div class="hidden mt-2 space-y-1 pl-6 border-l-2 border-blue-300" id="submenu-transaction">
        <button class="w-full text-left px-4 py-2 bg-blue-400 hover:bg-blue-600 text-white rounded-md"
                onclick="clearScreen(); showTransactionForm('Sales', null); toggleMenu();">üõí Sales
        </button>
        <button class="w-full text-left px-4 py-2 bg-blue-400 hover:bg-blue-600 text-white rounded-md"
                onclick="clearScreen(); showTransactionForm('Purchase', null); toggleMenu();">üß∫ Purchase
        </button>
        <button class="w-full text-left px-4 py-2 bg-blue-400 hover:bg-blue-600 text-white rounded-md"
                onclick="clearScreen(); showTransactionForm('Receipt', null); toggleMenu();">üíµ Receipt
        </button>
        <button class="w-full text-left px-4 py-2 bg-blue-400 hover:bg-blue-600 text-white rounded-md"
                onclick="clearScreen(); showTransactionForm('Payment', null); toggleMenu();">üí≥ Payment
        </button>
    </div>

    <!-- Groups / Products / Ledgers -->
    <button class="w-full text-left px-5 py-2.5 bg-purple-600 hover:bg-purple-800 text-white rounded-md font-semibold"
            onclick="clearScreen(); toggleSubmenu('grpprodled')">‚ûï Groups Products Ledgers
    </button>
    <div class="hidden mt-2 space-y-1 pl-6 border-l-2 border-purple-300" id="submenu-grpprodled">
        <button class="w-full text-left px-4 py-2 bg-purple-400 hover:bg-purple-600 text-white rounded-md"
                onclick="clearScreen(); showGroupForm('Group', null); toggleMenu();">üë• New Group
        </button>
        <button class="w-full text-left px-4 py-2 bg-purple-400 hover:bg-purple-600 text-white rounded-md"
                onclick="clearScreen(); showProductForm('Opening Stock', null); toggleMenu();">üì¶ New Product
        </button>
        <button class="w-full text-left px-4 py-2 bg-purple-400 hover:bg-purple-600 text-white rounded-md"
                onclick="clearScreen(); showLedgerForm('Opening Balance', null); toggleMenu();">üìñ New Ledger
        </button>
    </div>

    <!-- Update -->
    <button class="w-full text-left px-5 py-2.5 bg-red-600 hover:bg-red-800 text-white rounded-md font-semibold"
            onclick="clearScreen(); toggleSubmenu('update')">‚úèÔ∏è Update
    </button>
    <div class="hidden mt-2 space-y-1 pl-6 border-l-2 border-red-300" id="submenu-update">
        <button class="w-full text-left px-4 py-2 bg-red-400 hover:bg-red-600 text-white rounded-md"
                onclick="clearScreen(); showDaybook(); toggleMenu();">üìì Daybook
        </button>
    </div>

    <!-- Reports -->
    <button class="w-full text-left px-5 py-2.5 bg-green-600 hover:bg-green-800 text-white rounded-md font-semibold"
            onclick="clearScreen(); toggleSubmenu('report')">üíº Reports
    </button>
    <div class="hidden mt-2 space-y-1 pl-6 border-l-2 border-green-300" id="submenu-report">
        <button class="w-full text-left px-4 py-2 bg-green-400 hover:bg-green-600 text-white rounded-md"
                onclick="clearScreen(); viewGroupsAndAccounts(); toggleMenu();">üë• View Groups & Accounts
        </button>
        <button class="w-full text-left px-4 py-2 bg-green-400 hover:bg-green-600 text-white rounded-md"
                onclick="clearScreen(); viewProducts(); toggleMenu();">üì¶ View Products
        </button>
        <button class="w-full text-left px-4 py-2 bg-green-400 hover:bg-green-600 text-white rounded-md"
                onclick="clearScreen(); viewReceivables(); toggleMenu();">üíµ View Receivables
        </button>
        <button class="w-full text-left px-4 py-2 bg-green-400 hover:bg-green-600 text-white rounded-md"
                onclick="clearScreen(); viewPayables(); toggleMenu();">üí≥ View Payables
        </button>
        <button class="w-full text-left px-4 py-2 bg-green-400 hover:bg-green-600 text-white rounded-md"
                onclick="clearScreen(); showKhatavahiForm(); toggleMenu();">‚è≥ View Khatavahi
        </button>
        <button class="w-full text-left px-4 py-2 bg-green-400 hover:bg-green-600 text-white rounded-md"
                onclick="clearScreen(); showPLForm(); toggleMenu();">üìà Profit üìâ Loss
        </button>
    </div>

    <!-- Logout -->
    <button class="w-full text-left px-5 py-2.5 bg-gray-600 hover:bg-gray-800 text-white rounded-md font-semibold"
            onclick="clearScreen(); logout(); toggleMenu();">üîê Logout
    </button>
</div>


<!-- Login,Register,Widget-Area, Modify Table ---------------------------------------------------->
<div class="pt-20 px-4">
    <div id="loginContainer" style="display: none;">
        <h2>Login</h2>
        <input class="block w-[350px] max-w-full mb-2 px-3 py-2 border rounded" id="loginEmail" placeholder="Email" type="email">
        <input class="block w-[350px] max-w-full mb-2 px-3 py-2 border rounded" id="loginPassword" placeholder="Password" type="password">
        <button class="px-4 py-2 bg-blue-600 hover:bg-blue-800 text-white rounded" onclick="window.login()">Login</button>
        <div class="text-red-600" id="loginError"></div>
        <a href="#" onclick="event.preventDefault(); showRegister();">Don‚Äôt have an account? Register</a>
    </div>

    <div id="registerContainer" style="display:none;">
        <h2>Register</h2>
        <input class="block w-[350px] max-w-full mb-2 px-3 py-2 border rounded" id="registerEmail" placeholder="Email" type="email">
        <input class="block w-[350px] max-w-full mb-2 px-3 py-2 border rounded" id="registerPassword" placeholder="Password" type="password">
        <button class="px-4 py-2 bg-green-600 hover:bg-green-800 text-white rounded" onclick="register()">Register</button>
        <div class="text-red-600" id="registerError"></div>
        <a href="#" onclick="event.preventDefault(); showLogin();">Already have an account? Login</a>
    </div>

    <div id="widget-area"></div>

    <div id="tableWrapper" style="display:none">
        <table class="display nowrap border border-gray-400 w-full" id="tranTable" style="width:100%">
            <thead class="bg-blue-500 text-white">
            <tr>
                <th>ID</th>
                <th>Date</th>
                <th>Tran Type</th>
                <th>From Party</th>
                <th>To Party</th>
                <th>Narration</th>
                <th>Amount</th>
                <th>Groups</th>
                <th>Account Names</th>
                <th>Action</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>


<script type="module">
    import {initializeApp} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut}
        from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {getFirestore, collection, getDocs, setDoc, deleteDoc, doc, updateDoc, query, orderBy, limit, addDoc}
        from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    let currentDocId = null;
    let dataTableInstance = null;
    const firebaseConfig = {
        apiKey: "AIzaSyDQWZC6iA5zYKvTXsFl9TYLkZCTl5BzfwA",
        authDomain: "accounts-19d08.firebaseapp.com",
        projectId: "accounts-19d08",
        storageBucket: "accounts-19d08.appspot.com",
        messagingSenderId: "247308606105",
        appId: "1:247308606105:web:9bfc179368524244bf3608"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            await loadDataIntoTable();
            document.getElementById("loginContainer").style.display = "none";
            document.getElementById("registerContainer").style.display = "none";
        } else {
            window.showLogin();
        }
    });
    window.showLogin = function () {
        clearScreen();
        document.getElementById("loginContainer").style.display = "block";
    };
    window.showRegister = function () {
        clearScreen();
        document.getElementById("registerContainer").style.display = "block";
    };
    window.login = async function () {
        const email = document.getElementById("loginEmail").value;
        const password = document.getElementById("loginPassword").value;
        const errorDiv = document.getElementById("loginError");
        errorDiv.textContent = '';

        if (!email || !password) {
            errorDiv.textContent = "Please enter both email and password.";
            return;
        }

        try {
            await signInWithEmailAndPassword(auth, email, password);
            console.log("Login successful");
        } catch (error) {
            console.error(error);
            errorDiv.textContent = error.message;
        }
    };
    window.register = async function () {
        const email = document.getElementById("registerEmail").value;
        const password = document.getElementById("registerPassword").value;
        const errorDiv = document.getElementById("registerError");
        errorDiv.textContent = '';

        if (!email || !password) {
            errorDiv.textContent = "Please enter both email and password.";
            return;
        }

        try {
            await createUserWithEmailAndPassword(auth, email, password);
            console.log("Registration successful");
        } catch (error) {
            console.error(error);
            errorDiv.textContent = error.message;
        }
    };
    window.logout = async function () {
        await signOut(auth);
        console.log("User logged out");
    };
    window.toggleMenu = async function () {
        document.getElementById("sidebar").classList.toggle("hidden");
    }
    window.toggleSubmenu = function (key) {
        const allSubmenus = document.querySelectorAll("[id^='submenu-']");
        allSubmenus.forEach(menu => {
            if (menu.id !== 'submenu-' + key) {
                menu.classList.add("hidden");
            }
        });
        const selected = document.getElementById("submenu-" + key);
        if (selected) {
            selected.classList.toggle("hidden");
        }
    };
    window.clearScreen = async function () {
        document.getElementById("widget-area").innerHTML = '';
        document.getElementById("tableWrapper").style.display = "none";
        document.getElementById("loginContainer").style.display = "none";
        document.getElementById("registerContainer").style.display = "none";
        currentDocId = null;
    }

    function capitalizeWords(str) {
        return str
            .toLowerCase()
            .replace(/\b\w/g, char => char.toUpperCase());
    }

    function bindAutoCapitalizeTo(selector) {
        document.querySelectorAll(selector).forEach(input => {
            input.addEventListener('input', function () {
                this.value = capitalizeWords(this.value);
            });
        });
    }

    window.loadDropdownData = async function () {
        const tranCol = collection(db, "tran");
        const snapshot = await getDocs(tranCol);

        const grpSet = new Set();           // All groups except Sales & Purchase
        const spSet = new Set();            // Only Sales and Purchase
        const sproductSet = new Set();
        const crdbSet = new Set();
        const pproductSet = new Set();
        const crdbcsbkangSet = new Set();
        const crdbcsbkangexpSet = new Set();
        const allnameSet = new Set();          // All names where grp ‚â† Sales Product/Purchase Product

        const crdbGroups = ["Creditors", "Debitors"];
        const crdbcsbkangGroups = [...crdbGroups, "Cash", "Bank", "Angadiya"];
        const crdbcsbkangexpGroups = [...crdbcsbkangGroups, "Expense"];

        snapshot.forEach(doc => {
            const data = doc.data();
            const grp = (data.grp || "").trim();
            const name = (data.name || "").trim();
            if (grp.length === 0) return;

            if (["Sales Products", "Purchase Products"].includes(grp)) {
                spSet.add(grp);
            } else if (!["Receipt", "Payment"].includes(grp)) {
                grpSet.add(grp);
            }

            if (name.length > 0) {
                allnameSet.add(name);
            }

            // Sales products
            if (grp === "Sales Products" && name.length > 0) {
                sproductSet.add(name);
            }

            // Purchase products
            if (grp === "Purchase Products" && name.length > 0) {
                pproductSet.add(name);
            }

            // crdb list
            if (crdbGroups.includes(grp) && name.length > 0) {
                crdbSet.add(name);
            }

            // crdbcsbkang list
            if (crdbcsbkangGroups.includes(grp) && name.length > 0) {
                crdbcsbkangSet.add(name);
            }

            // crdbcsbkangexp list
            if (crdbcsbkangexpGroups.includes(grp) && name.length > 0) {
                crdbcsbkangexpSet.add(name);
            }
        });

        // Convert Sets to sorted arrays
        window.grp_list = [];
        window.sp_list = [];
        window.sproduct_list = [];
        window.crdb_list = [];
        window.pproduct_list = [];
        window.crdbcsbkang_list = [];
        window.crdbcsbkangexp_list = [];
        window.allnames_list = [];
        window.grp_list = [...grpSet].sort((a, b) => a.localeCompare(b));
        window.sp_list = [...spSet].sort((a, b) => a.localeCompare(b));
        window.sproduct_list = [...sproductSet].sort((a, b) => a.localeCompare(b));
        window.crdb_list = [...crdbSet].sort((a, b) => a.localeCompare(b));
        window.pproduct_list = [...pproductSet].sort((a, b) => a.localeCompare(b));
        window.crdbcsbkang_list = [...crdbcsbkangSet].sort((a, b) => a.localeCompare(b));
        window.crdbcsbkangexp_list = [...crdbcsbkangexpSet].sort((a, b) => a.localeCompare(b));
        window.allnames_list = [...allnameSet].sort((a, b) => a.localeCompare(b));
    }

    function generateDropdown(id, options, selectedValue = "", className = "") {
        let dropdown = `<select id="${id}" name="${id}" class="${className}">`;
        dropdown += `<option value="">-- Select --</option>`;
        for (let option of options) {
            const selected = option === selectedValue ? "selected" : "";
            dropdown += `<option value="${option}" ${selected}>${option}</option>`;
        }
        dropdown += `</select>`;
        return dropdown;
    }

    // Insert Data Into Fields To Modify Transaction
    async function loadDataIntoTable() {
        if (dataTableInstance) {
            dataTableInstance.destroy();
        }

        const snapshot = await getDocs(collection(db, "tran"));

        const table = $('#tranTable').DataTable({
            destroy: true,
            dom: 'Bfrtip',
            buttons: [
                {extend: 'excelHtml5', className: 'buttons-excel'},
                {extend: 'pdfHtml5', className: 'buttons-pdf'},
                {extend: 'print', className: 'buttons-print'}
            ],
            columnDefs: [
                {visible: false, targets: 0},
                {orderable: false, targets: -1}
            ]
        });

        table.clear();

        snapshot.forEach(doc => {
            const data = doc.data();
            const formattedDate = data.date ? data.date.split("-")[2] + "-" + data.date.split("-")[1] + "-" + data.date.split("-")[0] : '';
            table.row.add([
                String(doc.id), // Hidden
                formattedDate,
                data.ttype || '',
                data.fparty || '',
                data.tparty || '',
                data.nar || '',
                String(data.amt || ''),
                data.grp || '',
                data.name || '',
                `<button class="delete-btn" style="background-color: red; color: white; border: none; padding: 1px 10px 1px 10px; border-radius: 4px; cursor: pointer;">üóëÔ∏è Delete</button>`

            ]);
        });

        table.draw();
        dataTableInstance = table;

        $('#tranTable tbody').on('dblclick', 'tr', function () {
            const row = table.row(this).data();
            if (!row) return;
            if (row[2] === "Sales") {
                showTransactionForm("Sales", row);
            } else if (row[2] === "Purchase") {
                showTransactionForm("Purchase", row);
            } else if (row[2] === "Receipt") {
                showTransactionForm("Receipt", row);
            } else if (row[2] === "Payment") {
                showTransactionForm("Payment", row);
            } else if (row[2] === "Group") {
                showGroupForm("Group", row);
            } else if (row[2] === "Opening Stock") {
                showProductForm("Opening Stock", row);
            } else if (row[2] === "Opening Balance") {
                showLedgerForm("Opening Stock", row);
            }
        });

        $('#tranTable tbody').on('click', '.delete-btn', async function () {
            const row = table.row($(this).closest('tr'));
            const rowData = row.data();
            if (!row) return;
            const docId = rowData[0];
            const ttype = rowData[2];

            const deletableTypes = ["Sales", "Purchase", "Receipt", "Payment", "Expense"];
            if (!deletableTypes.includes(ttype)) {
                alert("Only sales,purchase,receipt,expense transactions can be deleted.");
                return;
            }

            const confirmDelete = confirm("Are you sure you want to delete this transaction?");
            if (!confirmDelete) return;

            try {
                await deleteDoc(doc(db, "tran", docId));
                row.remove().draw();
                alert("Transaction deleted successfully.");
            } catch (error) {
                console.error("Error deleting document:", error);
                alert("Failed to delete the transaction.");
            }
        });

    }

    window.showTransactionForm = async function (type = "Sales", rowData = null) {
        clearScreen();
        currentDocId = rowData ? rowData[0] : null;
        const cap = str => capitalizeWords((str || '').trim());
        const prefix = type.toLowerCase();
        let fPlaceholder = '', tPlaceholder = '';
        let fList = [], tList = [];
        let transactionLabel = '';

        if (type === 'Sales') {
            fPlaceholder = 'Sales Product';
            tPlaceholder = 'Sales Party';
            fList = (window.sproduct_list || []).map(opt => opt.trim());
            tList = (window.crdb_list || []).map(opt => opt.trim());
            transactionLabel = 'Sales Transaction';
        } else if (type === 'Purchase') {
            fPlaceholder = 'Purchase Party';
            tPlaceholder = 'Purchase Product';
            fList = (window.crdb_list || []).map(opt => opt.trim());
            tList = (window.pproduct_list || []).map(opt => opt.trim());
            transactionLabel = 'Purchase Transaction';
        } else if (type === 'Receipt') {
            fPlaceholder = 'From (e.g., Cash/Bank)';
            tPlaceholder = 'To (e.g., Expense)';
            fList = (window.crdbcsbkang_list || []).map(opt => opt.trim());
            tList = (window.crdbcsbkangexp_list || []).map(opt => opt.trim());
            transactionLabel = 'Receipt Transaction';
        } else if (type === 'Payment') {
            fPlaceholder = 'From (e.g., Cash/Bank)';
            tPlaceholder = 'To (e.g., Expense)';
            fList = (window.crdbcsbkang_list || []).map(opt => opt.trim());
            tList = (window.crdbcsbkangexp_list || []).map(opt => opt.trim());
            transactionLabel = 'Payment Transaction';
        }

        const inputClass = "block w-[350px] max-w-full mb-2 px-3 py-2.5 text-base border rounded text-[18px]";
        const content = `
            <label class="${inputClass} text-center">${transactionLabel}</label>

            <input id="${prefix}-date" type="date"
                   value="${rowData ? rowData[1].split("-").reverse().join("-") : ''}"
                   class="${inputClass}">

            <input id="${prefix}-type" disabled
                   value="${rowData?.[2] || type}"
                   class="${inputClass}">

            ${generateDropdown(`${prefix}-fparty`, fList, rowData?.[3], inputClass)}
            ${generateDropdown(`${prefix}-tparty`, tList, rowData?.[4], inputClass)}

            <input id="${prefix}-amount" type="number"
                   placeholder="Amount"
                   value="${rowData?.[6] || ''}"
                   class="${inputClass}">

            <input id="${prefix}-narration" placeholder="Narration"
               value="${cap(rowData?.[5]) || ''}"
               class="${inputClass}">

            <button onclick="saveTransaction('${type}')"
                    class="px-20 py-2.5 mt-4 bg-green-700 hover:bg-green-900 text-white rounded">üíæ Save
            </button>
        `;

        document.getElementById("widget-area").innerHTML = content;
        bindAutoCapitalizeTo(`#${prefix}-narration`);
    };

    window.saveTransaction = async function (type) {
        const prefix = type.toLowerCase();

        const date = document.getElementById(`${prefix}-date`).value;
        const ttype = document.getElementById(`${prefix}-type`).value;
        const fparty = document.getElementById(`${prefix}-fparty`).value;
        const tparty = document.getElementById(`${prefix}-tparty`).value;
        const amt = parseFloat(document.getElementById(`${prefix}-amount`).value);
        const nar = document.getElementById(`${prefix}-narration`).value;

        if (!date || !ttype || !fparty || !tparty || isNaN(amt)) {
            alert("‚ö†Ô∏è Please fill in all fields (except Narration) with valid values.");
            return;
        }

        const tranCollection = collection(db, "tran");
        const snapshot = await getDocs(tranCollection);
        const existingNames = new Set();
        snapshot.forEach(doc => {
            const data = doc.data();
            if (data.name) {
                existingNames.add(data.name);
            }
        });

        if (!existingNames.has(fparty) || !existingNames.has(tparty)) {
            alert(`‚ö†Ô∏è '${fparty}' or '${tparty}' not in list.`);
            return;
        }

        const dataToSave = {date, ttype, fparty, tparty, amt, nar};
        if (currentDocId) {
            const docRef = doc(tranCollection, currentDocId);
            await updateDoc(docRef, dataToSave);
        } else {
            await addDoc(tranCollection, dataToSave);
        }
        loadDataIntoTable();
        window.showTransactionForm(type);
        window.updateCashLabel();
    };

    window.showDaybook = async function () {
        clearScreen();
        document.getElementById("tableWrapper").style.display = "block";
    }

    window.showGroupForm = async function (type = 'Group', rowData = null) {
        clearScreen();
        currentDocId = rowData ? rowData[0] : null;
        const cap = str => capitalizeWords((str || '').trim());
        const content = `
            <input id="group" placeholder="Group Name" type="text"
                   value="${rowData ? cap(rowData[7]) : ''}"
                   class="block w-[350px] max-w-full mb-2 px-3 py-2.5 text-base border rounded text-[18px]" />

            <button onclick="saveGroup()" class="px-20 py-2.5 mt-4 bg-green-700 hover:bg-green-900 text-white rounded">üíæ Save</button>
        `;

        document.getElementById("widget-area").innerHTML = content;

        // ‚úÖ Apply always (new or old)
        bindAutoCapitalizeTo("#group");

    };

    window.saveGroup = async function (type) {
        const groupInput = document.getElementById('group');
        const groupName = (groupInput.value || '').trim();

        if (!groupName) {
            alert("Please enter a group name.");
            return;
        }

        const capGroup = capitalizeWords(groupName);
        try {
            const qSnapshot = await getDocs(collection(db, "tran"));
            let duplicate = false;

            qSnapshot.forEach(doc => {
                const data = doc.data();
                const docId = doc.id;
                if (
                    (data.grp && data.grp.toLowerCase() === capGroup.toLowerCase()) ||
                    (data.name && data.name.toLowerCase() === capGroup.toLowerCase())
                ) {
                    if (!currentDocId || currentDocId !== docId) {
                        duplicate = true;
                    }
                }
            });

            if (duplicate) {
                alert("Group name already exists.");
                return;
            }

            if (currentDocId) {
                await updateDoc(doc(db, "tran", currentDocId), {
                    grp: capGroup
                });
            } else {
                await addDoc(collection(db, "tran"), {
                    ttype: "Group",
                    grp: capGroup
                });
            }
        } catch (error) {
            alert("Something Went Wrong. Please Check If Its Added, ThenTry again.");
        }
        loadDataIntoTable();
        window.showGroupForm(type);
    };

    window.showProductForm = async function (type = 'Opening Stock', rowData = null) {
        clearScreen();
        currentDocId = rowData ? rowData[0] : null;
        const cap = str => capitalizeWords((str || '').trim());
        const groupOptions = ['Sales Product', 'Purchase Product'];
        const content = `
            <input id="spgroup" placeholder="Select Group"
                class="block w-[350px] max-w-full mb-2 px-3 py-2.5 text-base border rounded text-[18px]"
                value="${rowData ? cap(rowData[7]) : ''}">

            <input id="product" placeholder="Product Name" type="text"
                   value="${rowData ? cap(rowData[8]) : ''}"
                   class="block w-[350px] max-w-full mb-2 px-3 py-2 text-base border rounded text-[18px]" />

            <input id="opstk" type="number" placeholder="Opening Stock" value="${rowData?.[6] || ''}"
                       class="block w-[350px] max-w-full mb-2 px-3 py-2 text-base border rounded text-[18px]" />
            <button onclick="saveProduct()" class="px-20 py-2.5 mt-4 bg-green-700 hover:bg-green-900 text-white rounded">üíæ Save</button>
        `;
        document.getElementById("widget-area").innerHTML = content;
        generateDropdown("spgroup", ["Sales Product", "Purchase Product"], rowData?.[7] || "");
        bindAutoCapitalizeTo("#product");
    };

    window.saveProduct = async function (type) {
        const spgroup = capitalizeWords(document.getElementById("spgroup").value.trim());
        const product = capitalizeWords(document.getElementById("product").value.trim());
        const opstock = parseFloat(document.getElementById("opstk").value);

        if (!spgroup || !product) {
            alert("Please enter both Product Group and Product Name.");
            return;
        }

        const snapshot = await getDocs(collection(db, "tran"));
        let isDuplicate = false;

        snapshot.forEach(doc => {
            const data = doc.data();
            const docId = doc.id;

            const sameGroupAndName =
                data.grp?.toLowerCase() === spgroup.toLowerCase() &&
                data.name?.toLowerCase() === product.toLowerCase();

            const sameName =
                data.name?.toLowerCase() === product.toLowerCase();

            if ((sameGroupAndName || sameName) && docId !== currentDocId) {
                isDuplicate = true;
            }
        });

        if (isDuplicate) {
            alert("Product already exists in the same group or with same name.");
            return;
        }

        try {
            if (currentDocId) {
                const docRef = doc(db, "tran", currentDocId);
                await updateDoc(docRef, {
                    grp: spgroup,
                    name: product,
                    amt: opstock
                });
            } else {
                await addDoc(collection(db, "tran"), {
                    ttype: "Opening Stock",
                    grp: spgroup,
                    name: product,
                    amt: opstock
                });
            }
        } catch (error) {
            console.error("Error saving product:", error);
            alert("Failed to save product.");
        }
        loadDataIntoTable();
        window.showProductForm(type);
    };

    window.showLedgerForm = async function (type = 'Opening Balance', rowData = null) {
        clearScreen();
        currentDocId = rowData ? rowData[0] : null;

        const inputClass = "block w-[350px] max-w-full mb-2 px-3 py-2 text-base border rounded text-[18px]";
        const cap = str => capitalizeWords((str || '').trim());
        const ledgerGroupOptions = (window.grp_list || []).map(opt => opt.trim());

        const content = `
            ${generateDropdown("ledgerGroup", ledgerGroupOptions, rowData?.[7], inputClass)}
            <input id="ledger" placeholder="Ledger Name" type="text"
                   value="${rowData ? cap(rowData[8]) : ''}"
                   class="block w-[350px] max-w-full mb-2 px-3 py-2.5 text-base border rounded text-[18px]"
                   ${!rowData ? 'oninput="this.value = capitalizeWords(this.value)"' : ''} />

            <input id="obj" type="number" placeholder="Opening Balance Jama"
                   value="${rowData?.[6] || ''}"
                   class="block w-[350px] max-w-full mb-2 px-3 py-2.5 text-base border rounded text-[18px]" />

            <input id="obk" type="number" placeholder="Opening Balance Khate"
                   value="${rowData?.[6] || ''}"
                   class="block w-[350px] max-w-full mb-2 px-3 py-2.5 text-base border rounded text-[18px]" />

            <button onclick="saveLedger()" class="px-20 py-2.5 mt-4 bg-green-700 hover:bg-green-900 text-white rounded">üíæ Save</button>
        `;

        document.getElementById("widget-area").innerHTML = content;
    };

    window.saveLedger = async function (type) {
        const ledger = capitalizeWords(document.getElementById("ledger").value.trim());
        const ledgerGroup = capitalizeWords(document.getElementById("ledgerGroup").value.trim());
        const obj = parseFloat(document.getElementById("obj").value.trim()) || 0;
        const obk = parseFloat(document.getElementById("obk").value.trim()) || 0;

        if (!ledger || !ledgerGroup) {
            alert("Please enter both Ledger Name and Ledger Group.");
            return;
        }

        if ((obj > 0 && obk > 0) || (obj === 0 && obk === 0)) {
            alert("Enter either Opening Dr or Cr, not both or none.");
            return;
        }

        const snapshot = await getDocs(collection(db, "tran"));
        let isDuplicate = false;

        snapshot.forEach(doc => {
            const data = doc.data();
            const docId = doc.id;

            if (data.name?.toLowerCase() === ledger.toLowerCase() && docId !== currentDocId) {
                isDuplicate = true;
            }
        });

        if (isDuplicate) {
            alert("Ledger with this name already exists.");
            return;
        }

        const amt = obj || obk;
        const fparty = obj > 0 ? ledger : "";
        const tparty = obk > 0 ? ledger : "";

        const docData = {
            ttype: "Opening Balance",
            name: ledger,
            grp: ledgerGroup,
            fparty,
            tparty,
            amt
        };

        try {
            if (currentDocId) {
                await updateDoc(doc(db, "tran", currentDocId), docData);
            } else {
                await addDoc(collection(db, "tran"), docData);
            }
        } catch (error) {
            alert("Failed to save ledger.");
        }
        loadDataIntoTable();
        window.showLedgerForm(type);
    };

    //  VIEWS  ////////////////////////////////////////////////////////////////////////////////////
    function renderTable(tableId, columns, rows, widths, aligns) {
        const container = document.getElementById(tableId);
        container.innerHTML = "";
        // Create table element
        const table1 = document.createElement("table");
        table1.id = "dynamic-table";
        table1.className = "display nowrap";
        table1.style.width = "100%";

        // Create table header
        const thead = document.createElement("thead");
        const trHead = document.createElement("tr");
        columns.forEach(col => {
            const th = document.createElement("th");
            th.innerText = col;
            trHead.appendChild(th);
        });
        thead.appendChild(trHead);
        table1.appendChild(thead);

        // Create table body
        const tbody = document.createElement("tbody");
        rows.forEach(row => {
            const tr = document.createElement("tr");
            columns.forEach(col => {
                const td = document.createElement("td");
                td.innerText = row[col] || "";
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });
        table1.appendChild(tbody);

        container.appendChild(table1);

        // Initialize DataTable
        $(document).ready(function () {
            $("#dynamic-table").DataTable({
                dom: "Bfrtip",
                buttons: ["excel", "pdf", "print"],
                responsive: true,
                destroy: true // ‚úÖ Allows rerendering
            });
        });

    }
    function regularTable(tableId, columns, rows, widths, aligns) {
        const table = document.getElementById(tableId);
        table.innerHTML = ""; // Clear previous content
        table.style.borderCollapse = "collapse";
        table.style.width = "100%";

        // Header Row
        const header = document.createElement("tr");
        columns.forEach((col, i) => {
            const th = document.createElement("th");
            th.innerText = col;
            th.style.width = widths[i];
            th.style.textAlign = aligns[i];
            th.style.border = "1px solid black";
            th.style.padding = "6px";
            th.style.backgroundColor = "#1976D2";
            th.style.color = "white";
            header.appendChild(th);
        });
        table.appendChild(header);

        // Data Rows
        rows.forEach(row => {
            const tr = document.createElement("tr");

            columns.forEach((col, i) => {
                const td = document.createElement("td");
                td.innerText = row[col] || "";
                td.style.textAlign = aligns[i];
                td.style.border = "1px solid black";
                td.style.padding = "6px";
                tr.appendChild(td);
            });

            table.appendChild(tr);
        });
    }

    window.viewGroupsAndAccounts = async function () {
        const tranCol = collection(db, "tran");
        const snapshot = await getDocs(tranCol);
        let rows = [];

        snapshot.forEach(doc => {
            const data = doc.data();
            if (data.grp && data.name) {
                rows.push({Groups: data.grp || "", Accounts: data.name || ""});
            }
        });

        rows.sort((a, b) => {
            return a.Accounts.toLowerCase().localeCompare(b.Accounts.toLowerCase());
        });

        renderTable("widget-area", ["Groups", "Accounts"], rows, ["250px", "250px"], ["left", "left"]);
    }

    window.viewProducts = async function () {
        const tranCol = collection(db, "tran");
        const snapshot = await getDocs(tranCol);
        let rows = [];

        snapshot.forEach(doc => {
            const data = doc.data();

            // Only include if grp is "Sales" or "Purchase"
            if (
                data.grp &&
                data.name &&
                (data.grp.toLowerCase() === "sales products" || data.grp.toLowerCase() === "purchase products")
            ) {
                rows.push({Group: data.grp || "", Product: data.name || ""});
            }
        });

        // Sort alphabetically by product name
        rows.sort((a, b) => a.Product.toLowerCase().localeCompare(b.Product.toLowerCase()));
        renderTable("widget-area", ["Group", "Product"], rows, ["250px", "250px"], ["left", "left"]);
    }

    window.viewReceivables = async function () {
        const tranCol = collection(db, "tran");
        const snapshot = await getDocs(tranCol);

        const ledgerGroups = {};
        const balances = {};
        snapshot.forEach(doc => {
            const data = doc.data();
            const name = (data.name || "").trim().toLowerCase();
            const grp = (data.grp || "").trim().toLowerCase();

            if (name && grp) {
                ledgerGroups[name] = grp;
            }
        });
        snapshot.forEach(doc => {
            const data = doc.data();

            if (data.fparty) {
                const party = data.fparty.trim().toLowerCase();
                balances[party] = (balances[party] || 0) + parseFloat(data.amt || "0");
            }
            if (data.tparty) {
                const party = data.tparty.trim().toLowerCase();
                balances[party] = (balances[party] || 0) - parseFloat(data.amt || "0");
            }
        });
        const allowedGroups = ["creditors", "debitors", "bank", "angadiya"];
        const rows = [];

        for (const [party, amount] of Object.entries(balances)) {
            const grp = ledgerGroups[party];
            if (amount < 0 && grp && allowedGroups.includes(grp)) {
                rows.push({
                    Party: capitalizeWords(party),
                    Amount: Math.abs(amount).toFixed(0)
                });
            }
        }
        rows.sort((a, b) => b.Amount - a.Amount);
        renderTable("widget-area", ["Party", "Amount"], rows, ["200px", "100px"], ["left", "right"]);
    }

    window.viewPayables = async function () {
        const tranCol = collection(db, "tran");
        const snapshot = await getDocs(tranCol);
        const ledgerGroups = {};
        const balances = {};

        snapshot.forEach(doc => {
            const data = doc.data();
            const name = (data.name || "").trim().toLowerCase();
            const grp = (data.grp || "").trim().toLowerCase();

            if (name && grp) {
                ledgerGroups[name] = grp;
            }
        });
        snapshot.forEach(doc => {
            const data = doc.data();

            if (data.fparty) {
                const party = data.fparty.trim().toLowerCase();
                balances[party] = (balances[party] || 0) + parseFloat(data.amt || "0");
            }

            if (data.tparty) {
                const party = data.tparty.trim().toLowerCase();
                balances[party] = (balances[party] || 0) - parseFloat(data.amt || "0");
            }
        });
        const allowedGroups = ["creditors", "debitors", "bank", "angadiya"];
        const rows = [];
        for (const [party, amount] of Object.entries(balances)) {
            const grp = ledgerGroups[party];
            if (amount > 0 && grp && allowedGroups.includes(grp)) {
                rows.push({
                    Party: capitalizeWords(party),
                    Amount: amount.toFixed(0)
                });
            }
        }
        rows.sort((a, b) => b.Amount - a.Amount);
        renderTable("widget-area", ["Party", "Amount"], rows, ["200px", "100px"], ["left", "right"]);
    }

    window.showKhatavahiForm = async function () {
        clearScreen();
        const inputClass = "block w-[350px] max-w-full mb-2 px-3 py-2.5 text-base border rounded text-[18px]";
        const namesOptions = (window.allnames_list || []).map(opt => opt.trim());
        const dropdownHtml = generateDropdown("names", namesOptions, "", inputClass);
        const content = `
            <input id="fDate" placeholder="Start Date" type="date" class="${inputClass}" />
            <input id="tDate" placeholder="End Date" type="date" class="${inputClass}" />
            ${dropdownHtml}
            <button onclick="window.khatavahi()" class="px-20 py-2.5 mt-4 bg-green-700 hover:bg-green-900 text-white rounded">
                ‚è≥ View Khatavahi
            </button>
            <div id="kh-table" class="mt-6"></div>
        `;
        document.getElementById("widget-area").innerHTML = content;
    };

    window.khatavahi = async function () {
        const fromDate = document.getElementById("fDate").value;
        const toDate = document.getElementById("tDate").value;
        const partyName = capitalizeWords(document.getElementById("names").value.trim());

        if (!fromDate || !toDate || !partyName) {
            alert("Please select dates and party.");
            return;
        }
        const fDate = fromDate;
        const tDate = toDate;

        try {
            const tranCol = collection(db, "tran");
            const snapshot = await getDocs(tranCol);
            let opBal = 0;
            let transRows = [];

            snapshot.forEach(docSnap => {
                const data = docSnap.data();

                const date = data.date || "";
                const fparty = (data.fparty || "").trim().toLowerCase();
                const tparty = (data.tparty || "").trim().toLowerCase();
                const party = partyName.trim().toLowerCase();

                // Calculate opening balance
                if (date < fDate) {
                    if (fparty === party) {
                        opBal += Number(data.amt);
                    } else if (tparty === party) {
                        opBal -= Number(data.amt);
                    }
                }

                // Filter transactions between dates
                if (
                    date >= fDate &&
                    date <= tDate &&
                    (fparty === party || tparty === party)
                ) {
                    const formattedDate = data.date ? data.date.split("-")[2] + "-" + data.date.split("-")[1] + "-" + data.date.split("-")[0] : '';
                    transRows.push({
                        Date: formattedDate,
                        TranType: data.ttype || "",
                        From: data.fparty || "",
                        To: data.tparty || "",
                        Narration: data.nar || "",
                        Amount: Math.abs(Number(data.amt)).toFixed(0),
                    });
                }
            });

            let runningBal = opBal;
            let finalRows = [];

            // Opening balance row
            let opLabel = "Opening Balance";
            if (opBal < 0) opLabel += " Dr";
            else if (opBal > 0) opLabel += " Cr";

            finalRows.push({
                Date: "",
                TranType: "",
                From: opLabel,
                To: "",
                Narration: "",
                Amount: Math.abs(opBal).toFixed(0),
                ID: ""
            });

            // Transaction rows
            transRows.forEach(tran => {
                if (tran.From?.toLowerCase() === partyName.toLowerCase()) {
                    runningBal += Number(tran.Amount);
                } else if (tran.To?.toLowerCase() === partyName.toLowerCase()) {
                    runningBal -= Number(tran.Amount);
                }
                finalRows.push(tran);
            });

            // Closing balance row
            let clLabel = "Closing Balance";
            if (runningBal < 0) clLabel += " Dr";
            else if (runningBal > 0) clLabel += " Cr";

            finalRows.push({
                Date: "",
                TranType: "",
                From: clLabel,
                To: "",
                Narration: "",
                Amount: Math.abs(runningBal).toFixed(0),
                ID: ""
            });
            const header = ["Date", "TranType", "From", "To", "Narration", "Amount"];
            const widths = ["100px", "200px", "200px", "200px", "200px", "100px"];
            const aligns = ["left", "left", "left", "left", "left", "right"];
            regularTable("kh-table", header, finalRows, widths, aligns);

        } catch (error) {
            alert("An error occurred while loading the khatavahi.");
        }
    }

    window.showPLForm = async function () {
        clearScreen();
        const inputClass = "block w-[350px] max-w-full mb-2 px-3 py-2.5 text-base border rounded text-[18px]";
        const content = `
        <input id="fromDate" placeholder="Start Date" type="date" class="${inputClass}" />
        <input id="toDate" placeholder="End Date" type="date" class="${inputClass}" />
        <input id="closingStock" placeholder="Closing Stock" type="number" class="${inputClass}" />
        <button onclick="window.profit_loss()" class="px-20 py-2.5 mt-4 bg-green-700 hover:bg-green-900 text-white rounded">‚è≥ Profit & Loss</button>
        <div id="pl-table" class="mt-6"></div>
    `;
        document.getElementById("widget-area").innerHTML = content;
    };

    window.profit_loss = async function () {
        const fromDate = document.getElementById("fromDate").value;
        const toDate = document.getElementById("toDate").value;
        const closingStock = parseFloat(document.getElementById("closingStock").value || 0);

        const tranCol = collection(db, "tran");
        const snapshot = await getDocs(tranCol);
        let openingStock = 0;
        let purchase = 0;
        let expense = 0;
        let sales = 0;

        snapshot.forEach(doc => {
            const data = doc.data();
            const tranDate = data.date || "";
            const rawAmount = data.amt;
            const ttype = (data.ttype || "").toLowerCase();

            if (rawAmount === undefined || rawAmount === null || rawAmount === '') return;
            const amount = parseFloat(rawAmount);
            if (isNaN(amount)) return;

            if (fromDate && toDate) {
                if (tranDate < fromDate || tranDate > toDate) {
                    return;
                }
            }

            if (ttype === "opening stock") {
                openingStock += amount;
            } else if (ttype === "purchase") {
                purchase += amount;
            } else if (ttype === "expense") {
                expense += amount;
            } else if (ttype === "sales") {
                sales += amount;
            }
        });

        const debitTotal = openingStock + purchase + expense;
        const creditTotal = sales + closingStock;
        const profit = creditTotal - debitTotal;

        const rows = [
            {Description: "Opening Stock", Amount: openingStock.toFixed(0), index: 1},
            {Description: "Purchase", Amount: purchase.toFixed(0), index: 2},
            {Description: "Expense", Amount: expense.toFixed(0), index: 3},
            {Description: "Total (Op+Pur+Exp)", Amount: debitTotal.toFixed(0), index: 4},
            {Description: "Sales", Amount: sales.toFixed(0), index: 5},
            {Description: "Closing Stock", Amount: closingStock.toFixed(0), index: 6},
            {Description: "Total (Sales+Clo)", Amount: creditTotal.toFixed(0), index: 7},
            {Description: "Profit / Loss", Amount: profit.toFixed(0), index: 8}
        ];
        rows.sort((a, b) => a.index - b.index);
        const cleanedRows = rows.map(({index, ...rest}) => rest);
        regularTable("pl-table", ["Description", "Amount"], cleanedRows, ["70%", "30%"], ["left", "right"]);
    }

    window.updateCashLabel = async function () {
        const tranCol = collection(db, "tran");
        const snapshot = await getDocs(tranCol);
        let inflow = 0;
        let outflow = 0;
        snapshot.forEach(doc => {
            const data = doc.data();
            if (data.tparty === "Cash On Hand") {
                inflow += Number(data.amt || 0);
            }
            if (data.fparty === "Cash On Hand") {
                outflow += Number(data.amt || 0);
            }
        });
        const balance = inflow - outflow;
        document.getElementById("cashLabel").textContent = `Cash: ‚Çπ${balance.toFixed(0)}`;
    }

    window.addEventListener('DOMContentLoaded', async () => {
        await loadDropdownData();
        updateCashLabel();
        loadDataIntoTable();
    });

</script>
</body>
</html>
