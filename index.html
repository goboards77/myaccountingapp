<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Firebase Login UI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" rel="stylesheet"/>
    <link href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css" rel="stylesheet"/>
    <style>
        body {
            font-family: 'Arial', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
        }

        .error {
            color: red;
            margin-top: 10px;
        }

        .small-link {
            margin-top: 10px;
            display: block;
        }

        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 1020;
            background-color: #f8f9fa;
            border-bottom: 1px solid #ccc;
        }

        input {
            margin-top: 5px;
            padding: 8px;
            width: 100%;
            box-sizing: border-box;
            border-radius: 5px;
            height: 40px;
            border: 2px solid #ccc;
            font-family: inherit;
        }

        .action-button {
            background-color: #28a745;
            cursor: pointer;
            color: #fff;
            border-radius: 8px;
            margin-top: 25px;
            height: 40px;
            width: 100%;
            float: right;
            font-family: inherit;
        }

        .action-button:hover {
            background-color: #a67b05;
        }

        .del-action-button {
            background-color: #ba0612;
            cursor: pointer;
            color: #fff;
            border-radius: 8px;
            margin: 15px 1px 25px 1px;
            height: 40px;
            width: 100%;
            float: right;
            font-family: inherit;
        }

        .del-action-button:hover {
            background-color: #28a745;
        }

        .dropdown-container {
            font-family: inherit;
            position: absolute;
            background-color: black;
            border: 1px solid #ccc;
            max-height: 300px;
            overflow-y: auto;
            z-index: 999;
            color: #FFFFFF;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .dropdown-container div {
            padding: 5px 1px 1px 20px;
            cursor: pointer;
            width: 320px;
            border-radius: 8px;
        }

        .dropdown-container div:hover {
            background-color: #5a5c46;
        }

        .mainmenu-button {
            background-color: #2e4154;
            color: #ffffff;
        }

        .mainmenu-button:not(.collapsed) {
            background-color: #34495e;
            color: #ffffff;
        }

    </style>
</head>

<body>
<!-- üîê LOGIN FORM -->
<div class="container mt-5" id="loginContainer" style="display: none;">
    <h2>Login</h2>
    <input class="form-control mb-2" id="loginEmail" placeholder="Email" type="email">
    <input class="form-control mb-2" id="loginPassword" placeholder="Password" type="password">
    <button class="btn btn-primary" onclick="login()">Login</button>
    <div class="error" id="loginError"></div>
    <a href="#" onclick="event.preventDefault(); showRegister();">Don‚Äôt have an account? Register</a>
</div>

<!-- üÜï REGISTER FORM -->
<div class="container mt-5" id="registerContainer" style="display: none;">
    <h2>Register</h2>
    <input class="form-control mb-2" id="registerEmail" placeholder="Email" type="email">
    <input class="form-control mb-2" id="registerPassword" placeholder="Password" type="password">
    <button class="btn btn-success" onclick="register()">Register</button>
    <div class="error" id="registerError"></div>
    <div class="small-link">
        <a href="#" onclick="event.preventDefault(); showLogin();">Already have an account? Login</a>
    </div>
</div>

<!-- ‚úÖ MAIN APP CONTENT -->
<div class="container mt-3" id="appContent" style="display: none;">
    <!-- MENU -->
    <div class="sticky-header">
        <div class="accordion" id="menuAccordion">
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed mainmenu-button" data-bs-target="#collapseMain" data-bs-toggle="collapse"
                            onclick="hideAllViews()" style="height: 40px" type="button">‚ò∞ Main Menu
                    </button>
                </h2>
                <div class="accordion-collapse collapse" data-bs-parent="#menuAccordion" id="collapseMain">
                    <div class="accordion-body">
                        <button class="btn btn-outline-success w-100 mb-2" onclick="showView('transaction')">Transaction</button>
                        <button class="btn btn-outline-primary w-100 mb-2" onclick="loadAccounts()">Accounts</button>
                        <button class="btn btn-outline-success w-100 mb-2" onclick="loadDaybook()">Daybook</button>
                        <button class="btn btn-danger w-100" onclick="logout()">Logout</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN CONTAINER -->
    <div class="container mt-3">
        <!-- Transaction -->
        <div class="view-section d-none" id="transaction">
            <input autocomplete="off" id="TranId" placeholder="Id To Delete" type="number">
            <button class="del-action-button" id="DeleteTranButton">üö® Delete Transaction</button>
            <br><br>

            <input autocomplete="off" id="TranDate" placeholder="Transaction Date" type="date">
            <input autocomplete="off" id="TranTtype" placeholder="Transaction Type" type="text">
            <div class="dropdown-container" id="TranTtype-dropdown"></div>
            <input autocomplete="off" id="TranFparty" placeholder="From Party/Product" type="text">
            <div class="dropdown-container" id="TranFparty-dropdown"></div>
            <input autocomplete="off" id="TranTparty" placeholder="To Party/Product/Expense type" type="text">
            <div class="dropdown-container" id="TranTparty-dropdown"></div>
            <input autocomplete="off" id="TranAmount" placeholder="Amount" type="number">
            <input id="TranNar" placeholder="Details" type="text">
            <button class="action-button" id="SaveTranButton">üíæ Save Transaction</button>
        </div>

        <!-- Accounts -->
        <div class="view-section d-none" id="accountsView">
            <h4>Accounts</h4>
            <table class="table table-striped table-bordered w-100 display nowrap" id="accountsTable">
                <thead></thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Daybook -->
        <div class="view-section d-none" id="daybookView">
            <h4>Daybook Entries</h4>
            <table class="table table-striped table-bordered w-100 display nowrap" id="daybookTable">
                <thead></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<!-- jQuery & Bootstrap -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- DataTables -->
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.print.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>

<!-- üîå Firebase & App Logic -->
<script type="module">
    import {initializeApp} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";

    import {
        getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    import {
        getFirestore, collection, getDocs, updateDoc, deleteDoc, addDoc, query, where, orderBy, limit, doc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDQWZC6iA5zYKvTXsFl9TYLkZCTl5BzfwA",
        authDomain: "accounts-19d08.firebaseapp.com",
        projectId: "accounts-19d08",
        storageBucket: "accounts-19d08.appspot.com",
        messagingSenderId: "247308606105",
        appId: "1:247308606105:web:9bfc179368524244bf3608"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const loginContainer = document.getElementById('loginContainer');
    const registerContainer = document.getElementById('registerContainer');
    const appContent = document.getElementById('appContent');

    onAuthStateChanged(auth, user => {
        if (user) {
            loginContainer.style.display = 'none';
            registerContainer.style.display = 'none';
            appContent.style.display = 'block';
            document.querySelectorAll("input[type='text']").forEach(input => {
                input.addEventListener("input", (e) => {
                    const cursorPos = input.selectionStart;
                    input.value = capitalizeWords(input.value);
                    input.setSelectionRange(cursorPos, cursorPos);
                });
            });
        } else {
            loginContainer.style.display = 'block';
            registerContainer.style.display = 'none';
            appContent.style.display = 'none';
        }
    });

    window.login = async function () {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        const errorDiv = document.getElementById('loginError');
        errorDiv.textContent = '';

        try {
            await signInWithEmailAndPassword(auth, email, password);
        } catch (error) {
            errorDiv.textContent = error.message;
        }
    }

    window.register = async function () {
        const email = document.getElementById('registerEmail').value;
        const password = document.getElementById('registerPassword').value;
        const errorDiv = document.getElementById('registerError');
        errorDiv.textContent = '';

        try {
            await createUserWithEmailAndPassword(auth, email, password);
        } catch (error) {
            errorDiv.textContent = error.message;
        }
    }

    window.logout = async function () {
        await signOut(auth);
    }

    window.showRegister = function () {
        loginContainer.style.display = 'none';
        registerContainer.style.display = 'block';
    }

    window.showLogin = function () {
        loginContainer.style.display = 'block';
        registerContainer.style.display = 'none';
    }

    window.hideAllViews = function () {
        document.querySelectorAll('.view-section').forEach(v => v.classList.add('d-none'));
    }

    function showView(viewId) {
        hideAllViews();
        document.getElementById(viewId).classList.remove('d-none');

        if (viewId === 'transaction') {
            initTransactionDropdowns();
        }

        const collapseMenu = bootstrap.Collapse.getOrCreateInstance(document.getElementById('collapseMain'));
        collapseMenu.hide();
    }

    function capitalizeWords(str) {
        return str.replace(/\b\w/g, c => c.toUpperCase());
    }

    function clearTransactionForm() {
        ["TranDate", "TranTtype", "TranFparty", "TranTparty", "TranAmount", "TranNar", "TranId"].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = "";
        });
    }

    window.ttype_list = ['Sales', 'Purchase', 'Receipt', 'Payment'];
    window.allnames_list = [];

    // Fetch allnames_list from Firebase
    async function loadDropdownData() {
        const snapshot = await getDocs(collection(db, "tran"));
        const nameSet = new Set();

        snapshot.forEach(doc => {
            const name = (doc.data().name || "").trim();
            if (name) nameSet.add(name);
        });

        window.allnames_list = [...nameSet].sort((a, b) => a.localeCompare(b));

    }

    // Show dropdown suggestions
    function setupDropdown(inputId, dropdownId, dataList) {
        const input = document.getElementById(inputId);
        const dropdown = document.getElementById(dropdownId);

        // Common logic to filter and show suggestions
        function showSuggestions(query) {
            dropdown.innerHTML = "";

            const matches = dataList
                .filter(item => item.toLowerCase().includes(query.toLowerCase()))

            matches.forEach(item => {
                const div = document.createElement("div");
                div.className = "dropdown-item";
                div.textContent = item;
                div.onclick = () => {
                    input.value = item;
                    dropdown.innerHTML = "";
                    dropdown.style.display = "none";
                };
                dropdown.appendChild(div);
            });

            dropdown.style.display = matches.length > 0 ? "block" : "none";
        }

        // Show suggestions on typing
        input.addEventListener("input", () => {
            showSuggestions(input.value);
        });

        // ‚úÖ Show all suggestions on click
        input.addEventListener("click", () => {
            showSuggestions(""); // pass empty to show all
        });

        // Hide dropdown after losing focus
        input.addEventListener("blur", () => {
            setTimeout(() => {
                dropdown.style.display = "none";
            }, 200); // short delay for click to register
        });
    }

    // Call this when opening the transaction form
    async function initTransactionDropdowns() {
        await loadDropdownData();

        setupDropdown("TranTtype", "TranTtype-dropdown", ttype_list);
        setupDropdown("TranFparty", "TranFparty-dropdown", allnames_list);
        setupDropdown("TranTparty", "TranTparty-dropdown", allnames_list);
    }

    async function saveTransaction() {
        console.log("allnames_list", window.allnames_list); // should show 12
        const date = document.getElementById("TranDate").value.trim();
        const ttype = document.getElementById("TranTtype").value.trim();
        const fparty = document.getElementById("TranFparty").value.trim();
        const tparty = document.getElementById("TranTparty").value.trim();
        const amtStr = document.getElementById("TranAmount").value.trim();
        const nar = document.getElementById("TranNar").value.trim();

        if (!date || !ttype || !fparty || !tparty || !amtStr) {
            alert("‚ö†Ô∏è Please fill all required fields.");
            return;
        }

        const amt = parseFloat(amtStr);
        if (isNaN(amt)) {
            alert("‚ö†Ô∏è Amount must be a valid number.");
            return;
        }

        const tranCol = collection(db, "tran");

        // Step 1: Get max existing id and existing names
        const snapshot = await getDocs(tranCol);
        let maxId = 0;
        const existingNames = new Set();

        snapshot.forEach(doc => {
            const data = doc.data();
            if (typeof data.id === "number") {
                maxId = Math.max(maxId, data.id);
            }
            if (data.name) {
                existingNames.add(data.name.trim());
            }
        });

        const newId = maxId + 1;

        // Step 2: Save the main transaction
        const tranData = {
            id: newId,
            date,
            ttype,
            fparty,
            tparty,
            nar,
            amt
        };

        await addDoc(tranCol, tranData);
        alert("‚úÖ Transaction saved with ID " + newId);

        // Step 3: Add fparty if not in existing names
        if (!existingNames.has(fparty)) {
            await addDoc(tranCol, {
                name: fparty
            });
        }

        // Step 4: Add tparty if not in existing names
        if (!existingNames.has(tparty)) {
            await addDoc(tranCol, {
                name: tparty
            });
        }

        clearTransactionForm();
    }

    async function deleteTransaction() {
        const idStr = document.getElementById("TranId").value.trim();
        const id = parseInt(idStr);

        if (isNaN(id)) {
            alert("‚ö†Ô∏è Please enter a valid numeric Transaction ID.");
            return;
        }

        const tranCol = collection(db, "tran");
        const q = query(tranCol, where("id", "==", id));
        const snapshot = await getDocs(q);

        if (snapshot.empty) {
            alert("‚ö†Ô∏è No transaction found with ID " + id);
            return;
        }

        for (const docSnap of snapshot.docs) {
            await deleteDoc(docSnap.ref);
        }

        alert("üóëÔ∏è Transaction with ID " + id + " deleted.");
        clearTransactionForm();
    }

    function renderTable(targetId, columns, data, options = {}) {
        const table = $('#' + targetId);

        if ($.fn.DataTable.isDataTable('#' + targetId)) {
            table.DataTable().destroy();
        }

        table.find('thead').empty();
        table.find('tbody').empty();

        let theadHtml = '<tr>' + columns.map(col => `<th>${col}</th>`).join('') + '</tr>';
        table.find('thead').html(theadHtml);

        let tbodyHtml = '';
        data.forEach(row => {
            tbodyHtml += '<tr>' + row.map(cell => `<td>${cell}</td>`).join('') + '</tr>';
        });
        table.find('tbody').html(tbodyHtml);

        table.DataTable({
            responsive: true,
            pageLength: 10,
            dom: 'Bfrtip',
            buttons: ['excel', 'pdf', 'print'],
            columnDefs: options.columnDefs || []
        });
    }

    window.loadAccounts = async function () {
        const snapshot = await getDocs(collection(db, "tran"));
        const columns = ['Names'];
        const data = [];

        snapshot.forEach(doc => {
            const d = doc.data();
            if (d.name) {
                data.push([d.name]);
            }
        });

        showView('accountsView');
        renderTable("accountsTable", columns, data)
    }

    function formatDateToDDMMYYYY(dateStr) {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        const dd = String(date.getDate()).padStart(2, '0');
        const mm = String(date.getMonth() + 1).padStart(2, '0');
        const yyyy = date.getFullYear();
        return `${dd}-${mm}-${yyyy}`;
    }

    window.loadDaybook = async function () {
        const snapshot = await getDocs(collection(db, "tran"));
        const columns = ['ID', 'Date', 'Type', 'From Party', 'To Party', 'Narration', 'Amount'];
        const data = [];

        snapshot.forEach(doc => {
            const d = doc.data();
            if (d.id !== undefined) {
                data.push([
                    d.id,
                    formatDateToDDMMYYYY(d.date || ''),
                    d.ttype || '',
                    d.fparty || '',
                    d.tparty || '',
                    d.nar || '',
                    d.amt || '',
                ]);
            }
        });

        showView('daybookView');
        renderTable("daybookTable", columns, data)
    }

    window.showView = showView;
    document.getElementById("SaveTranButton").addEventListener("click", saveTransaction);
    document.getElementById("DeleteTranButton").addEventListener("click", deleteTransaction);

</script>
</body>
</html>
