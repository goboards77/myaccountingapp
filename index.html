<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sidenav Menu</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600&display=swap" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css" rel="stylesheet">

    <style>
        [x-cloak] {display: none !important;}
    </style>

    <!-- Define Alpine.js data component inside alpine:init event listener -->
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('formManager', () => ({
                dataReady: false,
                menuOpen: false,
                submenu: null,
                currentForm: '',
                formValues: {},
                visibleInputs: [],
                isFormVisible: false,
                visibleTable: false,
                editMode: false,
                currentDocId: null,

                init() {
                    window.alpineFormManager = this;

                    const wait = setInterval(() => {
                        if (window.formDataReady) {
                            this.dataReady = true;
                            clearInterval(wait);
                        }
                    }, 100);
                },

                setActiveView(activeViewProperty) {
                    const viewProperties = [
                        'isFormVisible',
                        'visibleTable',
                    ];

                    viewProperties.forEach(prop => {
                        if (prop === activeViewProperty) {
                            this[prop] = true;
                        } else {
                            this[prop] = false;
                        }
                    });
                    this.menuOpen = false;
                    this.submenu = null;
                },

                showForm(formName, initialValues = {}) {
                    this.setActiveView('isFormVisible');

                    if (Object.keys(initialValues).length === 0) {
                        this.editMode = false;
                        this.currentDocId = null;
                        this.formValues = {};
                        this.visibleInputs = [];
                    }

                    this.setForm(formName, initialValues);
                },

                setForm(formName, initialValues = {}) {
                    const formLayouts = {
                        group: [
                            {name: 'grp', label: 'Group Name', type: 'text'}
                        ],
                        ledger: [
                            {name: 'grp', label: 'Group Name', type: 'select', source: 'grp_list'},
                            {name: 'name', label: 'Ledger Name', type: 'text'},
                            {name: 'obj', label: 'Op Bal Jama', type: 'number'},
                            {name: 'obk', label: 'Op Bal Khate', type: 'number'},
                        ],
                        product: [
                            {name: 'grp', label: 'Group Name', type: 'select', source: 'sp_list'},
                            {name: 'name', label: 'Product Name', type: 'text'},
                            {name: 'ostk', label: 'Op Stock', type: 'number'},
                        ],
                        sales: [
                            {name: 'date', label: 'Sales Date', type: 'date'},
                            {name: 'ttype', label: 'Transaction Type', type: 'text', options: ['Sales'], disabled: true},
                            {name: 'fparty', label: 'Sales Product', type: 'select', source: 'sproduct_list'},
                            {name: 'tparty', label: 'Sold To Party', type: 'select', source: 'crdb_list'},
                            {name: 'amt', label: 'Sales Amount', type: 'number'},
                            {name: 'nar', label: 'Narration', type: 'text'}
                        ],
                        purchase: [
                            {name: 'date', label: 'Purchase Date', type: 'date'},
                            {name: 'ttype', label: 'Transaction Type', type: 'text', options: ['Purchase'], disabled: true},
                            {name: 'fparty', label: 'Purchased From', type: 'select', source: 'crdb_list'},
                            {name: 'tparty', label: 'Purchased Product', type: 'select', source: 'pproduct_list'},
                            {name: 'amt', label: 'Purchase Amount', type: 'number'},
                            {name: 'nar', label: 'Narration', type: 'text'}
                        ],
                        receipt: [
                            {name: 'date', label: 'Receipt Date', type: 'date'},
                            {name: 'ttype', label: 'Transaction Type', type: 'text', options: ['Receipt'], disabled: true},
                            {name: 'fparty', label: 'Received From', type: 'select', source: 'crdbcsbkang_list'},
                            {name: 'tparty', label: 'Paid To', type: 'select', source: 'crdbcsbkangexp_list'},
                            {name: 'amt', label: 'Receipt Amount', type: 'number'},
                            {name: 'nar', label: 'Narration', type: 'text'},
                        ],
                        payment: [
                            {name: 'date', label: 'Payment Date', type: 'date'},
                            {name: 'ttype', label: 'Transaction Type', type: 'text', options: ['Payment'], disabled: true},
                            {name: 'fparty', label: 'Paid From', type: 'select', source: 'crdbcsbkang_list'},
                            {name: 'tparty', label: 'Paid To', type: 'select', source: 'crdbcsbkangexp_list'},
                            {name: 'amt', label: 'Payment Amount', type: 'number'},
                            {name: 'nar', label: 'Narration', type: 'text'},
                        ],
                    };

                    this.currentForm = formName;
                    const layout = formLayouts[formName] || [];
                    this.visibleInputs = layout.map(field => {
                        if (field.type === 'select' && field.source) {
                            const optionsFromSource = Array.isArray(window[field.source]) ? window[field.source] : [];
                            return {
                                ...field,
                                options: optionsFromSource
                            };
                        } else if (field.type === 'select' && field.options) {
                            const hardcodedOptions = field.options;
                            return {
                                ...field,
                                options: hardcodedOptions
                            };
                        }
                        return field;
                    });

                    this.formValues = {...initialValues};

                    if (Object.keys(initialValues).length === 0) {
                        this.visibleInputs.forEach(f => {
                            if (f.type === 'select' && f.options.length === 1) {
                                this.formValues[f.name] = f.options[0];
                            } else if (f.type === 'text' && f.disabled && f.options && f.options.length === 1) {
                                this.formValues[f.name] = f.options[0];
                            }
                        });

                        if (['sales', 'purchase', 'receipt', 'payment'].includes(formName)) {
                            this.formValues.date = new Date().toISOString().slice(0, 10);
                            this.formValues.amt = '';
                            this.formValues.fparty = '';
                            this.formValues.tparty = '';
                            this.formValues.nar = '';
                        }
                    }
                },

                capitalize(fieldName) {
                    const fieldDef = this.visibleInputs.find(f => f.name === fieldName);

                    if (fieldDef && fieldDef.type === 'text' && typeof this.formValues[fieldName] === 'string') {
                        this.formValues[fieldName] = this.formValues[fieldName].split(' ')
                            .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                            .join(' ');
                    }
                },

                async getNextId() {
                    const snap = await window.getDocs(window.collection(window.db, `tran`));
                    let maxId = 0;
                    snap.forEach(doc => {
                        const data = doc.data();
                        if (data.id && typeof data.id === 'number') {
                            maxId = Math.max(maxId, data.id);
                        }
                    });
                    return maxId + 1;
                },

                async handleSave() {
                    let newIdentifier = '';
                    if (this.currentForm === 'group') {
                        newIdentifier = (this.formValues.grp || '').trim();
                    } else if (this.currentForm === 'ledger' || this.currentForm === 'product') {
                        newIdentifier = (this.formValues.name || '').trim();
                    }

                    if (newIdentifier) {
                        const existingDocsSnapshot = await window.getDocs(window.collection(window.db, `tran`));
                        let isDuplicate = false;

                        existingDocsSnapshot.forEach(doc => {
                            if (this.editMode && doc.id === this.currentDocId) {
                                return;
                            }

                            const data = doc.data();
                            if (data.name && (data.name || '').trim().toLowerCase() === newIdentifier.toLowerCase()) {
                                isDuplicate = true;
                                return;
                            }
                            if (data.grp && (data.grp || '').trim().toLowerCase() === newIdentifier.toLowerCase()) {
                                isDuplicate = true;
                                return;
                            }
                        });

                        if (isDuplicate) {alert("⚠️ Duplicate name."); return;}
                    }

                    const keys = Object.keys(this.formValues).filter(k => k !== 'nar');
                    let requiredKeys = keys;

                    if (this.currentForm === 'ledger') {
                        requiredKeys = requiredKeys.filter(k => k !== 'obj' && k !== 'obk');
                    } else if (this.currentForm === 'product') {
                        requiredKeys = requiredKeys.filter(k => k !== 'ostk');
                    } else if (['sales', 'purchase', 'receipt', 'payment'].includes(this.currentForm)) {
                        requiredKeys = ['date', 'fparty', 'tparty', 'amt'];
                    }

                    if (this.currentForm === 'ledger') {
                        if (!this.formValues.grp?.trim() || !this.formValues.name?.trim()) return alert("⚠️ Please select group & fill name.");

                        const objValue = Number(this.formValues.obj) || 0;
                        const obkValue = Number(this.formValues.obk) || 0;
                        if (objValue > 0 && obkValue > 0) {alert("⚠️ Fill Jama or Khate not both"); return;}
                    } else if (this.currentForm === 'product') {
                        if (!this.formValues.grp?.trim() || !this.formValues.name?.trim()) return alert("⚠️ Please select group & fill name.");
                    }

                    const allFilled = requiredKeys.every(k => this.formValues[k] !== undefined && this.formValues[k] !== '' && this.formValues[k] !== null);

                    if (!allFilled) {alert("⚠️ Please fill all required fields."); return;}

                    const docData = {...this.formValues};

                    if (!this.editMode) {docData.id = await this.getNextId();}

                    if (this.editMode && this.currentDocId) {
                        const originalDoc = window.daybookDataMap.get(this.currentDocId);
                        let oldValue = '';
                        let newValue = '';

                        if (this.currentForm === 'ledger' || this.currentForm === 'product') {
                            oldValue = originalDoc.name;
                            newValue = this.formValues.name;
                        } else if (this.currentForm === 'group') {
                            oldValue = originalDoc.grp;
                            newValue = this.formValues.grp;
                        }

                        if (oldValue && newValue && oldValue.toLowerCase() !== newValue.toLowerCase()) {
                            await window.updateRelatedNames(oldValue, newValue);
                        }
                    }

                    if (this.currentForm === 'ledger') {
                        const objValue = Number(this.formValues.obj) || 0;
                        const obkValue = Number(this.formValues.obk) || 0;
                        if (objValue > 0) {
                            docData.fparty = this.formValues.name;
                            docData.tparty = '';
                            docData.amt = objValue;
                        } else if (obkValue > 0) {
                            docData.tparty = this.formValues.name;
                            docData.fparty = '';
                            docData.amt = obkValue;
                        } else {
                            docData.fparty = '';
                            docData.tparty = '';
                            docData.amt = 0;
                        }
                        docData.ttype = 'Opening Balance';
                        delete docData.obj;
                        delete docData.obk;

                    } else if (this.currentForm === 'product') {
                        docData.ttype = 'Opening Stock';
                        docData.amt = Number(this.formValues.ostk) || 0;
                        docData.name = this.formValues.name;
                        docData.grp = this.formValues.grp;
                        delete docData.ostk;

                    } else if (this.currentForm === 'group') {
                        docData.ttype = 'Group';
                        docData.grp = this.formValues.grp;
                        docData.name = '';
                        docData.amt = 0;
                        docData.nar = '';
                        docData.date = '';
                        docData.fparty = '';
                        docData.tparty = '';
                    }

                    if (this.editMode && this.currentDocId) {
                        await window.updateDoc(window.doc(window.db, `tran`, this.currentDocId), docData);
                    } else {
                        await window.addDoc(window.collection(window.db, `tran`), docData);
                    }
                    this.formValues = {};
                    this.editMode = false;
                    this.currentDocId = null;
                    this.setForm(this.currentForm, {});

                    window.updateCashLabel();
                },

                async loadDaybook() {
                    this.setActiveView('visibleTable');
                    const snapshot = await window.getDocs(window.collection(window.db, `tran`));
                    const columns = ['FirestoreID', 'ID', 'Date', 'Type', 'From Party', 'To Party', 'Narration', 'Amount'];
                    const data = [];
                    window.daybookDataMap = new Map();

                    snapshot.forEach(doc => {
                        const d = doc.data();
                        window.daybookDataMap.set(doc.id, {...d, firestoreDocId: doc.id});
                        if (d.id !== undefined) {
                            data.push([
                                doc.id,
                                d.id,
                                window.formatDate(d.date || ''),
                                d.ttype || '',
                                d.fparty || '',
                                d.tparty || '',
                                d.nar || '',
                                d.amt || '',
                            ]);
                        }
                    });
                    window.renderTable("Table", columns, data, {
                        columnDefs: [{targets: 0, visible: false}]
                    });
                },

                async showReceivables() {
                    this.setActiveView('visibleTable');
                    await window.showReceivables();
                },

                async showGroupsAndAccounts() {
                    this.setActiveView('visibleTable');
                    await window.viewGroupsAndAccounts();
                },

                async showProducts() {
                    this.setActiveView('visibleTable');
                    await window.viewProducts();
                }
            }));
        });
    </script>

    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

</head>
<body style="font-family: 'Arial', Tahoma, Geneva, Verdana, sans-serif;" class="antialiased bg-gray-100 text-base sm:text-lg lg:text-xl" x-cloak x-data="formManager()">

<!-- 🔐 Login/Register Section -->
<div class="mt-20" id="authContainer" style="display: none;">
    <div class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-md" id="loginContainer">
        <h2 class="text-2xl font-bold mb-6 text-center text-blue-700">Login</h2>
        <input class="block w-full mb-4 p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" id="loginEmail"
               placeholder="Email" type="email">
        <input class="block w-full mb-4 p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" id="loginPassword"
               placeholder="Password" type="password">
        <button class="w-full bg-blue-600 text-white px-4 py-3 rounded-md mb-4 hover:bg-blue-700 transition duration-200" onclick="login()">Login
        </button>
        <div class="text-red-600 text-center mb-4" id="loginError"></div>
        <p class="text-center text-gray-600">Don’t have an account? <a class="text-blue-700 underline hover:text-blue-800" href="#"
                                                                       onclick="event.preventDefault(); showRegister();">Register</a></p>
    </div>

    <div class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-md" id="registerContainer" style="display:none;">
        <h2 class="text-2xl font-bold mb-6 text-center text-green-700">Register</h2>
        <input class="block w-full mb-4 p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" id="registerEmail"
               placeholder="Email" type="email">
        <input class="block w-full mb-4 p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
               id="registerPassword" placeholder="Password" type="password">
        <button class="w-full bg-green-600 text-white px-4 py-3 rounded-md mb-4 hover:bg-green-700 transition duration-200" onclick="register()">
            Register
        </button>
        <div class="text-red-600 text-center mb-4" id="registerError"></div>
        <p class="text-center text-gray-600">Already have an account? <a class="text-blue-700 underline hover:text-blue-800" href="#"
                                                                         onclick="event.preventDefault(); showLogin();">Login</a></p>
    </div>
</div>

<!-- ✅ Top Navbar -->
<div class="bg-blue-700 text-white shadow px-4 py-3 flex items-center fixed w-full top-0 z-40 h-14">
    <button @click="menuOpen = !menuOpen" class="text-2xl focus:outline-none">&#9776;</button>
    <span class="ml-4 text-lg sm:text-xl font-semibold">📘 MyApp</span>
    <span class="ml-4 text-lg sm:text-xl font-semibold" id="cashLabel"></span>
</div>

<!-- ✅ Sidebar And Subbuttons-->
<div @click.away="menuOpen = false"
     class="fixed left-0 top-14 w-full sm:w-64 bg-white shadow-lg p-3 space-y-4 z-30 border-r border-gray-200 overflow-y-auto max-h-[calc(100vh-3.5rem)]"
     x-show="menuOpen && dataReady"
     x-transition:enter="transition ease-out duration-300 transform"
     x-transition:enter-end="translate-x-0"
     x-transition:enter-start="-translate-x-full"
     x-transition:leave="transition ease-in duration-300 transform"
     x-transition:leave-end="-translate-x-full"
     x-transition:leave-start="translate-x-0">
    <div>
        <button @click="submenu === 'new' ? submenu = null : submenu = 'new'"
                class="w-full text-left px-4 py-3 bg-blue-100 hover:bg-blue-200 text-blue-800 font-semibold rounded-md transition duration-150 ease-in-out">
            ➕ New
        </button>
        <div class="ml-4 mt-2 space-y-1 text-sm text-gray-800 flex flex-col gap-2" x-show="submenu === 'new'"
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-end="opacity-100 transform translate-y-0"
             x-transition:enter-start="opacity-0 transform -translate-y-2">
            <a @click.prevent="showForm('group')"
               class="block px-2 py-2 rounded-md hover:bg-gray-100 font-semibold text-sm sm:text-base transition duration-150 ease-in-out" href="#">📁
                Group</a>
            <a @click.prevent="showForm('ledger')"
               class="block px-2 py-2 rounded-md hover:bg-gray-100 font-semibold text-sm sm:text-base transition duration-150 ease-in-out" href="#">📘
                Ledger</a>
            <a @click.prevent="showForm('product')"
               class="block px-2 py-2 rounded-md hover:bg-gray-100 font-semibold text-sm sm:text-base transition duration-150 ease-in-out" href="#">📦
                Product</a>
            <a @click.prevent="showForm('sales')"
               class="block px-2 py-2 rounded-md hover:bg-gray-100 font-semibold text-sm sm:text-base transition duration-150 ease-in-out" href="#">🛒
                Sales</a>
            <a @click.prevent="showForm('purchase')"
               class="block px-2 py-2 rounded-md hover:bg-gray-100 font-semibold text-sm sm:text-base transition duration-150 ease-in-out" href="#">🧾
                Purchase</a>
            <a @click.prevent="showForm('receipt')"
               class="block px-2 py-2 rounded-md hover:bg-gray-100 font-semibold text-sm sm:text-base transition duration-150 ease-in-out" href="#">💵
                Receipt</a>
            <a @click.prevent="showForm('payment')"
               class="block px-2 py-2 rounded-md hover:bg-gray-100 font-semibold text-sm sm:text-base transition duration-150 ease-in-out" href="#">💳
                Payment</a>
        </div>
    </div>

    <div>
        <button @click="submenu === 'view' ? submenu = null : submenu = 'view'"
                class="w-full text-left px-4 py-3 bg-blue-100 hover:bg-blue-200 text-blue-800 font-semibold rounded-md transition duration-150 ease-in-out">
            👁️ View
        </button>
        <div class="ml-4 mt-2 space-y-1 text-sm text-gray-800 flex flex-col gap-2" x-show="submenu === 'view'"
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-end="opacity-100 transform translate-y-0"
             x-transition:enter-start="opacity-0 transform -translate-y-2">
            <a @click="loadDaybook()"
               class="block px-2 py-2 rounded-md hover:bg-gray-100 font-semibold text-sm sm:text-base transition duration-150 ease-in-out" href="#">
                📘 Daybook</a>
            <a @click="showReceivables()"
               class="block px-2 py-2 rounded-md hover:bg-gray-100 font-semibold text-sm sm:text-base transition duration-150 ease-in-out" href="#">
                💰 Receivables</a>
            <a @click="showGroupsAndAccounts()"
               class="block px-2 py-2 rounded-md hover:bg-gray-100 font-semibold text-sm sm:text-base transition duration-150 ease-in-out" href="#">
                👥 Groups & Accounts</a>
            <a @click="showProducts()"
               class="block px-2 py-2 rounded-md hover:bg-gray-100 font-semibold text-sm sm:text-base transition duration-150 ease-in-out" href="#">
                📦 Products</a>
        </div>
    </div>

    <a @click="menuOpen = false; submenu = null; window.logout()"
       class="block px-4 py-3 bg-blue-100 hover:bg-blue-200 text-blue-800 font-semibold rounded-md transition duration-150 ease-in-out" href="#">🚪
        Logout</a>

</div>

<!-- ✅ Form & Table Display Area -->
<div class="relative z-10 mt-12 sm:p-4" id="widget-area" style="display: none;">
    <template x-if="!dataReady">
        <div class="flex justify-center items-center h-64">
            <p class="text-xl text-gray-600">Loading application data...</p>
        </div>
    </template>
    <template x-if="dataReady">
        <div class="max-w-full lg:max-4xl mx-auto bg-white p-6 rounded-lg shadow-md">

            <!-- FORM INPUT BLOCK -->
            <template x-if="isFormVisible">
                <div>
                    <h2 class="text-2xl font-bold mb-6 text-center text-blue-700"
                        x-text="currentForm.charAt(0).toUpperCase() + currentForm.slice(1) + ' Entry'"></h2>
                    <template :key="field.name" x-for="field in visibleInputs">
                        <div class="mb-4 max-w-md mx-auto">
                            <label class="block font-semibold mb-1 text-sm sm:text-base text-gray-700" x-text="field.label"></label>

                            <!-- Select dropdown -->
                            <template x-if="field.type === 'select'">
                                <select
                                        --}} :id="field.name + 'Select'" Added DOM ID
                                        class="w-full border border-gray-300 px-4 py-2.5 rounded-md text-base sm:text-lg lg:text-xl focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white"
                                        dynamic easier for querying
                                        x-model="formValues[field.name]"
                                        {{-->
                                    <option value="">Select...</option>
                                    <template :key="opt" x-for="opt in field.options">
                                        <option :selected="opt === formValues[field.name]" :value="opt" x-text="opt"></option>
                                    </template>
                                </select>
                            </template>

                            <!-- Other inputs -->
                            <template x-if="field.type !== 'select'">
                                <input
                                        --}}
                                        :disabled="field.disabled || false"
                                        :type="field.type" @input="capitalize(field.name)" Bind attribute
                                        class="w-full border border-gray-300 px-4 py-2.5 rounded-md text-base sm:text-lg lg:text-xl focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white"
                                        disabled
                                        x-model="formValues[field.name]"
                                        {{--/>
                            </template>
                        </div>
                    </template>

                    <!-- Save Button -->
                    <div class="max-w-md mx-auto">
                        <button @click="handleSave"
                                class="w-full bg-blue-600 text-white px-4 py-3 mt-4 rounded-md hover:bg-blue-700 text-base font-semibold transition duration-200">
                            <span x-text="editMode ? '💾 Update' : '💾 Save'"></span>
                        </button>
                    </div>

                </div>
            </template>

            <!-- Table -->
            <div x-show="visibleTable">
                <h2 class="text-2xl font-bold mb-6 text-center text-blue-700"></h2>
                <table class="display nowrap" id="Table" style="width:100%">
                    <thead></thead>
                    <tbody></tbody>
                </table>
            </div>

        </div>
    </template>
</div>

<!-- External JavaScript Libraries -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>


<!-- Firebase SDK -->
<script type="module">
    import {initializeApp} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
        getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, signInWithCustomToken
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
        getFirestore, collection, getDocs, updateDoc, deleteDoc, addDoc, query, where, orderBy, limit, doc, writeBatch // Added writeBatch
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDQWZC6iA5zYKvTXsFl9TYLkZCTl5BzfwA",
        authDomain: "accounts-19d08.firebaseapp.com",
        projectId: "accounts-19d08",
        storageBucket: "accounts-19d08.appspot.com",
        messagingSenderId: "247308606105",
        appId: "1:247308606105:web:9bfc179368524244bf3608"
    };
    window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    let app;
    let auth;
    let db;

    if (firebaseConfig && firebaseConfig.apiKey) {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        window.db = db;

        window.collection = collection;
        window.getDocs = getDocs;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.addDoc = addDoc;
        window.query = query;
        window.where = where;
        window.orderBy = orderBy;
        window.limit = limit;
        window.doc = doc;
        window.writeBatch = writeBatch;

        async function authenticateFirebase() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    document.getElementById("authContainer").style.display = "block";
                    document.getElementById("loginContainer").style.display = "block";
                    document.getElementById("registerContainer").style.display = "none";
                    document.getElementById("widget-area").style.display = "none";
                }
            } catch (error) {
                let errorMessage = "An unexpected authentication error occurred. Please try logging in with email/password.";
                if (error.code === "auth/network-request-failed") {
                    errorMessage = "Network error. Please check your internet connection and try again.";
                }
                alert( errorMessage);
                document.getElementById("authContainer").style.display = "block";
                document.getElementById("loginContainer").style.display = "block";
                document.getElementById("registerContainer").style.display = "none";
                document.getElementById("widget-area").style.display = "none";
            }
        }

        authenticateFirebase();
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById("authContainer").style.display = "none";
                document.getElementById("widget-area").style.display = "block";
                window.loadDropdownData();
                window.updateCashLabel();
            } else {
                document.getElementById("authContainer").style.display = "block";
                document.getElementById("loginContainer").style.display = "block";
                document.getElementById("registerContainer").style.display = "none";
                document.getElementById("widget-area").style.display = "none";
            }
        });

        window.showLogin = function () {
            document.getElementById("loginContainer").style.display = "block";
            document.getElementById("registerContainer").style.display = "none";
        };

        window.showRegister = function () {
            document.getElementById("loginContainer").style.display = "none";
            document.getElementById("registerContainer").style.display = "block";
        };

        window.login = async function () {
            const email = document.getElementById("loginEmail").value;
            const password = document.getElementById("loginPassword").value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                document.getElementById("loginError").textContent = "";
            } catch (error) {
                document.getElementById("loginError").textContent = error.message;
            }
        };

        window.register = async function () {
            const email = document.getElementById("registerEmail").value;
            const password = document.getElementById("registerPassword").value;
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                document.getElementById("registerError").textContent = "";
            } catch (error) {
                document.getElementById("registerError").textContent = error.message;
            }
        };

        window.logout = async function () {try {await signOut(auth);} catch (e) {alert("Logout failed");}};

        window.loadDropdownData = async function () {
            const tranCol = collection(db, "tran");
            const snapshot = await getDocs(tranCol);

            const grpSet = new Set();
            const spSet = new Set();
            const nameSet = new Set();
            const ttypeSet = new Set();
            const sproductSet = new Set();
            const pproductSet = new Set();
            const crdbSet = new Set();
            const crdbcsbkangSet = new Set();
            const crdbcsbkangexpSet = new Set();

            const crdbGroups = ["Creditors", "Debitors"];
            const crdbcsbkangGroups = ["Creditors", "Debitors", "Cash", "Bank", "Angadiya"];
            const crdbcsbkangexpGroups = [...crdbcsbkangGroups, "Expense"];

            snapshot.forEach(doc => {
                const data = doc.data();
                const grp = (data.grp || "").trim();
                const name = (data.name || "").trim();
                if (grp.length === 0) return;

                if (["Sales", "Purchase", "Receipt", "Payment"].includes(grp)) {ttypeSet.add(grp);}

                if (["Sales Products", "Purchase Products"].includes(grp)) {spSet.add(grp);}

                if (name.length > 0) {nameSet.add(name);}

                if (grp === "Sales Products" && name.length > 0) {sproductSet.add(name);}

                if (grp === "Purchase Products" && name.length > 0) {pproductSet.add(name);}

                if (crdbGroups.includes(grp) && name.length > 0) {crdbSet.add(name);}

                if (crdbcsbkangGroups.includes(grp) && name.length > 0) {crdbcsbkangSet.add(name);}

                if (crdbcsbkangexpGroups.includes(grp) && name.length > 0) {crdbcsbkangexpSet.add(name);}
            });

            window.grp_list = [];
            window.sp_list = [];
            window.allnames_list = [];
            window.ttype_list = [];
            window.sproduct_list = [];
            window.pproduct_list = [];
            window.crdb_list = [];
            window.crdbcsbkang_list = [];
            window.crdbcsbkangexp_list = [];

            window.grp_list = [...grpSet].sort((a, b) => a.localeCompare(b));
            window.sp_list = [...spSet].sort((a, b) => a.localeCompare(b));
            window.allnames_list = [...nameSet].sort((a, b) => a.localeCompare(b));
            window.ttype_list = [...ttypeSet].sort((a, b) => a.localeCompare(b));
            window.sproduct_list = [...sproductSet].sort((a, b) => a.localeCompare(b));
            window.pproduct_list = [...pproductSet].sort((a, b) => a.localeCompare(b));
            window.crdb_list = [...crdbSet].sort((a, b) => a.localeCompare(b));
            window.crdbcsbkang_list = [...crdbcsbkangSet].sort((a, b) => a.localeCompare(b));
            window.crdbcsbkangexp_list = [...crdbcsbkangexpSet].sort((a, b) => a.localeCompare(b));

            window.formDataReady = true;
        }

        window.renderTable = function (containerId, columns, data, options = {}) {
            const table = $('#' + containerId);

            if ($.fn.DataTable.isDataTable('#' + containerId)) {
                table.DataTable().destroy();
            }

            table.find('thead').empty();
            table.find('tbody').empty();

            const theadHtml = '<tr>' + columns.map(col => `<th>${col}</th>`).join('') + '</tr>';
            table.find('thead').html(theadHtml);

            const tbodyHtml = data.map(row =>
                '<tr>' + row.map(cell => `<td>${cell}</td>`).join('') + '</tr>'
            ).join('');
            table.find('tbody').html(tbodyHtml);

            const dt = table.DataTable({
                responsive: true,
                pageLength: 10,
                dom: 'Bfrtip',
                buttons: [{text: '📊 Excel',}, {text: '📄 PDF',}, {text: '🖨️ Print',}],
                columnDefs: options.columnDefs || [],
                language: {
                    search: "",
                    searchPlaceholder: "Search..."
                }
            });

            if (containerId === 'Table') {
                table.off('dblclick', 'tbody tr');
                table.on('dblclick', 'tbody tr', function () {
                    const rowData = dt.row(this).data();
                    const firestoreDocId = rowData[0];

                    const originalDoc = window.daybookDataMap.get(firestoreDocId);

                    if (originalDoc) {
                        const alpineInstance = window.alpineFormManager;

                        alpineInstance.editMode = true;
                        alpineInstance.currentDocId = originalDoc.firestoreDocId;

                        let formName = '';
                        let mappedData = {...originalDoc};
                        mappedData.id = originalDoc.id;

                        const ttypeVal = originalDoc.ttype || '';
                        const fpartyVal = originalDoc.fparty || '';
                        const tpartyVal = originalDoc.tparty || '';
                        const grpVal = originalDoc.grp || '';
                        const nameVal = originalDoc.name || '';


                        switch (ttypeVal.toUpperCase()) {
                            case 'SALES':
                                formName = 'sales';
                                break;
                            case 'PURCHASE':
                                formName = 'purchase';
                                break;
                            case 'RECEIPT':
                                formName = 'receipt';
                                break;
                            case 'PAYMENT':
                                formName = 'payment';
                                break;
                            case 'OPENING BALANCE':
                                formName = 'ledger';
                                mappedData.obj = fpartyVal === nameVal ? originalDoc.amt : '';
                                mappedData.obk = tpartyVal === nameVal ? originalDoc.amt : '';
                                mappedData.ttype = 'Opening Balance';
                                break;
                            case 'OP STOCK':
                                formName = 'product';
                                mappedData.ostk = originalDoc.amt;
                                mappedData.ttype = 'Opening Stock';
                                break;
                            case 'GROUP':
                                formName = 'group';
                                mappedData.grp = grpVal;
                                mappedData.ttype = 'Group';
                                break;
                            default:
                                alert('Cannot edit this transaction type directly.');
                                return;
                        }
                        alpineInstance.showForm(formName, mappedData);

                        alpineInstance.$nextTick(() => {
                        });
                    }
                });
            }
        }

        window.formatDate = function (d) {
            if (!d) return "";
            const parts = d.split("-");
            if (parts.length === 3) {
                return `${parts[2]}-${parts[1]}-${parts[0]}`;
            }
            return d;
        }

        window.showReceivables = async function () {
            const snapshot = await getDocs(collection(db, `tran`));
            const balanceMap = new Map();

            snapshot.forEach(doc => {
                const data = doc.data();
                const amt = Number(data.amt) || 0;
                const fparty = (data.fparty || "").trim();
                const tparty = (data.tparty || "").trim();

                if (fparty) {balanceMap.set(fparty, (balanceMap.get(fparty) || 0) - amt);}
                if (tparty) {balanceMap.set(tparty, (balanceMap.get(tparty) || 0) + amt);}
            });

            const receivables = Array.from(balanceMap.entries())
                .filter(([_, bal]) => bal > 0)
                .sort((a, b) => b[1] - a[1])
                .map(([name, bal]) => [name, bal.toFixed(0)]);
            window.renderTable("Table", ["Name", "Receivable Amount"], receivables);
        }

        window.updateCashLabel = async function () {
            const tranCol = collection(db, `tran`);
            const snapshot = await getDocs(tranCol);

            let inflow = 0;
            let outflow = 0;

            snapshot.forEach(doc => {
                const data = doc.data();
                if (data.tparty === "Cash On Hand") {
                    inflow += Number(data.amt || 0);
                }
                if (data.fparty === "Cash On Hand") {
                    outflow += Number(data.amt || 0);
                }
            });

            const balance = inflow - outflow;
            document.getElementById("cashLabel").textContent = `Cash: ₹${balance.toFixed(0)}`;
        }

        window.viewGroupsAndAccounts = async function () {
            const tranCol = collection(db, "tran");
            const snapshot = await getDocs(tranCol);
            let rows = [];

            snapshot.forEach(doc => {
                const data = doc.data();
                if (data.grp && data.name) {
                    rows.push([data.grp || "", data.name || ""]);
                }
            });
            window.renderTable("Table", ["Groups", "Accounts"], rows);
        }

        window.viewProducts = async function () {
            const tranCol = collection(db, "tran");
            const snapshot = await getDocs(tranCol);
            let rows = [];

            snapshot.forEach(doc => {
                const data = doc.data();
                if (data.grp && data.name && (data.grp === "sales products" || data.grp === "purchase products"))
                    {rows.push([data.grp || "", data.name || ""]);}
            });

            window.renderTable("Table", ["Groups", "Products"], rows);
        }

        window.updateRelatedNames = async function (oldName, newName) {
            const tranCol = collection(db, "tran");
            const snapshot = await getDocs(tranCol);
            const batch = writeBatch(db);
            let updatesCount = 0;

            snapshot.forEach(docSnapshot => {
                const data = docSnapshot.data();
                let needsUpdate = false;
                const updateData = {};

                if (data.name && (data.name || '').trim().toLowerCase() === oldName.toLowerCase()) {
                    updateData.name = newName;
                    needsUpdate = true;
                }
                if (data.grp && (data.grp || '').trim().toLowerCase() === oldName.toLowerCase()) {
                    updateData.grp = newName;
                    needsUpdate = true;
                }
                if (data.fparty && (data.fparty || '').trim().toLowerCase() === oldName.toLowerCase()) {
                    updateData.fparty = newName;
                    needsUpdate = true;
                }
                if (data.tparty && (data.tparty || '').trim().toLowerCase() === oldName.toLowerCase()) {
                    updateData.tparty = newName;
                    needsUpdate = true;
                }
                if (data.ttype && (data.ttype || '').trim().toLowerCase() === oldName.toLowerCase()) {
                    updateData.ttype = newName;
                    needsUpdate = true;
                }

                if (needsUpdate) {
                    batch.update(doc(db, "tran", docSnapshot.id), updateData);
                    updatesCount++;
                }
            });

            if (updatesCount > 0) {
                await batch.commit();
                await window.loadDropdownData();
            }
        };

    } else {
        document.getElementById("authContainer").style.display = "block";
        document.getElementById("loginContainer").style.display = "block";
        document.getElementById("registerContainer").style.display = "none";
        document.getElementById("widget-area").style.display = "none";
    }
</script>

</body>
</html>




