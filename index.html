<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Firebase Login UI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" rel="stylesheet"/>
    <link href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css" rel="stylesheet"/>
    <style>
        .error {
            color: red;
            margin-top: 10px;
        }

        .small-link {
            margin-top: 10px;
            display: block;
        }

        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 1020;
            background-color: #f8f9fa;
            border-bottom: 1px solid #ccc;
        }

        #groupsTable thead th,
        #daybookTable thead th {
            position: sticky;
            background: #f8f9fa;
            z-index: 10;
        }

    </style>
</head>

<body>
<!-- 🔐 LOGIN FORM -->
<div class="container mt-5" id="loginContainer" style="display: none;">
    <h2>Login</h2>
    <input class="form-control mb-2" id="loginEmail" placeholder="Email" type="email">
    <input class="form-control mb-2" id="loginPassword" placeholder="Password" type="password">
    <button class="btn btn-primary" onclick="login()">Login</button>
    <div class="error" id="loginError"></div>
    <a href="#" onclick="event.preventDefault(); showRegister();">Don’t have an account? Register</a>
</div>

<!-- 🆕 REGISTER FORM -->
<div class="container mt-5" id="registerContainer" style="display: none;">
    <h2>Register</h2>
    <input class="form-control mb-2" id="registerEmail" placeholder="Email" type="email">
    <input class="form-control mb-2" id="registerPassword" placeholder="Password" type="password">
    <button class="btn btn-success" onclick="register()">Register</button>
    <div class="error" id="registerError"></div>
    <div class="small-link">
        <a href="#" onclick="event.preventDefault(); showLogin();">Already have an account? Login</a>
    </div>
</div>

<!-- ✅ MAIN APP CONTENT -->
<div class="container mt-3" id="appContent" style="display: none;">
    <!-- MENU -->
    <div class="sticky-header">
        <div class="accordion" id="menuAccordion">
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" data-bs-target="#collapseMain" data-bs-toggle="collapse"
                            onclick="hideAllViews()" type="button" style="height: 40px">Main Menu
                    </button>
                </h2>
                <div class="accordion-collapse collapse" data-bs-parent="#menuAccordion" id="collapseMain">
                    <div class="accordion-body">
                        <button class="btn btn-outline-primary w-100 mb-2" onclick="loadGroupsAndLedgers()">Groups & Ledgers</button>
                        <button class="btn btn-outline-success w-100 mb-2" onclick="loadDaybook()">Daybook</button>
                        <button class="btn btn-danger w-100" onclick="logout()">Logout</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN CONTAINER -->
    <div class="container mt-3">
        <!-- Groups & Ledgers -->
        <div class="view-section d-none" id="groupsView">
            <h4>Groups & Ledgers</h4>
            <table class="table table-striped table-bordered w-100 display nowrap" id="groupsTable">
                <thead></thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Daybook -->
        <div class="view-section d-none" id="daybookView">
            <h4>Daybook Entries</h4>
            <table class="table table-striped table-bordered w-100 display nowrap" id="daybookTable">
                <thead></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<!-- jQuery & Bootstrap -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- DataTables -->
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.print.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>

<!-- 🔌 Firebase & App Logic -->
<script type="module">
    import {initializeApp} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
        getAuth,
        onAuthStateChanged,
        signInWithEmailAndPassword,
        createUserWithEmailAndPassword,
        signOut
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
        getFirestore, collection, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDQWZC6iA5zYKvTXsFl9TYLkZCTl5BzfwA",
        authDomain: "accounts-19d08.firebaseapp.com",
        projectId: "accounts-19d08",
        storageBucket: "accounts-19d08.appspot.com",
        messagingSenderId: "247308606105",
        appId: "1:247308606105:web:9bfc179368524244bf3608"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const loginContainer = document.getElementById('loginContainer');
    const registerContainer = document.getElementById('registerContainer');
    const appContent = document.getElementById('appContent');

    onAuthStateChanged(auth, user => {
        if (user) {
            loginContainer.style.display = 'none';
            registerContainer.style.display = 'none';
            appContent.style.display = 'block';
        } else {
            loginContainer.style.display = 'block';
            registerContainer.style.display = 'none';
            appContent.style.display = 'none';
        }
    });

    window.login = async function () {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        const errorDiv = document.getElementById('loginError');
        errorDiv.textContent = '';

        try {
            await signInWithEmailAndPassword(auth, email, password);
        } catch (error) {
            errorDiv.textContent = error.message;
        }
    }

    window.register = async function () {
        const email = document.getElementById('registerEmail').value;
        const password = document.getElementById('registerPassword').value;
        const errorDiv = document.getElementById('registerError');
        errorDiv.textContent = '';

        try {
            await createUserWithEmailAndPassword(auth, email, password);
        } catch (error) {
            errorDiv.textContent = error.message;
        }
    }

    window.logout = async function () {
        await signOut(auth);
    }

    window.showRegister = function () {
        loginContainer.style.display = 'none';
        registerContainer.style.display = 'block';
    }

    window.showLogin = function () {
        loginContainer.style.display = 'block';
        registerContainer.style.display = 'none';
    }

    window.hideAllViews = function () {
        document.querySelectorAll('.view-section').forEach(v => v.classList.add('d-none'));
    }

    function showView(viewId) {
        hideAllViews();
        document.getElementById(viewId).classList.remove('d-none');
        const collapseMenu = bootstrap.Collapse.getOrCreateInstance(document.getElementById('collapseMain'));
        collapseMenu.hide();
    }

    function renderTable(targetId, columns, data, options = {}) {
        const table = $('#' + targetId);

        if ($.fn.DataTable.isDataTable('#' + targetId)) {
            table.DataTable().destroy();
        }

        table.find('thead').empty();
        table.find('tbody').empty();

        let theadHtml = '<tr>' + columns.map(col => `<th>${col}</th>`).join('') + '</tr>';
        table.find('thead').html(theadHtml);

        let tbodyHtml = '';
        data.forEach(row => {
            tbodyHtml += '<tr>' + row.map(cell => `<td>${cell}</td>`).join('') + '</tr>';
        });
        table.find('tbody').html(tbodyHtml);

        table.DataTable({
            responsive: true,
            pageLength: 10,
            dom: 'Bfrtip',
            buttons: ['excel', 'pdf', 'print'],
            columnDefs: options.columnDefs || []
        });
    }

    window.loadGroupsAndLedgers = async function () {
        const snapshot = await getDocs(collection(db, "tran"));
        const columns = ['Group', 'Name'];
        const data = [];

        snapshot.forEach(doc => {
            const d = doc.data();
            if (d.grp && d.name) {
                data.push([d.grp, d.name]);
            }
        });

        showView('groupsView');
        renderTable("groupsTable", columns, data)
    }

    function formatDateToDDMMYYYY(dateStr) {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        const dd = String(date.getDate()).padStart(2, '0');
        const mm = String(date.getMonth() + 1).padStart(2, '0');
        const yyyy = date.getFullYear();
        return `${dd}-${mm}-${yyyy}`;
    }

    window.loadDaybook = async function () {
        const snapshot = await getDocs(collection(db, "tran"));
        const columns = ['ID', 'Date', 'Type', 'From Party', 'To Party', 'Narration', 'Amount'];
        const data = [];

        snapshot.forEach(doc => {
            const d = doc.data();
            if (d.id !== undefined) {
                data.push([
                    d.id,
                    formatDateToDDMMYYYY(d.date || ''),
                    d.ttype || '',
                    d.fparty || '',
                    d.tparty || '',
                    d.nar || '',
                    d.amt || '',
                ]);
            }
        });

        showView('daybookView');
        renderTable("daybookTable", columns, data)
    }

    window.showView = showView;

</script>
</body>
</html>
