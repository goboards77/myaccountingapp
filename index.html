<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accordion Style Menu</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Ensure html and body take full viewport height for scrolling */
        html, body {
            height: 100%; /* Make html and body fill the viewport */
            margin: 0; /* Remove default body margin */
            padding: 0; /* Remove default body padding */
        }

        /* Custom CSS for smooth transitions and font */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Light gray background */
        }

        /* Accordion container for the main menu */
        .accordion-main-container {
            width: 100%;
            max-width: 300px; /* Constrain width for better accordion appearance */
            margin-left: 0; /* Explicitly align to the left */
            background-color: #ffffff;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            /* Adjusted border-radius for sharp top corners */
            border-top-left-radius: 0;
            border-top-right-radius: 0;
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0.5rem;
            overflow: hidden; /* Ensures rounded corners */
            position: relative; /* Added for correct positioning of expanded content */
            z-index: 10; /* Ensure it's above other content when open */
            display: none; /* Initially hidden */
        }

        /* Styles for accordion headers (buttons) */
        .accordion-header, .accordion-sub-header {
            width: 100%;
            text-align: left;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            background-color: #4f46e5; /* Indigo for main header */
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); /* Subtle separator */
        }
        .accordion-header:hover, .accordion-sub-header:hover {
            background-color: #4338ca; /* Darker indigo on hover */
        }
        .accordion-sub-header {
            background-color: #6366f1; /* Lighter indigo for sub-headers */
            padding-left: 2.5rem; /* Indent sub-headers */
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .accordion-sub-header:hover {
            background-color: #4f46e5; /* Darker indigo on hover */
        }
        .accordion-sub-header:last-child {
            border-bottom: none; /* No border on the last sub-header */
        }

        /* Styles for accordion content (hidden by default) */
        .accordion-content, .accordion-sub-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out; /* Smooth slide effect */
            background-color: #f9f9f9; /* Light background for content */
        }

        /* Styles for active/expanded accordion content */
        .accordion-content.active, .accordion-sub-content.active {
            max-height: 1000px; /* Increased to accommodate more content */
            /* You might need to adjust this value based on your actual content height */
        }

        /* Styles for nested content items */
        .dropdown-item {
            padding: 0.75rem 1.5rem;
            text-decoration: none;
            display: block;
            color: #333;
            background-color: #f9f9f9;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
            border-bottom: 1px solid #eee; /* Light separator for items */
            padding-left: 3.5rem; /* Further indent for actual items */
        }
        .dropdown-item:hover {
            background-color: #e0e7ff; /* Light blue on hover */
            color: #4f46e5; /* Darker blue text on hover */
        }
        .dropdown-item:last-child {
            border-bottom: none;
        }

        /* Arrow rotation for accordion headers */
        .accordion-header svg, .accordion-sub-header svg {
            transition: transform 0.3s ease-in-out;
        }
        .accordion-header.active svg, .accordion-sub-header.active svg {
            transform: rotate(180deg);
        }
        /* Specific styling for Logout button */
        .logout-button {
            background-color: #ef4444; /* Red for logout */
        }
        .logout-button:hover {
            background-color: #dc2626; /* Darker red on hover */
        }

        /* Styles for Firebase related containers and forms */
        .auth-container, .form-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: calc(100vh - 64px); /* Adjusted min-height to account for fixed nav */
            padding: 20px;
            background-color: #f0f2f5;
            box-sizing: border-box; /* Include padding in height calculation */
        }
        .auth-card, .form-card {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        .form-card {
            text-align: left; /* Align form labels/inputs to left */
        }
        .auth-card input, .form-card input, .form-card select, .form-card textarea {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: 1px solid #ccc;
            border-radius: 0.25rem;
        }
        .auth-card button, .form-card button {
            width: 100%;
            padding: 0.75rem;
            background-color: #4f46e5;
            color: white;
            border-radius: 0.25rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .auth-card button:hover, .form-card button:hover {
            background-color: #4338ca;
        }
        .auth-card .error-message, .form-card .error-message {
            color: #ef4444;
            margin-top: 0.5rem;
            font-size: 0.875rem;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #333;
        }
    </style>
</head>
<body class="p-0">
    <nav class="bg-gradient-to-r from-indigo-500 to-purple-600 shadow-lg flex justify-start items-center fixed top-0 left-0 w-full z-30 h-16">
        <!-- Main Menu Button (always visible in fixed nav) -->
        <button class="accordion-header" onclick="window.toggleMainAccordion(event)">
            Menu
            <svg class="w-4 h-4 ml-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
            </svg>
        </button>
    </nav>

    <!-- Wrapper for all main content, including the accordion menu and app screens -->
    <div id="appContentWrapper" style="margin-top: 64px;">
        <!-- The actual accordion menu structure, now below the fixed nav -->
        <div class="accordion-main-container" id="mainAccordionMenu">
            <div id="mainMenuContent" class="accordion-content">
                <!-- Nested Accordion Item: New -->
                <div class="accordion-sub-item">
                    <button class="accordion-sub-header" onclick="window.toggleSubAccordion(this, 'newContent', event)">
                        New
                        <svg class="w-4 h-4 ml-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                    <div id="newContent" class="accordion-sub-content">
                        <a href="javascript:void(0)" class="dropdown-item" onclick="window.handleMenuItemClick('salesFormContainer');">Sales</a>
                        <a href="javascript:void(0)" class="dropdown-item" onclick="window.handleMenuItemClick('mainContainer');">Purchase</a>
                        <a href="javascript:void(0)" class="dropdown-item" onclick="window.handleMenuItemClick('mainContainer');">Receipt</a>
                        <a href="javascript:void(0)" class="dropdown-item" onclick="window.handleMenuItemClick('mainContainer');">Payment</a>
                        <a href="javascript:void(0)" class="dropdown-item" onclick="window.handleMenuItemClick('groupFormContainer');">Group</a>
                        <a href="javascript:void(0)" class="dropdown-item" onclick="window.handleMenuItemClick('mainContainer');">Product</a> <!-- Product now points to mainContainer -->
                        <a href="javascript:void(0)" class="dropdown-item" onclick="window.handleMenuItemClick('ledgerFormContainer');">Ledger</a> <!-- Ledger points to the new form -->
                    </div>
                </div>

                <!-- Simple Button: Update -->
                <button class="accordion-sub-header" onclick="window.handleMenuItemClick('mainContainer'); window.showMessageBox('Update button clicked!');">
                    Update
                </button>

                <!-- Nested Accordion Item: Reports -->
                <div class="accordion-sub-item">
                    <button class="accordion-sub-header" onclick="window.toggleSubAccordion(this, 'reportsContent', event)">
                        Reports
                        <svg class="w-4 h-4 ml-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                    <div id="reportsContent" class="accordion-sub-content">
                        <a href="javascript:void(0)" class="dropdown-item" onclick="window.handleMenuItemClick('tableContainer');">Groups & Products</a>
                        <a href="javascript:void(0)" class="dropdown-item" onclick="window.handleMenuItemClick('mainContainer');">Groups & Ledgers</a>
                    </div>
                </div>

                <!-- Nested Accordion Item: Financials -->
                <div class="accordion-sub-item">
                    <button class="accordion-sub-header" onclick="window.toggleSubAccordion(this, 'financialsContent', event)">
                        Financials
                        <svg class="w-4 h-4 ml-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                    <div id="financialsContent" class="accordion-sub-content">
                        <a href="javascript:void(0)" class="dropdown-item" onclick="window.handleMenuItemClick('tableContainer');">Receivables</a>
                        <a href="javascript:void(0)" class="dropdown-item" onclick="window.handleMenuItemClick('mainContainer');">Payables</a>
                        <a href="javascript:void(0)" class="dropdown-item" onclick="window.handleMenuItemClick('mainContainer');">Khatavahi</a>
                        <a href="javascript:void(0)" class="dropdown-item" onclick="window.handleMenuItemClick('mainContainer');">Profit & Loss</a>
                    </div>
                </div>

                <!-- Simple Button: Logout -->
                <button class="accordion-sub-header logout-button" onclick="window.logout(); window.showMessageBox('Logged out!');">
                    Logout
                </button>
            </div>
        </div>

        <!-- Sales Transaction Form Container -->
        <div id="salesFormContainer" style="display: none;" class="form-container">
            <div class="form-card">
                <h2 class="text-2xl font-bold mb-4 text-center">Sales Transaction</h2>
                <div class="form-group">
                    <label for="salesTranType">Transaction Type</label>
                    <input type="text" id="salesTranType" value="Sales" disabled class="bg-gray-100 cursor-not-allowed">
                </div>
                <div class="form-group">
                    <label for="salesDate">Date</label>
                    <input type="date" id="salesDate" class="date-input">
                </div>
                <div class="form-group">
                    <label for="salesFrom">From</label>
                    <select id="salesFrom">
                        <option value="">Select Product</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="salesTo">To</label>
                    <select id="salesTo">
                        <option value="">Select Creditor/Debitor</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="salesAmount">Amount</label>
                    <input type="number" id="salesAmount" placeholder="Enter amount">
                </div>
                <div class="form-group">
                    <label for="salesNarration">Narration</label>
                    <textarea id="salesNarration" rows="3" placeholder="Enter narration (optional)"></textarea>
                </div>
                <button onclick="window.saveSalesTransaction()">Save Transaction</button>
                <div id="salesFormError" class="error-message"></div>
            </div>
        </div>

        <!-- Group Form Container -->
        <div id="groupFormContainer" style="display: none;" class="form-container">
            <div class="form-card">
                <h2 class="text-2xl font-bold mb-4 text-center">New Group</h2>
                <div class="form-group">
                    <label for="newGroupName">Group Name</label>
                    <input type="text" id="newGroupName" placeholder="Enter new group name">
                </div>
                <button onclick="window.saveGroup()">Save Group</button>
                <div id="groupFormError" class="error-message"></div>
            </div>
        </div>

        <!-- Ledger Form Container (renamed from productFormContainer) -->
        <div id="ledgerFormContainer" style="display: none;" class="form-container">
            <div class="form-card">
                <h2 class="text-2xl font-bold mb-4 text-center">New Ledger</h2>
                <div class="form-group">
                    <label for="productGroupSelect">Select Group</label>
                    <select id="productGroupSelect"> <!-- ID remains descriptive for group select -->
                        <option value="">Select Group</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="newLedgerName">New Ledger Name</label>
                    <input type="text" id="newLedgerName" placeholder="Enter new ledger name">
                </div>
                <div class="form-group">
                    <label for="oldBalanceJama">Old Balance Jama</label>
                    <input type="number" id="oldBalanceJama" placeholder="Enter Old Balance Jama">
                </div>
                <div class="form-group">
                    <label for="oldBalanceKhate">Old Balance Khate</label>
                    <input type="number" id="oldBalanceKhate" placeholder="Enter Old Balance Khate">
                </div>
                <button onclick="window.saveLedger()">Save Ledger</button> <!-- Updated function name -->
                <div id="ledgerFormError" class="error-message"></div> <!-- Updated error div ID -->
            </div>
        </div>

        <!-- Main Application Container (initially hidden) -->
        <div id="mainContainer" style="display: none;" class="auth-container">
            <h2 class="text-2xl font-bold mb-4">Welcome!</h2>
            <p>You are logged in.</p>
        </div>

        <!-- Login Container (initially visible for demonstration) -->
        <div id="loginContainer" class="auth-container">
            <div class="auth-card">
                <h2 class="text-2xl font-bold mb-4">Login</h2>
                <input type="email" id="loginEmail" placeholder="Email" class="mb-4 p-2 border rounded w-full">
                <input type="password" id="loginPassword" placeholder="Password" class="mb-4 p-2 border rounded w-full">
                <button onclick="window.login()">Login</button>
                <p class="text-sm mt-4">Don't have an account? <a href="javascript:void(0)" class="text-indigo-600 hover:underline" onclick="window.showRegister()">Register here</a></p>
                <div id="loginError" class="error-message"></div>
            </div>
        </div>

        <!-- Register Container (initially hidden) -->
        <div id="registerContainer" style="display: none;" class="auth-container">
            <div class="auth-card">
                <h2 class="text-2xl font-bold mb-4">Register</h2>
                <input type="email" id="registerEmail" placeholder="Email" class="mb-4 p-2 border rounded w-full">
                <input type="password" id="registerPassword" placeholder="Password" class="mb-4 p-2 border rounded w-full">
                <button onclick="window.register()">Register</button>
                <p class="text-sm mt-4">Already have an account? <a href="javascript:void(0)" class="text-indigo-600 hover:underline" onclick="window.showLogin()">Login here</a></p>
                <div id="registerError" class="error-message"></div>
            </div>
        </div>

        <!-- Table Container (initially hidden) -->
        <div id="tableContainer" style="display: none;" class="p-4">
            <h2 class="text-2xl font-bold mb-4">Data Table</h2>
            <table id="myTable" class="min-w-full bg-white border border-gray-200">
                <thead>
                    <tr>
                        <th class="py-2 px-4 border-b">Header 1</th>
                        <th class="py-2 px-4 border-b">Header 2</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Table data will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Custom Message Box -->
    <div id="messageBox" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center">
            <p id="messageText" class="text-lg font-semibold mb-4"></p>
            <button class="bg-indigo-500 text-white py-2 px-4 rounded-md hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-300" onclick="window.hideMessageBox()">OK</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import {
            getAuth, onAuthStateChanged,
            signInWithEmailAndPassword, createUserWithEmailAndPassword,
            signOut
        } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
        import {
            getFirestore, collection, getDocs, setDoc, deleteDoc, doc, updateDoc, query, where, addDoc
        } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDQWZC6iA5zYKvTXsFl9TYLkZCTl5BzfwA",
            authDomain: "accounts-19d08.firebaseapp.com",
            projectId: "accounts-19d08",
            storageBucket: "accounts-19d08.appspot.com",
            messagingSenderId: "247308606105",
            appId: "1:247308606105:web:9bfc179368524244bf3608"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let dataTable; // Global variable to hold the DataTables instance
        let firestoreData = []; // To store original data and track changes

        // Global lists for dropdowns (populated by loadDropdownData)
        window.sproduct_list = [];
        window.crdb_list = [];
        window.crdbcsbkangexp_list = []; // Ensure this is globally accessible
        window.grp_list = []; // Ensure grp_list is initialized

        // Capitalize all words in inputs, excluding password and email types
        function applyCapitalization(inputElement) {
            inputElement.value = inputElement.value.toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
        }

        // Clear all *application content* screens (not the menu itself)
        function clearScreen() {
            document.getElementById("mainContainer").style.display = "none";
            document.getElementById("loginContainer").style.display = "none";
            document.getElementById("registerContainer").style.display = "none";
            document.getElementById("tableContainer").style.display = "none";
            document.getElementById("salesFormContainer").style.display = "none"; // Hide sales form
            document.getElementById("groupFormContainer").style.display = "none"; // Hide group form
            document.getElementById("ledgerFormContainer").style.display = "none"; // Hide ledger form
            // Also hide the main accordion menu container
            document.getElementById("mainAccordionMenu").style.display = "none";
        }

        // Show login screen
        window.showLogin = function () {
            clearScreen();
            document.getElementById("loginContainer").style.display = "flex"; // Use flex for centering
        }

        // Show register screen
        window.showRegister = function () {
            clearScreen();
            document.getElementById("registerContainer").style.display = "flex"; // Use flex for centering
        }

        // Login
        window.login = async function () {
            const email = document.getElementById("loginEmail").value;
            const password = document.getElementById("loginPassword").value;
            const errorDiv = document.getElementById("loginError");
            errorDiv.textContent = '';

            if (!email || !password) {
                errorDiv.textContent = "Please enter both email and password.";
                return;
            }

            try {
                await signInWithEmailAndPassword(auth, email, password);
                console.log("Login successful");
                // onAuthStateChanged will handle showing mainContainer
            } catch (error) {
                errorDiv.textContent = error.message;
            }
        };

        // Register
        window.register = async function () {
            const email = document.getElementById("registerEmail").value;
            const password = document.getElementById("registerPassword").value;
            const errorDiv = document.getElementById("registerError");
            errorDiv.textContent = '';

            if (!email || !password) {
                errorDiv.textContent = "Please enter both email and password.";
                return;
            }

            try {
                await createUserWithEmailAndPassword(auth, email, password);
                console.log("Registration successful");
                // onAuthStateChanged will handle showing mainContainer
            } catch (error) {
                errorDiv.textContent = error.message;
            }
        };

        // Logout
        window.logout = async function () {
            await signOut(auth);
            console.log("User logged out");
            // onAuthStateChanged will handle showing loginContainer
        };

        // Auth state change listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in
                clearScreen(); // Clear all content screens
                document.getElementById("mainContainer").style.display = "flex"; // Show main app content
                console.log("User is logged in:", user.uid);
                await loadDropdownData(); // Load dropdown data after login
            } else {
                // User is signed out
                clearScreen(); // Clear all content screens
                document.getElementById("loginContainer").style.display = "flex"; // Show login screen
                console.log("User is logged out.");
            }
        });

        // Initialize autoCapitalizeInputs on load
        document.addEventListener('DOMContentLoaded', () => {
            // Apply capitalization to all input elements that are not type="password" or type="email"
            document.querySelectorAll('input:not([type="password"]):not([type="email"])').forEach(input => {
                input.addEventListener('input', function () {
                    applyCapitalization(this);
                });
            });

            // Set current date for salesDate input
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
            const dd = String(today.getDate()).padStart(2, '0');
            const salesDateInput = document.getElementById('salesDate');
            if (salesDateInput) {
                salesDateInput.value = `${yyyy}-${mm}-${dd}`;
            }


            // Initially show login screen if no user is logged in
            if (!auth.currentUser) {
                window.showLogin();
            }
        });

        // Provided function to load dropdown data from Firestore
        async function loadDropdownData() {
            try {
                const tranCol = collection(db, "tran");
                const snapshot = await getDocs(tranCol);

                const grpSet = new Set();
                const spSet = new Set();
                const nameSet = new Set();
                const ttypeSet = new Set();
                const sproductSet = new Set();
                const pproductSet = new Set();
                const crdbSet = new Set();
                const crdbcsbkangSet = new Set();
                const crdbcsbkangexpSet = new Set();

                const crdbGroups = ["Creditors", "Debitors"];
                const crdbcsbkangGroups = ["Creditors", "Debitors", "Cash", "Bank", "Angadiya"];
                const crdbcsbkangexpGroups = [...crdbcsbkangGroups, "Expense"];

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const grp = (data.grp || "").trim();
                    const name = (data.name || "").trim();
                    if (grp.length === 0) return;

                    if (["Sales", "Purchase", "Receipt", "Payment"].includes(grp)) {
                        ttypeSet.add(grp);
                    }

                    if (["Sales Products", "Purchase Products"].includes(grp)) {
                        spSet.add(grp);
                    } else if (!["Sales Products", "Purchase Products"].includes(grp)) {
                        grpSet.add(grp);
                    }

                    if (name.length > 0) {
                        nameSet.add(name);
                    }

                    if (grp === "Sales" && name.length > 0) {
                        sproductSet.add(name);
                    }

                    if (grp === "Purchase" && name.length > 0) {
                        pproductSet.add(name);
                    }

                    if (crdbGroups.includes(grp) && name.length > 0) {
                        crdbSet.add(name);
                    }

                    if (crdbcsbkangGroups.includes(grp) && name.length > 0) {
                        crdbcsbkangSet.add(name);
                    }

                    if (crdbcsbkangexpGroups.includes(grp) && name.length > 0) {
                        crdbcsbkangexpSet.add(name);
                    }
                });

                window.grp_list = [...grpSet].sort((a, b) => a.localeCompare(b));
                window.sp_list = [...spSet].sort((a, b) => a.localeCompare(b));
                window.allnames_list = [...nameSet].sort((a, b) => a.localeCompare(b));
                window.ttype_list = [...ttypeSet].sort((a, b) => a.localeCompare(b));
                window.sproduct_list = [...sproductSet].sort((a, b) => a.localeCompare(b));
                window.pproduct_list = [...pproductSet].sort((a, b) => a.localeCompare(b));
                window.crdb_list = [...crdbSet].sort((a, b) => a.localeCompare(b));
                window.crdbcsbkang_list = [...crdbcsbkangSet].sort((a, b) => a.localeCompare(b));
                window.crdbcsbkangexp_list = [...crdbcsbkangexpSet].sort((a, b) => a.localeCompare(b));

                console.log("Dropdown data loaded:", {
                    sproduct_list: window.sproduct_list,
                    crdb_list: window.crdb_list,
                    crdbcsbkangexp_list: window.crdbcsbkangexp_list,
                    grp_list: window.grp_list // Added for debugging
                });
            } catch (error) {
                console.error("Error loading dropdown data:", error);
                window.showMessageBox("Error loading dropdown data: " + error.message);
            }
        }

        // Helper function to populate a select dropdown
        function populateDropdown(selectElementId, dataList) {
            const selectElement = document.getElementById(selectElementId);
            if (!selectElement) {
                console.warn(`Dropdown element with ID '${selectElementId}' not found.`);
                return;
            }
            selectElement.innerHTML = '<option value="">Select...</option>'; // Clear existing options and add default
            dataList.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                option.textContent = item;
                selectElement.appendChild(option);
            });
            // Removed the console.log here as it was for debugging and is no longer needed.
        }

        // Function to save Sales transaction
        window.saveSalesTransaction = async function() {
            const date = document.getElementById('salesDate').value;
            const ttype = document.getElementById('salesTranType').value;
            const fparty = document.getElementById('salesFrom').value;
            const tparty = document.getElementById('salesTo').value;
            const amount = document.getElementById('salesAmount').value;
            const narration = document.getElementById('salesNarration').value;
            const errorDiv = document.getElementById('salesFormError');
            errorDiv.textContent = '';

            // Validation
            if (!date || !ttype || !fparty || !tparty || !amount) {
                errorDiv.textContent = "Please fill all required fields (Date, From, To, Amount).";
                window.showMessageBox("Please fill all required fields (Date, From, To, Amount).");
                return;
            }

            if (isNaN(parseFloat(amount)) || parseFloat(amount) <= 0) {
                errorDiv.textContent = "Amount must be a positive number.";
                window.showMessageBox("Amount must be a positive number.");
                return;
            }

            try {
                const newTransaction = {
                    date: date,
                    ttype: ttype,
                    fparty: fparty,
                    tparty: tparty,
                    nar: narration,
                    amt: parseFloat(amount)
                };

                const transactionsCollection = collection(db, "tran");
                await addDoc(transactionsCollection, newTransaction);

                window.showMessageBox("Sales transaction saved successfully!");

                // Clear form values after successful save
                document.getElementById('salesDate').value = new Date().toISOString().split('T')[0]; // Reset to current date
                document.getElementById('salesFrom').value = '';
                document.getElementById('salesTo').value = '';
                document.getElementById('salesAmount').value = '';
                document.getElementById('salesNarration').value = '';
                errorDiv.textContent = ''; // Clear any previous errors

            } catch (error) {
                console.error("Error saving sales transaction:", error);
                errorDiv.textContent = "Error saving transaction: " + error.message;
                window.showMessageBox("Error saving transaction: " + error.message);
            }
        };

        // Function to save a new Group
        window.saveGroup = async function() {
            const newGroupNameInput = document.getElementById('newGroupName');
            const newGroupName = newGroupNameInput.value.trim();
            const errorDiv = document.getElementById('groupFormError');
            errorDiv.textContent = '';

            if (!newGroupName) {
                errorDiv.textContent = "Please enter a group name.";
                window.showMessageBox("Please enter a group name.");
                return;
            }

            try {
                const groupsCollection = collection(db, "tran"); // Using 'tran' collection as per previous logic
                await addDoc(groupsCollection, {
                    ttype: 'Group',
                    grp: newGroupName
                });

                window.showMessageBox(`Group '${newGroupName}' saved successfully!`);
                newGroupNameInput.value = ''; // Clear input
                errorDiv.textContent = ''; // Clear error
                await loadDropdownData(); // Reload dropdown data to include the new group if needed elsewhere

            } catch (error) {
                console.error("Error saving group:", error);
                errorDiv.textContent = "Error saving group: " + error.message;
                window.showMessageBox("Error saving group: " + error.message);
            }
        };

        // Function to save a new Ledger (renamed from saveProductLedger)
        window.saveLedger = async function() {
            const productGroupSelect = document.getElementById('productGroupSelect');
            const newLedgerNameInput = document.getElementById('newLedgerName');
            const oldBalanceJamaInput = document.getElementById('oldBalanceJama');
            const oldBalanceKhateInput = document.getElementById('oldBalanceKhate');
            const errorDiv = document.getElementById('ledgerFormError'); // Updated error div ID
            errorDiv.textContent = '';

            const selectedGroup = productGroupSelect.value;
            const newLedgerName = newLedgerNameInput.value.trim();
            const oldBalanceJama = parseFloat(oldBalanceJamaInput.value) || 0;
            const oldBalanceKhate = parseFloat(oldBalanceKhateInput.value) || 0;

            // Validation
            if (!selectedGroup) {
                errorDiv.textContent = "Please select a Group.";
                window.showMessageBox("Please select a Group.");
                return;
            }
            if (!newLedgerName) {
                errorDiv.textContent = "Please enter a New Ledger Name.";
                window.showMessageBox("Please enter a New Ledger Name.");
                return;
            }
            if ((oldBalanceJama <= 0 && oldBalanceKhate <= 0) || (oldBalanceJama > 0 && oldBalanceKhate > 0)) {
                errorDiv.textContent = "Please enter either 'Old Balance Jama' OR 'Old Balance Khate' (one positive value).";
                window.showMessageBox("Please enter either 'Old Balance Jama' OR 'Old Balance Khate' (one positive value).");
                return;
            }

            try {
                // Check for duplicate ledger name (case-insensitive)
                const q = query(collection(db, "tran"), where("name", "==", newLedgerName));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    errorDiv.textContent = `Ledger name '${newLedgerName}' already exists.`;
                    window.showMessageBox(`Ledger name '${newLedgerName}' already exists.`);
                    return;
                }

                const newTransaction = {
                    ttype: 'Opening Balance',
                    grp: selectedGroup,
                    name: newLedgerName
                };

                if (oldBalanceJama > 0) {
                    newTransaction.amt = oldBalanceJama;
                    newTransaction.fparty = newLedgerName;
                    newTransaction.tparty = ''; // As per instruction "fparty=newledgername if obj else tparty"
                } else { // oldBalanceKhate > 0
                    newTransaction.amt = oldBalanceKhate;
                    newTransaction.fparty = '';
                    newTransaction.tparty = newLedgerName; // Interpreting "else tparty" to mean newLedgerName is the tparty
                }

                const transactionsCollection = collection(db, "tran");
                await addDoc(transactionsCollection, newTransaction);

                window.showMessageBox(`Ledger '${newLedgerName}' saved successfully with Opening Balance.`);

                // Clear form values after successful save
                productGroupSelect.value = '';
                newLedgerNameInput.value = '';
                oldBalanceJamaInput.value = '';
                oldBalanceKhateInput.value = '';
                errorDiv.textContent = ''; // Clear any previous errors
                await loadDropdownData(); // Reload dropdown data to include the new ledger/group

            } catch (error) {
                console.error("Error saving ledger:", error);
                errorDiv.textContent = "Error saving ledger: " + error.message;
                window.showMessageBox("Error saving ledger: " + error.message);
            }
        };


        // Accordion Menu Functions (exposed to window)
        window.closeAllAccordions = function () {
            document.querySelectorAll('.accordion-content.active, .accordion-sub-content.active').forEach(content => {
                content.classList.remove('active');
                const button = content.previousElementSibling;
                if (button && (button.classList.contains('accordion-header') || button.classList.contains('accordion-sub-header'))) {
                    button.classList.remove('active');
                }
            });
        };

        window.toggleMainAccordion = function (event) {
            event.stopPropagation();

            const mainAccordionMenu = document.getElementById('mainAccordionMenu');
            const mainMenuContent = mainAccordionMenu.querySelector('.accordion-content');
            const mainHeader = event.currentTarget;

            const isCurrentlyActive = mainMenuContent.classList.contains('active');

            // Always clear other screens when opening the main menu
            clearScreen(); // This ensures all other content is hidden

            // Close all accordions (including sub-accordions)
            window.closeAllAccordions(); // This will hide the accordion content if it was already open

            // If the main menu was not active, open it now and show the mainAccordionMenu container
            if (!isCurrentlyActive) {
                mainAccordionMenu.style.display = 'block'; // Show the accordion container
                mainMenuContent.classList.add('active');
                mainHeader.classList.add('active');
            } else {
                // If it was active, it means we clicked to close it, so hide the container
                mainAccordionMenu.style.display = 'none';
                // After closing the menu, show the appropriate screen based on auth state
                if (auth.currentUser) {
                    document.getElementById("mainContainer").style.display = "flex";
                } else {
                    document.getElementById("loginContainer").style.display = "flex";
                }
            }
        };

        window.toggleSubAccordion = function (button, contentId, event) {
            event.stopPropagation();

            const subContent = document.getElementById(contentId);
            const subHeader = button;

            const isCurrentlyActive = subContent.classList.contains('active');

            // Close all other sub-accordions within the main menu
            document.querySelectorAll('#mainMenuContent .accordion-sub-content.active').forEach(otherSubContent => {
                if (otherSubContent !== subContent) {
                    otherSubContent.classList.remove('active');
                    const otherSubHeader = otherSubContent.previousElementSibling;
                    if (otherSubHeader && otherSubHeader.classList.contains('accordion-sub-header')) {
                        otherSubHeader.classList.remove('active');
                    }
                }
            });

            if (!isCurrentlyActive) {
                subContent.classList.add('active');
                subHeader.classList.add('active');
            } else {
                subContent.classList.remove('active');
                subHeader.classList.remove('active');
            }
        };

        // New function to handle clicks on actual menu items (Sales, Purchase, Group etc.)
        window.handleMenuItemClick = async function(contentIdToShow) {
            window.closeAllAccordions(); // Close the accordion menu content
            document.getElementById("mainAccordionMenu").style.display = "none"; // Hide the accordion menu container
            clearScreen(); // Clear all application content screens

            // Show the selected content screen
            document.getElementById(contentIdToShow).style.display = 'flex';

            // If the sales form is being shown, populate its dropdowns
            if (contentIdToShow === 'salesFormContainer') {
                await loadDropdownData(); // Ensure lists are fresh
                populateDropdown('salesFrom', window.sproduct_list);
                populateDropdown('salesTo', window.crdb_list);
            } else if (contentIdToShow === 'ledgerFormContainer') { // Updated to ledgerFormContainer
                await loadDropdownData(); // Ensure lists are fresh
                populateDropdown('productGroupSelect', window.grp_list); // Corrected to grp_list
            }
        };


        // Close dropdowns when clicking outside of the entire menu structure
        document.addEventListener('click', function(event) {
            const mainMenuContainer = document.getElementById('mainAccordionMenu'); // Target the main accordion container
            const navBar = document.querySelector('nav'); // Target the fixed nav bar

            // Check if the click is outside both the main accordion menu and the fixed nav bar
            if (mainMenuContainer && !mainMenuContainer.contains(event.target) && navBar && !navBar.contains(event.target)) {
                window.closeAllAccordions();
                mainMenuContainer.style.display = 'none'; // Also hide the accordion container
                // After closing the menu, show the appropriate screen based on auth state
                if (auth.currentUser) {
                    document.getElementById("mainContainer").style.display = "flex";
                } else {
                    document.getElementById("loginContainer").style.display = "flex";
                }
            }
        });

        // Custom Message Box Functions
        window.showMessageBox = function (message) {
            document.getElementById('messageText').innerText = message;
            document.getElementById('messageBox').classList.remove('hidden');
        };

        window.hideMessageBox = function () {
            document.getElementById('messageBox').classList.add('hidden');
        };
    </script>
</body>
</html>
