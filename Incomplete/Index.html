<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fixed Menu with Forms</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>

<body class="bg-gray-100 pt-[56px] text-sm sm:text-base" x-data="{ open: false, activeForm: '' }">
  <button
    @click="open = !open"
    class="fixed top-0 left-0 w-full bg-blue-600 text-white px-4 py-3 sm:py-4 text-lg sm:text-2xl text-left hover:bg-blue-700 z-50"
  >☰</button>

  <div
    @click.away="open = false"
    class="fixed top-[56px] left-0 w-full bg-white shadow-md border-t z-40 flex flex-col"
    x-show="open"
    x-transition
  >
    <template x-for="item in [
      { label: '💰 Transaction', key: 'tran' },
      { label: '📒 Ledger', key: 'ledger' },
      { label: '👁️ Daybook', key: 'daybook' },
      { label: '📂 View Accounts', key: 'accounts' },
      { label: '📥 View Receivables', key: 'receivables' },
      { label: '📤 View Payables', key: 'payables' },
      { label: '🧾 Khatavahi', key: 'khatavahi' },
      { label: '📊 Profit & Loss', key: 'pl' }
    ]">
      <button
        @click="open = false; activeForm = item.key"
        class="text-left px-4 py-3 hover:bg-blue-100 text-base"
        x-text="item.label"
      ></button>
    </template>
    <button @click="open = false; logout()" class="text-left px-4 py-3 hover:bg-blue-100 text-base">🔐 Logout</button>
  </div>

  <div class="pt-6 sm:pt-10 px-4 max-w-lg mx-auto">
    <div id="loginContainer" class="space-y-3" style="display: none;">
      <h2 class="text-xl font-semibold">Login</h2>
      <input class="w-full px-3 py-2 border rounded" id="loginEmail" placeholder="Email" type="email" />
      <input class="w-full px-3 py-2 border rounded" id="loginPassword" placeholder="Password" type="password" />
      <button class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-800 text-white rounded" onclick="window.login()">Login</button>
      <a href="#" onclick="event.preventDefault(); showRegister();" class="text-blue-600 underline">Don’t have an account? Register</a>
    </div>

    <div id="registerContainer" class="space-y-3" style="display:none;">
      <h2 class="text-xl font-semibold">Register</h2>
      <input class="w-full px-3 py-2 border rounded" id="registerEmail" placeholder="Email" type="email" />
      <input class="w-full px-3 py-2 border rounded" id="registerPassword" placeholder="Password" type="password" />
      <button class="w-full px-4 py-2 bg-green-600 hover:bg-green-800 text-white rounded" onclick="window.register()">Register</button>
      <a href="#" onclick="event.preventDefault(); showLogin();" class="text-blue-600 underline">Already have an account? Login</a>
    </div>

    <div class="widget-area mt-6 space-y-6" x-show="activeForm" x-transition>
      <div class="bg-white p-4 sm:p-6 rounded shadow space-y-4" x-show="activeForm === 'tran'" x-init="setTimeout(async () => {
          await window.loadDropdownData();
          window.populateDropdown('tranFrom', window.names_list);
          window.populateDropdown('tranTo', window.names_list);
      }, 0)">
        <input class="w-full border rounded px-3 py-2" id="tranDate" type="date" />
        <select class="w-full border rounded px-3 py-2" id="tranFrom"></select>
        <select class="w-full border rounded px-3 py-2" id="tranTo"></select>
        <input class="w-full border rounded px-3 py-2" id="tranAmt" placeholder="₹" type="number" />
        <textarea class="w-full border rounded px-3 py-2" id="tranNar" placeholder="Narration..." rows="3"></textarea>
        <button class="w-full bg-green-600 text-white px-4 py-2 rounded" onclick="window.saveTran()">💾 Save</button>
      </div>

      <div class="bg-white p-4 sm:p-6 rounded shadow space-y-4" x-show="activeForm === 'ledger'">
        <h2 class="text-lg font-semibold">📒 Ledger Entry</h2>
        <input class="w-full border rounded px-3 py-2" id="ledgerName" placeholder="Ledger Name" type="text" />
        <button class="w-full bg-blue-600 text-white px-4 py-2 rounded" onclick="window.saveLedger()">💾 Save</button>
      </div>
    </div>

    <div id="tableWrapper" class="overflow-x-auto mt-6" style="display:none">
      <table class="min-w-full text-sm border border-gray-300" id="tranTable">
        <thead class="bg-blue-500 text-white">
          <tr>
            <th class="p-2">ID</th>
            <th class="p-2">Date</th>
            <th class="p-2">From</th>
            <th class="p-2">To</th>
            <th class="p-2">Narration</th>
            <th class="p-2">Amount</th>
            <th class="p-2">Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script type="module">
    import {initializeApp} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut}
        from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {getFirestore, collection, getDocs, setDoc, deleteDoc, doc, updateDoc, query, orderBy, limit, addDoc}
        from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    let currentDocId = null;
    let dataTableInstance = null;
    const firebaseConfig = {
        apiKey: "AIzaSyDQWZC6iA5zYKvTXsFl9TYLkZCTl5BzfwA",
        authDomain: "accounts-19d08.firebaseapp.com",
        projectId: "accounts-19d08",
        storageBucket: "accounts-19d08.appspot.com",
        messagingSenderId: "247308606105",
        appId: "1:247308606105:web:9bfc179368524244bf3608"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            console.log("User authenticated.");
            document.getElementById("loginContainer").style.display = "none";
            document.getElementById("registerContainer").style.display = "none";
            document.querySelectorAll("input[type='text']").forEach(input => {
                input.addEventListener("input", (e) => {
                    const cursorPos = input.selectionStart;
                    input.value = capitalizeWords(input.value);
                    input.setSelectionRange(cursorPos, cursorPos);
                });
            });
            await window.loadDropdownData();
            console.log("loadDropdownData completed after auth. Names:", window.names_list);
            if (Alpine.store('activeForm') === 'tran') {
                console.log("Populating dropdowns from onAuthStateChanged (initial check).");
                window.populateDropdown('tranFrom', window.names_list); // CALLING VIA WINDOW
                window.populateDropdown('tranTo', window.names_list); // CALLING VIA WINDOW
            } else {
                console.log("activeForm is not 'tran' yet after auth:", Alpine.store('activeForm'));
            }
        } else {
            console.log("User not authenticated.");
            window.showLogin();
        }
    });
    document.addEventListener('alpine:init', () => {
        Alpine.data('app', () => ({
            open: false,
            activeForm: '',
            init() {
                console.log("Alpine.js app initialized.");
                // Removed the $watch here as x-init on the form will handle population now
            }
        }));
    });
    window.showLogin = function () {
        clearScreen();
        document.getElementById("loginContainer").style.display = "block";
    };
    window.showRegister = function () {
        clearScreen();
        document.getElementById("registerContainer").style.display = "block";
    };
    window.login = async function () {
        const email = document.getElementById("loginEmail").value;
        const password = document.getElementById("loginPassword").value;

        if (!email || !password) {
            return;
        }

        try {
            await signInWithEmailAndPassword(auth, email, password);
        } catch (error) {
            console.error(error);
        }
    };
    window.register = async function () {
        const email = document.getElementById("registerEmail").value;
        const password = document.getElementById("registerPassword").value;

        if (!email || !password) {
            return;
        }

        try {
            await createUserWithEmailAndPassword(auth, email, password);
        } catch (error) {
            console.error(error);
        }
    };
    window.logout = async function () {
        await signOut(auth);
    };
    window.clearScreen = async function () {
        const widgetArea = document.querySelector('.widget-area');
        if (widgetArea) {
            widgetArea.innerHTML = '';
        }
        document.getElementById("tableWrapper").style.display = "none";
        document.getElementById("loginContainer").style.display = "none";
        document.getElementById("registerContainer").style.display = "none";
        currentDocId = null;
    }
    function capitalizeWords(str) {
        return str.replace(/\b\w/g, c => c.toUpperCase());
    }

    function resetForm() {
        const fieldIds = ["tranDate", "tranFrom", "tranTo", "tranAmt", "tranNar", "ledgerName"];
        for (const id of fieldIds) {
            const field = document.getElementById(id);
            if (field) field.value = '';
        }
    }

    window.saveTran = async function () {
        const date = document.getElementById("tranDate").value;
        const from = document.getElementById("tranFrom").value;
        const to = document.getElementById("tranTo").value;
        const amt = document.getElementById("tranAmt").value;
        const nar = document.getElementById("tranNar").value;

        if (!date || !from || !to || !amt) return alert("All fields except narration are required.");
        await addDoc(collection(db, 'hisab'), {date, from, to, amt, nar});
    }

    window.saveLedger = async function () {
        const nameField = document.getElementById("ledgerName");
        const name = nameField?.value?.trim();
        if (!name) return alert("Ledger name is required");
        const tranRef = collection(db, 'hisab');
        const snap = await getDocs(tranRef);
        for (const docSnap of snap.docs) {
            const data = docSnap.data();
            if (data.from === name || data.to === name) {
                alert("Ledger already exists in a transaction");
                return;
            }
        }
        await addDoc(tranRef, {from: name});
        resetForm();
        await window.loadDropdownData();
    };

    window.loadDropdownData = async function () {
        const tranCol = collection(db, "hisab");
        const snapshot = await getDocs(tranCol);
        const namesSet = new Set();
        snapshot.forEach(doc => {
            const data = doc.data();
            if (data.from && data.from.trim().length > 0) {
                namesSet.add(data.from.trim());
            }
            if (data.to && data.to.trim().length > 0) {
                namesSet.add(data.to.trim());
            }
            const name = (data.name || "").trim();
            if (name.length > 0) {
                namesSet.add(name);
            }
        });
        window.names_list = [...namesSet].sort((a, b) => a.localeCompare(b));
    }

    window.populateDropdown = function (selectElementId, dataList) {
        const selectElement = document.getElementById(selectElementId);
        if (!selectElement) {
            return;
        }
        selectElement.innerHTML = '<option value="">Select...</option>';
        dataList.forEach(item => {
            const option = document.createElement('option');
            option.value = item;
            option.textContent = item;
            selectElement.appendChild(option);
        });
    }
</script>
</body>
</html>